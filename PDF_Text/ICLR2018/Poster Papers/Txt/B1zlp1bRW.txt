Published as a conference paper at ICLR 2018
Large-Scale Optimal Transport and Mapping
Estimation
Vivien Seguy	Bharath Bhushan Damodaran
Kyoto University	Universite de Bretagne SUd
Graduate School of Informatics	IRISA, UMR 6074, CNRS
vivien.seguy@iip.ist.i.kyoto-u.ac.jp bharath-bhushan.damodaran@irisa.fr
Remi Flamary
Universite Cote dAzur
Lagrange, UMR 7293, CNRS, OCA
remi.flamary@unice.fr
Antoine Rolet
Kyoto University
Graduate School of Informatics
antoine.rolet@iip.ist.i.kyoto-u.ac.jp
Nicolas Courty
Universite de Bretagne Sud
IRISA, UMR 6074, CNRS
courty@univ-ubs.fr
Mathieu Blondel
NTT Communication Science Laboratories
mathieu@mblondel.org
Ab stract
This paper presents a novel two-step approach for the fundamental problem of
learning an optimal map from one distribution to another. First, we learn an opti-
mal transport (OT) plan, which can be thought as a one-to-many map between the
two distributions. To that end, we propose a stochastic dual approach of regular-
ized OT, and show empirically that it scales better than a recent related approach
when the amount of samples is very large. Second, we estimate a Monge map as
a deep neural network learned by approximating the barycentric projection of the
previously-obtained OT plan. This parameterization allows generalization of the
mapping outside the support of the input measure. We prove two theoretical stabil-
ity results of regularized OT which show that our estimations converge to the OT
plan and Monge map between the underlying continuous measures. We showcase
our proposed approach on two applications: domain adaptation and generative
modeling.
1	Introduction
Mapping one distribution to another Given two random variables X and Y taking values in X
and Y respectively, the problem of finding amap f such that f(X) and Y have the same distribution,
denoted f (X)〜Y henceforth, finds applications in many areas. For instance, in domain adaptation,
given a source dataset and a target dataset with different distributions, the use of a mapping to align
the source and target distributions is a natural formulation (Gopalan et al., 2011) since theory has
shown that generalization depends on the similarity between the two distributions (Ben-David et al.,
2010). Current state-of-the-art methods for computing generative models such as generative adver-
sarial networks (Goodfellow et al., 2014), generative moments matching networks (Li et al., 2015)
or variational auto encoders (Kingma & Welling, 2013) also rely on finding f such that f (X)〜Y.
In this setting, the latent variable X is often chosen as a continuous random variable, such as a
Gaussian distribution, and Y is a discrete distribution of real data, e.g. the ImageNet dataset. By
learning a map f, sampling from the generative model boils down to simply drawing a sample from
X and then applying f to that sample.
Mapping with optimality Among the potentially many maps f verifying f (X)〜Y, it may be of
interest to find a map which satisfies some optimality criterion. Given a cost of moving mass from
one point to another, one would naturally look for a map which minimizes the total cost of trans-
porting the mass from X to Y. This is the original formulation of Monge (1781), which initiated
1
Published as a conference paper at ICLR 2018
the development of the optimal transport (OT) theory. Such optimal maps can be useful in numer-
ous applications such as color transfer (Ferradans et al., 2014), shape matching (Su et al., 2015),
data assimilation (Reich, 2011; 2013), or Bayesian inference (Moselhy & Marzouk, 2012). In small
dimension and for some specific costs, multi-scale approaches (Merigot, 2011) or dynamic formu-
lations (Evans & Gangbo, 1999; Benamou & Brenier, 2000; Papadakis et al., 2014; Solomon et al.,
2014) can be used to compute optimal maps, but these approaches become intractable in higher di-
mension as they are based on space discretization. Furthermore, maps Veryfiying f (X)〜Y might
not exist, for instance when X is a constant but not Y. Still, one would like to find optimal maps be-
tween distributions at least approximately. The modern approach to OT relaxes the Monge problem
by optimizing over plans, i.e. distributions over the product space X × Y, rather than maps, casting
the OT problem as a linear program which is always feasible and easier to solve. However, even with
specialized algorithms such as the network simplex, solving that linear program takes O(n3 log n)
time, where n is the size of the discrete distribution (measure) support.
Large-scale OT Recently, Cuturi (2013) showed that introducing entropic regularization into the
OT problem turns its dual into an easier optimization problem which can be solved using the
Sinkhorn algorithm. However, the Sinkhorn algorithm does not scale well to measures supported
on a large number of samples, since each of its iterations has an O(n2) complexity. In addition, the
Sinkhorn algorithm cannot handle continuous probability measures. To address these issues, two
recent works proposed to optimize variations of the dual OT problem through stochastic gradient
methods. Genevay et al. (2016) proposed to optimize a “semi-dual” objective function. However,
their approach still requires O(n) operations per iteration and hence only scales moderately w.r.t.
the size of the input measures. Arjovsky et al. (2017) proposed a formulation that is specific to the
so-called 1-Wasserstein distance (unregularized OT using the Euclidean distance as a cost function).
This formulation has a simpler dual form with a single variable which can be parameterized as a
neural network. This approach scales better to very large datasets and handles continuous measures,
enabling the use ofOT as a loss for learning a generative model. However, a drawback of that formu-
lation is that the dual variable has to satisfy the non-trivial constraint of being a Lipschitz function.
As a workaround, Arjovsky et al. (2017) proposed to use weight clipping between updates of the
neural network parameters. However, this makes unclear whether the learned generative model is
truly optimized in an OT sense. Besides these limitations, these works only focus on the compu-
tation of the OT objective and do not address the problem of finding an optimal map between two
distributions.
Contributions We present a novel two-step approach for learning an optimal map f that satisfies
f (X)〜 Y. First, We compute an optimal transport plan, which can be thought as a one-to-many
map between the two distributions. To that end, we propose a new simple dual stochastic gradi-
ent algorithm for solving regularized OT which scales well with the size of the input measures.
We provide numerical evidence that our approach converges faster than semi-dual approaches con-
sidered in (Genevay et al., 2016). Second, we learn an optimal map (also referred to as a Monge
map) as a neural network by approximating the barycentric projection of the OT plan obtained in
the first step. Parameterization of this map with a neural network allows efficient learning and
provides generalization outside the support of the input measure. Fig. 1 provides a 2D example
showing the computed map between a Gaussian measure and a discrete measure and the resulting
density estimation. On the theoretical side, we prove the convergence of regularized optimal plans
(resp. barycentric projections of regularized optimal plans) to the optimal plan (resp. Monge map)
between the underlying continuous measures from which data are sampled. We demonstrate our
approach on domain adaptation and generative modeling.
Notations: We denote X and Y some complete metric spaces. In most applications, these are
Euclidean spaces. We denote random variables such as X or Y as capital letters. We use X 〜Y to
say that X and Y have the same distribution, and also X 〜 μ to say that X is distributed according
to the probability measure μ. Supp(μ) refers to the support of μ, a subset of X, which is also the
set of values which X 〜μ can take. Given X 〜μ and a map f defined on Supp(μ), f #仙 is the
probability distribution off(X). We say that a measure is continuous when it admits a density w.r.t.
the Lebesgues measure. We denote id the identity map.
2
Published as a conference paper at ICLR 2018
Figure 1: Example of estimated optimal map between a continuous Gaussian distribution (colored
level sets) and a multi-modal discrete measure (red +). (left) Continuous source and discrete target
distributions. (center left) displacement field of the estimated optimal map: each arrow is propor-
tional to f (Xi) - Xi where (Xi) is a uniform discrete grid. (center right) Generated samples obtained
by sampling from the source distribution and applying our estimated Monge map f. (right) Level
sets of the resulting density (approximated as a 2d histogram over 106 samples).
2	Background on Optimal Transport
The Monge Problem Consider a cost function c : (X, y) ∈ X × Y 7→ c(X, y) ∈ R+, and two
random variables X 〜 μ and Y 〜 V taking values in X and Y respectively. The Monge problem
(Monge, 1781) consists in finding a map f : X → Y which transports the mass from μ to V while
minimizing the mass transportation cost,
inf EX~μ [c(X,f (X))] subject to f(X) ~ Y.	⑴
Monge originally considered the cost c(X, y) = ||X - y||2, but in the present article we refer to the
Monge problem as Problem (1) for any cost c. When μ is a discrete measure, a map f satisfying
the constraint may not exist: if μ is supported on a single point, no such map exists as soon as V is
not supported on a single point. In that case, the Monge problem is not feasible. However, when
X = Y = Rd, μ admits a density and C is the squared Euclidean distance, an important result
by Brenier (1991) states that the Monge problem is feasible and that the infinum of Problem (1)
is attained. The existence and uniqueness of Monge maps, also referred to as optimal maps, was
later generalized to more general costs (e.g. strictly convex and super-linear) by several authors.
With the notable exception of the Gaussian to Gaussian case which has a close form affine solution,
computation of Monge maps remains an open problem for measures supported on high-dimensional
spaces.
Kantorovich Relaxation In order to make Problem (1) always feasible, Kantorovich (1942) relaxed
the Monge problem by casting Problem (1) into a minimization over couplings (X, Y) ~ π rather
than the set of maps, where ∏ should have marginals equals to μ and V,
inf E(χ,γ)~∏ [c(X, Y)] subject to X ~ μ, Y ~ ν.	(2)
Concretely, this relaxation allows mass at a given point X ∈ Supp(μ) to be transported to several
locations y ∈ Supp(V), while the Monge problem would send the whole mass at X to a unique
location f (X). This relaxed formulation is a linear program, which can be solved by specialized
algorithms such as the network simplex when considering discrete measures. However, current
implementations of this algorithm have a super-cubic complexity in the size of the support of μ and
V, preventing wider use of oT in large-scale settings.
Regularized OT oT regularization was introduced by Cuturi (2013) in order to speed up the com-
putation of oT. Regularization is achieved by adding a negative-entropy penalty R (defined in Eq.
(5)) to the primal variable π of Problem (2),
inf E(χ,γ)~∏ [c(X,Y)] + εR(π) subject to X ~ μ, Y ~ ν.	(3)
Besides efficient computation through the Sinkhorn algorithm, regularization also makes the oT
distance differentiable everywhere w.r.t. the weights of the input measures (Blondel et al., 2018),
whereas oT is differentiable only almost everywhere. We also consider the L2 regularization in-
troduced by Dessein et al. (2016), whose computation is found to be more stable since there is no
3
Published as a conference paper at ICLR 2018
exponential term causing overflow. As highlighted by Blondel et al. (2018), adding an entropy or
squared L2 norm regularization term to the primal problem (3) makes the dual problem an uncon-
strained maximization problem. We use this dual formulation in the next section to propose an
efficient stochastic gradient algorithm.
3	Large-Scale Optimal Transport
By considering the dual of the regularized OT problem, we first show that stochastic gradient ascent
can be used to maximize the resulting concave objective. A close form for the primal solution π of
Problem (3) can then be obtained by using first-order optimality conditions.
3.1	Dual stochastic approach
OT dual Let X 〜 μ and Y 〜 ν. The Kantorovich duality provides the following dual of the OT
problem (2),
SUP	E(XY)〜μ×ν [u(X) + V(Y)]	subject to u(χ) + v(y) 6 c(χ,y) for all (χ,y). (4)
u∈C(X),v∈C(Y)	,
This dual formulation suggests that stochastic gradient methods can be used to maximize the objec-
tive of Problem (4) by sampling batches from the independant coupling μ X ν. However there is no
easy way to fulfill the constraint on u and v along gradient iterations. This motivates considering
regularized optimal transport.
Regularized OT dual The hard constraint in Eq. (4) can be relaxed by regularizing the primal
problem (2) with a strictly convex regularizer R as detailed in (Blondel et al., 2018). In the present
paper, we consider both entropy regularization Re used in (Cuturi, 2013; Genevay et al., 2016) and
L2 regularization RL2,
def.	dπ(x, y)	def.	dπ(x, y)	2
Re ⑺=J In (dμ(x)dν(yj - 1) dπ(x,y), RL2(n)= J Q〃(x)dν (y)) d〃(x)dv(y).
X×Y	X×Y
(5)
where 壮二*脸)is the density, i.e. the Radon-Nikodym derivative, of π w.r.t. μ × ν. When μ and V
are discrete, and so is π, the integrals are replaced by sums. The dual of the regularized OT problems
can be obtained through the Fenchel-Rockafellar’s duality theorem,
sup E(X,Y)〜μ×ν [u(X) + V(Y) + Fε(u(X), V(Y))],
u,v
)—εeε(U(X)+v(y)-C(X,y))	(entroπv res> )
-ɪ(u(x) + v(y) - c(x,y))+ (Lyregg))
(6)
(7)
Compared to Problem (4), the constraint u(x) + V(y) 6 c(x, y) has been relaxed and is now en-
forced smoothly through a penalty term Fε(u(x), V(y)) which is concave w.r.t. (u, V). Although we
derive formula and perform experiments w.r.t. entropy and L2 regularizations, any strictly convex
regularizer which is decomposable, i.e. which can be written R(π) = Pij Rij (πij) (in the discrete
case), gives rise to a dual problem of the form Eq. (6), and the proposed algorithms can be adapted.
Primal-Dual relationship In order to recover the solution πε of the regularized primal problem (3),
we can use the first-order optimality conditions of the Fenchel-Rockafellar’s duality theorem,
(
dπε(x,y) = Hε(x, y)dμ(x)dν(y) where Hε(x, y)
U(X) _ Zxm V(U)	/	.
ee e(entropy reg.)
21ε (U(X) + v(y) - c(x, y))+ (L2 reg.)
(8)
Algorithm The relaxed dual (6) is an unconstrained concave problem which can be maximized
through stochastic gradient methods by sampling batches from μ × V. When μ is discrete, i.e.
μ = Pn= ι aiδχi, the dual variable U isa n-dimensional vector over which We carry the optimization,
where U(Xi) =. Ui. When μ has a density, U is a function on X which has to be parameterized in
order to carry optimization. We thus consider deep neural networks for their ability to approximate
4
Published as a conference paper at ICLR 2018
Algorithm 1 Stochastic OT computation
1:	Inputs: input measures μ, V; cost function c; batch size p; learning rate Y.
2:	Discrete case: μ = Pi aiδχi and U is a finite vector: u(xi) = Ui (similarly for V and V)
3:	Continuous case: μ is a continuous measure and U is a neural network (similarly for V and v)
V indicates the gradient w.r.t. the parameters
4:	while not converged do
5:	sample a batch (xι,…，Xp) from μ
6:	sample a batch (yι,…，yp) from V
7:	update u — U + Y Pij VU(Xi) + ∂uFε(u(x/, v(y7-))Vu(xi)
8:	update V — V + YPij Vv(yj) + ∂vFε(U(χi), My ))Vv(yj)
9:	end while
general functions. Genevay et al. (2016) used the same stochastic dual maximization approach to
compute the regularized OT objective in the continuous-continuous setting. The difference lies in
their pamaterization of the dual variables as kernel expansions, while we decide to use deep neural
networks. Using a neural network for parameterizing a continuous dual variable was done also
by Arjovsky et al. (2017). The same discussion also stands for the second dual variable V . Our
stochastic gradient algorithm is detailed in Alg. 1.
Convergence rates and computational cost comparison. We first discuss convergence rates in
the discrete-discrete setting (i.e. both measures are discrete), where the problem is convex, while
parameterization of dual variables as neural networks in the semi-discrete or continuous-continuous
settings make the problem non-convex. Because the dual (6) is not strongly convex, full-gradient
descent converges at a rate of O(1/k), where k is the iteration number. SGD with a decreasing
step size converges at the inferior rate of O(1/√k) (Nemirovski et al., 2009), but with a O(1) cost
per iteration. The two rates can be interpolated when using mini-batches, at the cost of O(p2) per
iteration, where p is the mini-batch size. In contrast, Genevay et al. (2016) considered a semi-dual
objective of the form Eχ~* [u(X) + Ge(u(X))], with a cost per iteration which is now O(n) due
to the computation of the gradient of Gε. Because that objective is not strongly convex either, SGD
converges at the same O(1/√k) rate, up to problem-specific constants. As noted by Genevay et al.
(2016), this rate can be improved to O(1/k) while maintaining the same iteration cost, by using
stochastic average gradient (SAG) method (Schmidt et al., 2017). However, SAG requires to store
past stochastic gradients, which can be problematic in a large-scale setting.
In the semi-discrete setting (i.e. one measure is discrete and the other is continuous), SGD on the
semi-dual objective proposed by Genevay et al. (2016) also converges at a rate of O(1∕√k), whereas
we only know that Alg. 1 converges to a stationary point in this non-convex case.
In the continuous-continuous setting (i.e. both measures are continuous), Genevay et al. (2016)
proposed to represent the dual variables as kernel expansions. A disadvantage of their approach,
however, is the O(k2) cost per iteration. In contrast, our approach represents dual variables as
neural networks. While non-convex, our approach preserves a O(p2) cost per iteration. This pa-
rameterization with neural networks was also used by Arjovsky et al. (2017) who maximized the
1-Wasserstein dual-objective function E(χ,γ)~*×ν [u(X) 一 U(Y)]. Their algorithm is hence very
similar to ours, with the same complexity O(p2) per iteration. The main difference is that they
had to constrain U to be a Lipschitz function and hence relied of weight clipping in-between gra-
dient updates. The proposed algorithm is capable of computing the regularized OT objective and
optimal plans between empirical measures supported on arbitrary large numbers of samples. In sta-
tistical machine learning, one aims at estimating the underlying continuous distribution from which
empirical observations have been sampled. In the context of optimal transport, one would like to
approximate the true (non-regularized) optimal plan between the underlying measures. The next
section states theoretical guarantees regarding this problem.
3.2	Convergence of regularized OT plans
Consider discrete probability measures μn = £二 a%δχi ∈ P(X) and Vn = P；=i bjδyj ∈ P(Y).
Analysis of entropy-regularized linear programs (Cominetti & San Martin, 1994) shows that the
5
Published as a conference paper at ICLR 2018
solution πnε of the entropy-regularized problem (3) converges exponentially fast to a solution πn
of the non-regularized OT problem (2). Also, a result about stability of optimal transport (Villani,
2008)[Theorem 5.20] states that, if μn → μ and Vn → V weakly, then a sequence (∏n) of optimal
transport plans between μn and Vn converges weakly to a solution ∏ of the OT problem between μ
and V . We can thus write,
lim lim πnε = π.	(9)
n→∞ ε→0
A more refined result consists in establishing the weak convergence of πnε to π when (n, ε) jointly
converge to (∞, 0). This is the result of the following theorem which states a stability property of
entropy-regularized plans (proof in the Appendix).
Theorem 1. Let μ ∈ P(X) and V ∈ P(Y) where X and Y are complete metric spaces. Let
μn = En=I αiδχi and Vn = En=I b δyj be discrete probability measures which converge weakly
to μ and V respectively, and let (εnj a SequenCe of non-negative real numbers converging to 0
sufficiently fast. Assume the cost c is continuous on X × Y and finite. Let πnεn the solution of the
entropy-regularized OT problem (3) between μn and Vn. Then, up to extraction of a subsequence,
(∏nn) converges weakly to the solution π of the OT problem (2) between μ and V,
πnεn → π weakly.	(10)
Keeping the analogy with statistical machine learning, this result is an analog to the universal con-
sistency property of a learning method. In most applications, we consider empirical measures and
n is fixed, so that regularization, besides enabling dual stochastic approach, may also help learn the
optimal plan between the underlying continuous measures.
So far, we have derived an algorithm for computing the regularized OT objective and regularized
optimal plans regardless of μ and V being discrete or continuous. The OT objective has been used
successfully as a loss in machine learning (Montavon et al., 2015; Frogner et al., 2015; Rolet et al.,
2016; 2018; Arjovsky et al., 2017; Courty et al., 2017a), whereas the use of optimal plans has
straightforward applications in logistics, as well as economy (Kantorovich, 1942; Carlier, 2012) or
computer graphics (Bonneel et al., 2011). In numerous applications however, we often need map-
pings rather than joint distributions. This is all the more motivated since Brenier (1991) proved that
when the source measure is continuous, the optimal transport plan is actually induced by a map.
Assuming that available data samples are sampled from some underlying continuous distributions,
finding the Monge map between these continuous measures rather than a discrete optimal plan be-
tween discrete measures is essential in machine learning applications. Hence in the next section, we
investigate how to recover an optimal map, i.e. find an approximate solution to the Monge problem
(1), from regularized optimal plans.
4	Optimal Mapping Estimations
A map can be obtained from a solution to the OT problem (2) or regularized OT problem (3) through
the computation of its barycentric projection. Indeed, a solution π of Problem (2) or (3) between a
source measure μ and a target measure V is, identifying the plan ∏ with its density w.r.t. a reference
measure, a function π : (x, y) ∈ X × Y 7→ R+ which can be seen as a weighted one-to-many map,
i.e. π sends x to each location y ∈ Supp(V) where π(x, y) > 0. A map can then be obtained by
simply averaging over these y according to the weights π(x, y).
Definition 1. (Barycentric projection) Let π be a solution of the OT problem (2) or regularized OT
problem (3). The barycentric projection π w.r.t. a COnVex cost d : Y ×Y → R+ is defined as,
∏(x) = argmin EY〜∏(∙∣χ) [d(z, Y)].	(11)
z
In the special case d(x, y) = Ilx - y∣2, Eq. (11) has the close form solution π(x) = EY〜∏(∙∣χ) [Y],
which is equal to π = πy- in a discrete setting with y = (yι, ∙∙∙ ,yn) and a the weights of μ.
Moreover, for the specific squared Euclidean cost c(x, y) = Ilx - y∣∣2, the barycentric projection ∏ is
an optimal map (Ambrosio et al., 2006)[Theorem 12.4.4], i.e. ∏ is a solution to the Monge problem
(1) between the source measure μ and the target measure 亓#仙.Hence the barycentric projection
w.r.t. the squared Euclidean cost is often used as a simple way to recover optimal maps from optimal
transport plans (Reich, 2013; Wang et al., 2013; Ferradans et al., 2014; Seguy & Cuturi, 2015).
6
Published as a conference paper at ICLR 2018
Algorithm 2 Optimal map learning with SGD
Inputs: input measures μ, ν; cost function c; dual optimal variables U and v; map fθ parame-
terized as a deep NN; batch size n; learning rate γ.
while not converged do
sample a batch (xi, .…，Xn) from μ
sample a batch (yι,…，yn from V
update θ — θ - YPij Hε(χi,yj)▽&d(y ,fθ(Xi))
end while
Formula (11) provides a pointwise value of the barycentric projection. When μ is discrete, this
means that we only have mapping estimations for a finite number of points. In order to define a map
which is defined everywhere, we parameterize the barycentric projection as a deep neural network.
We show in the next paragraph how to efficiently learn its parameters.
Optimal map learning An estimation f of the barycentric projection of a regularized plan πε
which generalizes outside the SuPPor of μ can be obtained by learning a deep neural network which
minimizes the following objective w.r.t. the parameters θ,
EX 〜μ [Eγ 〜∏ε(∙∣χ) [d(Y,fθ (X ))]]= E(X,Y)〜πε [d(Y, fθ(X))]
=E(X,Y)〜μ×ν [d(Y,fθ(X))Hε(X,Y)].
(12)
When d(X, y) = ||X - y||2, the last term in Eq. (12) is simply a weighted sum of squared errors,
with possibly an infinite number of terms whenever μ or V are continuous. We propose to minimize
the objective (12) by stochastic gradient descent, which provides the simple Algorithm 2. The OT
problem being symmetric, we can also compute the opposite barycentric projection g w.r.t. a cost
d : X×X→ R+ by minimizing E(χ,γ)〜μ×ν [d(g(Y ),X )Hε(X,Y)].
However, unless the plan π is induced by a map, the averaging process results in having the image
of the source measure by ∏ only approximately equal to the target measure V. Still, when the
size of discrete measure is large and the regularization is small, we show in the next paragraph
that 1) the barycentric projection of a regularized OT plan is close to the Monge map between
the underlying continuous measures (Theorem 2) and 2) the image of the source measure by this
barycentric projection should be close to the target measure V (Corollary 1).
Theoretical guarantees As stated earlier, when X = Y and c(X, y) = ||X - y||22, Brenier (1991)
proved that when the source measure μ is continuous, there exists a solution to the Monge problem
(1). This result was generalized to more general cost functions, see (Villani, 2008)[Corollary 9.3] for
details. In that case, the plan ∏ between μ and V is written as (id, f )#仙 where f is the Monge map.
Now considering discrete measures μn and Vn which converge to μ (continuous) and V respectively,
we have proved in Theorem 1 that ∏n converges weakly to ∏ = (id, f )#仙 when (n, ε) → (∞, 0).
The next theorem, proved in the Appendix, shows that the barycentric projection ∏n also converges
weakly to the true Monge map between μ and v, justifying our approach.
Theorem 2. Let μ be a continuous probability measure on Rd, and V an arbitrary probability
measure on Rd and C a CoStfunction satisfying (Villani, 2008)[Corollary 9.3]. Let μn = ɪ En=I δχi
and Vn = 1 En=I δyj converging weakly to μ and V respectively. Assume that the OT solution πn
of Problem (2) between μn and Vn is unique for all n. Let (εQ a sequence of non-negative real
numbers converging sufficiently fast to 0 and πnn the barycentric projection w.r.t. the convex cost
d = c of the solution πnεn of the entropy-regularized OT problem (3). Then, up to extraction ofa
subsequence,
(id,∏nn )#Mn → (id, f )#M weakly,	(13)
where f is the solution ofthe Monge problem (1) between μ and V.
This theorem shows that our estimated barycentric projection is close to an optimal map between the
underlying continuous measures for n big andε small. The following corollary confirms the intuition
that the image of the source measure by this map converges to the underlying target measure.
Corollary 1. With the same assumptions as above, πnn #@n → V weakly.
In terms of random variables, the last equation states that if Xn 〜μn and Y 〜V, then ∏nn (Xn)
converges in distribution to Y.
7
Published as a conference paper at ICLR 2018
£ = 2.5-10-2
time (seconds)
£ = 10T
time (seconds)
time (seconds)
Figure 2: Convergence plots of the the Stochastic Dual Algorithm 1 against a stochastic semi-dual
implementation (adapted from (Genevay et al., 2016): we use SGD instead of SAG), for several
entropy-regularization values. Learning rates are {5., 20., 20.} and batch sizes {1024, 500, 100}
respectively and are taken the same for the dual and semi-dual methods.
These theoretical results show that our estimated Monge map can thus be used to perform domain
adaptation by mapping a source dataset to a target dataset, as well as perform generative modeling
by mapping a continuous measure to a target discrete dataset. We demontrate this in the following
section.
5	Numerical Experiments
5.1	Dual vs Semi-Dual speed comparisons
We start by evaluating the training time of our dual stochastic algorithm 1 against a stochastic semi-
dual approach similar to (Genevay et al., 2016). In the semi-dual approach, one of the dual variable
is eliminated and is computed in close form. However, this computation has O(n) complexity
where n is the size of the target measure ν . We compute the regularized OT objective with both
methods on a spectral transfer problem, which is related to the color transfer problem (Reinhard
et al., 2001; Pitie et al., 2007), but where images are multisPectral, i.e. they share a finer sampling of
the light wavelength. We take two 500 × 500 images from the CAVE dataset (Yasuma et al., 2010)
that have 31 spectral bands. As such, the optimal transport problem is computed on two empirical
distributions of 250000 samples in R31 on which we consider the squared Euclidean ground cost c.
The timing evolution of train losses are reported in Figure 2 for three different regularization values
ε = {0.025, 0.1, 1.}. In the three cases, one can observe that convergence of our proposed dual
algorithm is much faster.
5.2	Large scale domain adaptation
We apply here our computation framework on an unsupervised domain adaptation (DA) task, for
which optimal transport has shown to perform well on small scale datasets (Courty et al., 2017b;
Perrot et al., 2016; Courty et al., 2014). This restriction is mainly due to the fact that those works
only consider the primal formulation of the OT problem. Our goal here is not to compete with
the state-of-the-art methods in domain adaptation but to assess that our formulation allows to scale
optimal transport based domain adaptation (OTDA) to large datasets. OTDA is illustrated in Fig. 3
and follows two steps: 1) learn an optimal map between the source and target distribution, 2) map
the source samples and train a classifier on them in the target domain. Our formulation also allows
to use any differentiable ground cost c while (Courty et al., 2017b) was limited to the squared
Euclidean distance.
Datasets We consider the three cross-domain digit image datasets MNIST (Lecun et al., 1998),
USPS, and SVHN (Netzer et al., 2011), which have 10 classes each. For the adaptation between
MNIST and USPS, we use 60000 samples in the MNIST domain and 9298 samples in USPS domain.
MNIST images are resized to the same resolution as USPS ones (16 × 16). For the adaptation
between SVHN and MNIST, we use 73212 samples in the SVHN domain and 60000 samples in the
MNIST domain. MNIST images are zero-padded to reach the same resolution as SVHN (32 × 32)
and extended to three channels to match SVHN image sizes. The labels in the target domain are
8
Published as a conference paper at ICLR 2018
Figure 3: Illustration of the OT Domain Adaptation method adapted from (Courty et al., 2017b).
Source samples are mapped to the target set through the barycentric projection ∏ε. A classifier is
then learned on the mapped source samples.
Table 1: Results (accuracy in %) on domain adaptation among MNIST, USPS and SVHN datasets
with entropy (Re) and L2 (RL2) regularizations. Source only refers to 1-NN classification between
source and target samples without adaptation.
Method	MNIST→ USPS	USPS→ MNIST	SVHN → MNIST
Source only	73.47	3697	54:33
Bar. proj. OT	57.75	52.46	intractable
Bar. proj. OT with Re	68.75	57.35	intractable
Bar. proj. Alg. 1 with Re	68.84	57.55	58.87
Bar. proj. Alg. 1 with Rl2	67.8	57.47	60.56
Monge map Alg. 1+2 with Re	77.92	60.02	61.11
Monge map Alg. 1+2 with Rl2	72.61	60.50	62.88
withheld during the adaptation. In the experiment, we consider the adaptation in three directions:
MNIST → USPS, USPS → MNIST, and SVHN → MNIST.
Methods and experimental setup Our goal is to demonstrate the potential of the proposed method
in large-scale settings. Adaptation performance is evaluated using a 1-nearest neighbor (1-NN) clas-
sifier, since it has the advantage of being parameter free and allows better assessment of the quality
of the adapted representation, as discussed in (Courty et al., 2017b). In all experiments, we consider
the 1-NN classification as a baseline, where labeled neighbors are searched in the source domain
and the accuracy is computed on target data. We compare our approach to previous OTDA methods
where an optimal map is obtained through the discrete barycentric projection of either an optimal
plan (computed with the network simplex algorithm1) or an entropy-regularized optimal plan (com-
puted with the Sinkhorn algorithm (Cuturi, 2013)), whenever their computation is tractable. Note
that these methods do not provide out-of-sample mapping. In all experiments, the ground cost c is
the squared Euclidean distance and the barycentric projection is computed w.r.t. that cost. We learn
the Monge map of our proposed approach with either entropy or L2 regularizations. Regarding the
adaptation between SVHN and MNIST, we extract deep features by learning a modified LeNet ar-
chitecture on the source data and extracting the 100-dimensional features output by the top hidden
layer. Adaptation is performed on those features. We report for all the methods the best accuracy
over the hyperparameters on the target dataset. While this setting is unrealistic in a practical DA
application, it is widely used in the DA community (Long et al., 2013) and our goal is here to
investigate the relative performances of large-scale OTDA in a fair setting.
Hyper-parameters and learning rate The value for the regularization parameter is set in
{5, 2, 0.9, 0.5, 0.1, 0.05, 0.01}. Adam optimizer with batch size 1000 is used to optimize the
network. The learning rate is varied in {2, 0.9, 0.1, 0.01, 0.001, 0.0001}. The learned Monge
map f in Alg. 2 is parameterized as a neural network with two fully-connected hidden layers
(d → 200 → 500 → d) and ReLU activations, and the weights are optimized using the Adam
optimizer with learning rate equal to 10-4 and batch size equal to 1000. For the Sinkhorn algo-
rithm, regularization value is chosen from {0.01, 0.1, 0.5, 0.9, 2.0, 5.0, 10.0}.
1http://liris.cnrs.fr/~nbonneel/FastTransport/
9
Published as a conference paper at ICLR 2018
Results Results are reported in Table 1. In all cases, our proposed approach outperforms previous
OTDA algorithms. On MNIST→USPS, previous OTDA methods perform worse than using directly
source labels, whereas our method leads to successful adaptation results with 20% and 10% accuracy
points over OT and regularized OT methods respectively. On USPS→MNIST, all three algorithms
lead to successful adaptation results, but our method achieves the highest adaptation results. Finally,
on the challenging large-scale adaptation task SVHN→MNIST, only our method is able to handle
the whole datasets, and outperforms the source only results.
Comparing the results between the barycentric projection and estimated Monge map illustrates that
learning a parametric mapping provides some kind of regularization, and improves the performance.
5.3	Generative Optimal Transport (GOT)
Approach Corollary 1 shows that when the support of the discrete measures μ and V is large and
the regularization ε is small, then we have approximately 亓*#仙 = V. This observation motivates
the use of our Monge map estimation as a generator between an arbitrary continuous measure μ and
a discrete measure V representing the discrete distribution of some dataset. We can thus obtain a
generative model by first computing regularized OT through Alg. 1 between a Gaussian measure μ
and a discrete dataset V and then compute our generator with Alg. 2. This requires to have a cost
function between the latent variable X 〜μ and the discrete variable Y 〜V. The property we gain
compared to other generative models is that our generator is, at least approximately, an optimal map
w.r.t. this cost. In our case, the Gaussian is taken with the same dimensionality as the discrete data
and the squared Euclidean distance is used as ground cost c.
Permutation-invariant MNIST We preprocess MNIST data by rescaling grayscale values in
[-1,1]. We run Alg. 1 and Alg. 2 where μ is a Gaussian whose mean and covariance are taken equal
to the empirical mean and covariance of the preprocessed MNIST dataset; we have observed that
this makes the learning easier. The target discrete measure V is the preprocessed MNIST dataset.
Permutation invariance means that we consider each grayscale 28 × 28 images as a 784-dimensional
vector and do not rely on convolutional architectures. In Alg. 1 the dual potential u is parameterized
as a (d → 1024 → 1024 → 1) fully-connected NN with ReLU activations for each hidden layer,
and the L2 regularization is considered as it produced experimentally less blurring. The barycentric
projection f of Alg. 2 is parameterized as a (d → 1024 → 1024 → d) fully-connected NN with
ReLU activation for each hidden layer and a tanh activation on the output layer. We display some
generated samples in Fig. 4.
6	Conclusion
We proposed two original algorithms that allow for i) large-scale computation of regularized opti-
mal transport ii) learning an optimal map that moves one probability distribution onto another (the
so-called Monge map). To our knowledge, our approach introduces the first tractable algorithms
for computing both the regularized OT objective and optimal maps in large-scale or continuous set-
tings. We believe that these two contributions enable a wider use of optimal transport strategies
in machine learning applications. Notably, we have shown how it can be used in an unsupervised
10
Published as a conference paper at ICLR 2018
domain adaptation setting, or in generative modeling, where a Monge map acts directly as a gener-
ator. Our consistency results show that our approach is theoretically well-grounded. An interesting
direction for future work is to investigate the corresponding convergence rates of the empirical reg-
ularized optimal plans. We believe this is a very complex problem since technical proofs regarding
convergence rates of the empirical OT objective used e.g. in (Sriperumbudur et al., 2012; Boissard
et al., 2014; Fournier & Guillin, 2015) do not extend simply to the optimal transport plans.
Acknowledgments
This work benefited from the support of the project OATMIL ANR-17-CE23-0012 of the French
National Research Agency (ANR). We thank the anonymous reviewers and Arthur Mensh for the
careful reading and helpful comments regarding the present article.
References
LUigi Ambrosio, Nicola Gigli, and GiUsePPe Savare. Gradient flows: in metric spaces and in the
space of probability measures. Springer, 2006.
Martin Arjovsky, Soumith Chintala, and Leon Bottou. Wasserstein generative adversarial networks.
In International Conference on Machine Learning, pp. 214-223, 2017.
Shai Ben-David, John Blitzer, Koby Crammer, Alex Kulesza, Fernando Pereira, and Jennifer Wort-
man Vaughan. A theory of learning from different domains. Machine learning, 79(1):151-175,
2010.
Jean-David Benamou and Yann Brenier. A computational fluid mechanics solution to the monge-
kantorovich mass transfer problem. Numerische Mathematik, 84(3):375-393, 2000.
Garrett Birkhoff. Three observations on linear algebra. Univ. Nac. Tucuman. Revista A, 5:147-151,
1946.
Mathieu Blondel, Vivien Seguy, and Antoine Rolet. Smooth and sparse optimal transport. In Proc.
of AISTATS, 2018.
Emmanuel Boissard, Thibaut Le Gouic, et al. On the mean speed of convergence of empirical and
occupation measures in wasserstein distance. In Annales de l,Institut Henri Poincare, Probabilites
et Statistiques, volume 50, pp. 539-563. Institut Henri Poincare, 2014.
Nicolas Bonneel, Michiel Van De Panne, Sylvain Paris, and Wolfgang Heidrich. Displacement inter-
polation using lagrangian mass transport. In ACM Transactions on Graphics (TOG), volume 30,
pp. 158. ACM, 2011.
Yann Brenier. Polar factorization and monotone rearrangement of vector-valued functions. Commu-
nications on pure and applied mathematics, 44(4):375-417, 1991.
Guillaume Carlier. Optimal transportation and economic applications. Lecture Notes.(Cited on page
2.), 2012.
Roberto Cominetti and Jaime San Martin. Asymptotic analysis of the exponential penalty trajectory
in linear programming. Mathematical Programming, 67(1-3):169-187, 1994.
Nicolas Courty, Remi Flamary, and Devis Tuia. Domain adaptation with regularized optimal
transport. In Joint European Conference on Machine Learning and Knowledge Discovery in
Databases, pp. 274-289. Springer, 2014.
Nicolas Courty, Remi Flamary, Amaury Habrard, and Alain Rakotomamonjy. Joint distribution
optimal transportation for domain adaptation. arXiv preprint arXiv:1705.08848, 2017a.
Nicolas Courty, Remi Flamary, Devis Tuia, and Alain Rakotomamonjy. Optimal Transport for
Domain Adaptation. IEEE Transactions on Pattern Analysis and Machine Intelligence, 39(9):
1853-1865, sep 2017b.
11
Published as a conference paper at ICLR 2018
Marco Cuturi. Sinkhorn distances: Lightspeed computation of optimal transport. In Advances in
Neural Information Processing Systems,pp. 2292-2300, 2013.
Arnaud Dessein, Nicolas Papadakis, and Jean-Luc Rouas. Regularized optimal transport and the rot
mover’s distance. arXiv preprint arXiv:1610.06447, 2016.
Lawrence C Evans and Wilfrid Gangbo. Differential equations methods for the Monge-Kantorovich
mass transfer problem, volume 653. American Mathematical Soc., 1999.
Sira Ferradans, Nicolas Papadakis, Gabriel Peyre, and Jean-Francois AUjoL Regularized discrete
optimal transport. SIAM Journal on Imaging Sciences, 7(3):1853-1882, 2014.
Nicolas Fournier and Arnaud Guillin. On the rate of convergence in wasserstein distance of the
empirical measure. Probability Theory and Related Fields, 162(3-4):707-738, 2015.
Charlie Frogner, Chiyuan Zhang, Hossein Mobahi, Mauricio Araya, and Tomaso A Poggio. Learn-
ing with a wasserstein loss. In Advances in Neural Information Processing Systems, pp. 2053-
2061, 2015.
Aude Genevay, Marco Cuturi, Gabriel Peyre, and Francis Bach. Stochastic optimization for large-
scale optimal transport. In Advances in Neural Information Processing Systems, pp. 3432-3440,
2016.
Ian Goodfellow, Jean Pouget-Abadie, Mehdi Mirza, Bing Xu, David Warde-Farley, Sherjil Ozair,
Aaron Courville, and Yoshua Bengio. Generative adversarial nets. In Z. Ghahramani, M. Welling,
C. Cortes, N. D. Lawrence, and K. Q. Weinberger (eds.), Advances in Neural Information Pro-
cessing Systems 27, pp. 2672-2680. Curran Associates, Inc., 2014.
Raghuraman Gopalan, Ruonan Li, and Rama Chellappa. Domain adaptation for object recognition:
An unsupervised approach. In Computer Vision (ICCV), 2011 IEEE International Conference on,
pp. 999-1006. IEEE, 2011.
Leonid Vitalievich Kantorovich. On the translocation of masses. In Dokl. Akad. Nauk SSSR, vol-
ume 37, pp. 199-201, 1942.
Diederik P Kingma and Max Welling. Auto-encoding variational bayes. arXiv preprint
arXiv:1312.6114, 2013.
Y. Lecun, L. Bottou, Y. Bengio, and P. Haffner. Gradient-based learning applied to document
recognition. Proceedings of the IEEE, 86(11):2278-2324, 1998. ISSN 00189219. doi:
10.1109/5.726791.
Yujia Li, Kevin Swersky, and Rich Zemel. Generative moment matching networks. In Proceedings
of the 32nd International Conference on Machine Learning (ICML-15), pp. 1718-1727, 2015.
Mingsheng Long, Jianmin Wang, Guiguang Ding, Jiaguang Sun, and Philip S Yu. Transfer feature
learning with joint distribution adaptation. In Proceedings of the IEEE international conference
on computer vision, pp. 2200-2207, 2013.
Quentin Merigot. A multiscale approach to optimal transport. In Computer Graphics Forum, vol-
ume 30, pp. 1583-1592. Wiley Online Library, 2011.
G. Monge. Memoire sur la theorie des deblais et des remblais. HiStoire de l,Academie Royale des
Sciences de Paris, 1781.
Gregoire Montavon, Klaus-Robert Muller, and Marco Cuturi. Wasserstein training of boltzmann
machines. arXiv preprint arXiv:1507.01972, 2015.
Tarek A. El Moselhy and Youssef M. Marzouk. Bayesian inference with optimal maps. Jour-
nal of Computational Physics, 231(23):7815 - 7850, 2012. ISSN 0021-9991. doi: https://
doi.org/10.1016/j.jcp.2012.07.022. URL http://www.sciencedirect.com/science/
article/pii/S0021999112003956.
12
Published as a conference paper at ICLR 2018
Arkadi Nemirovski, Anatoli Juditsky, Guanghui Lan, and Alexander Shapiro. Robust stochastic
approximation approach to stochastic programming. SIAMJournal on optimization, 19(4):1574-
1609, 2009.
Yuval Netzer, Tao Wang, Adam Coates, Alessandro Bissacco, Bo Wu, and Andrew Y. Ng. Read-
ing Digits in Natural Images with Unsupervised Feature Learning. In NIPS Workshop on Deep
Learning and Unsupervised Feature Learning 2011, 2011.
Nicolas Papadakis, Gabriel Peyre, and Edouard Oudet. Optimal transport with proximal splitting.
SIAM Journal on Imaging Sciences, 7(1):212-238, 2014.
Michael Perrot, Nicolas Courty, Remi Flamary, and Amaury Habrard. Mapping Estimation for Dis-
crete Optimal Transport. In Neural Information Processing System, Barcelone, Spain, December
2016.
FranCOiS Pitie, Anil C Kokaram, and Rozenn Dahyot. Automated colour grading using colour dis-
tribution transfer. Computer Vision and Image Understanding, 107(1):123-137, 2007.
Sebastian Reich. A dynamical systems framework for intermittent data assimilation. BIT Numerical
Mathematics, 51(1):235-249, 2011.
Sebastian Reich. A nonparametric ensemble transform method for bayesian inference. SIAM Journal
on Scientific Computing, 35(4):A2013-A2024, 2013.
Erik Reinhard, Michael Adhikhmin, Bruce Gooch, and Peter Shirley. Color transfer between images.
IEEE Computer graphics and applications, 21(5):34-41, 2001.
Antoine Rolet, Marco Cuturi, and Gabriel Peyre. Fast dictionary learning with a smoothed wasser-
stein loss. In Proceedings of the 19th International Conference on Artificial Intelligence and
Statistics, pp. 630-638, 2016.
Antoine Rolet, Vivien Seguy, Mathieu Blondel, and Hiroshi Sawada. Blind source separation with
optimal transport non-negative matrix factorization. arXiv preprint arXiv:1802.05429, 2018.
Mark Schmidt, Nicolas Le Roux, and Francis Bach. Minimizing finite sums with the stochastic
average gradient. Mathematical Programming, 162(1-2):83-112, 2017.
Vivien Seguy and Marco Cuturi. Principal geodesic analysis for probability measures under the
optimal transport metric. In Advances in Neural Information Processing Systems, pp. 3312-3320,
2015.
Justin Solomon, Raif Rustamov, Leonidas Guibas, and Adrian Butscher. Earth mover’s distances on
discrete surfaces. ACM Transactions on Graphics (TOG), 33(4):67, 2014.
Bharath K Sriperumbudur, Kenji Fukumizu, Arthur Gretton, Bernhard Scholkopf, Gert RG Lanck-
riet, et al. On the empirical estimation of integral probability metrics. Electronic Journal of
Statistics, 6:1550-1599, 2012.
Zhengyu Su, Yalin Wang, Rui Shi, Wei Zeng, Jian Sun, Feng Luo, and Xianfeng Gu. Optimal mass
transport for shape matching and comparison. IEEE transactions on pattern analysis and machine
intelligence, 37(11):2246-2259, 2015.
Cedric Villani. Optimal transport: old and new, volume 338. Springer, 2008.
Wei Wang, Dejan Slepcev, Saurav Basu, John A Ozolek, and Gustavo K Rohde. A linear optimal
transportation framework for quantifying and visualizing variations in sets of images. Interna-
tional journal of computer vision, 101(2):254-269, 2013.
Fumihito Yasuma, Tomoo Mitsunaga, Daisuke Iso, and Shree K Nayar. Generalized assorted pixel
camera: postcapture control of resolution, dynamic range, and spectrum. IEEE Transactions on
Image Processing, 19(9):2241-2253, 2010.
13
Published as a conference paper at ICLR 2018
Appendix
A Proofs
Proof of Theorem 1.
Proof. Let ∏n be the solution of the OT problem (2) between μn and Vn which has maximum
entropy. A result about stability of optimal transport (Villani, 2008)[Theorem 5.20] states that, up
to extraction of a subsequence, ∏n, converges weakly to a solution ∏ of the OT problem between μ
and ν (regardless of πn being the solution with maximum entropy or not). We still write (πn) this
subsequence, as well as (πnεn) the corresponding subsequence.
Let g ∈ Cb (X × Y) a bounded continuous function on X × Y. We have,
gdπnεn -	gdπ
X×Y	X×Y
gdπnεn -	gdπn +	gdπn - gdπ
X×Y	X×Y	X×Y	X×Y (14)
The second term in the right-hand side converges to 0 as a result of the previously mentioned stability
of optimal transport (Villani, 2008)[Theorem 5.20]. We now show the convergence of the first term
to 0 when εn → 0 sufficiently fast. We have,
gdπnεn -	gdπn
X×Y	X×Y
g(xi,yj)πnεn(xi,yj) -	g(xi,yj)πn(xi,yj)
i=1,n j=1,n	i=1,n j =1,n
6 MgE |nnn(Xi, y) - πn(xi, y) |
ij
=Mgl∣πnn - πnkn×n,1
(15)
where Mg is an upper-bound of g. A convergence result by Cominetti & San Martin (1994) shows
that there exists positive constants (w.r.t. εn) Mcn,μn,νn and λcn,μn,νn such that,
ε..	λcn,μn,νn
llπnn - πnkn×n,1 6 MCn,“n,Vn e	ε	(16)
where Cn = (c(χι,yι),…，c(χn,yn)). The subscript indices indicate the dependences of each
constant. Hence, we see that choosing any (εn) such that the right-hand side of Eq. (16) tends to 0
provides the results. In particular, we can take
εn =
λCn,μn,Vn
ln(nMCn,μn,Vn )
(17)
which suffices to have the convergence of (15) to 0 for any bounded continuous function g ∈ Cb(X ×
Y). This proves the weak convergence of ∏nn to ∏.	□
Proof of Theorem 2.
Proof First, note that the existence of a Monge map between μ and V follows from the absolute
continuity of μ and the assumptions on the cost functions C (Villani, 2008)[Corollary 9.3].
Let g ∈ Cl (Rd × Rd ) a Lipschitz function on Rd × Rd . Let πn be the unique (by assumption)
solution of the OT problem between μn and νn We have,
g	gd(id, πnn )#〃n - [	gd(id, f )#〃
Rd ×Rd	Rd ×Rd
Rd ×Rd
Rd ×Rd
gd(id,∏nn )#小冗一/	gd(id,nn)#Mn
Rd ×Rd
gd(id, nn)#Mn — /	gd(id, f )#仙)
Rd ×Rd
(18)
Since μn and Vn are uniform discrete probability measures supported on the same number of points,
we know by (Birkhoff, 1946) that the optimal transport πn is actually an optimal assignment Tn , so
14
Published as a conference paper at ICLR 2018
that We have ∏n = (id, Tn)#Mn. This also implies ∏n = Tn so that (id,亓η)#小冗 =(id,以)#从加
Hence, the second term in the right-hand side of (18) converges to 0 as a result of the stability of
optimal transport (Villani, 2008)[Theorem 5.20]. NoW, We shoW that the first term also converges to
0 for εn converging sufficiently fast to 0. By definition of the pushforWard operator,
Jd d gd(id,∏nn)#Mn-/d JdQd,nn)#Nn = /^g(x,∏nn(x)dμn3—/g(x,Tn(x))dμn(x)
R ×R	R ×R	R	R	(19)
and We can bound,
Id g(x, ∏nn (x))dμn (X)- /d g(x,Tn(x))dμn(x)
1n	1n
-fg(Xi,πnn (Xi))-Eg(Xi, Tn(Xi)
n=1 ni=1
6 ∑,Kgtl∏nn (Xi)- Tn(Xi)∣Rd,2
i
=nKg]∣∏nn Yn - ∏nYn∣Rn×n,2
6 nKgllπnn - πn l∣Rn×n 2∣∣Yn∣∣Rn×d 2
(20)
where Yn = (yι,…，yn)t and Kg is the LiPSchitz constant of g. The first inequality follows from g
being Lipschitz. The next equality folloWs from the discrete close form of the barycentric projection.
The last inequality is obtained through Cauchy-Schwartz. We can now use the same arguments as in
the previous proof. A convergence result by Cominetti & San Martin (1994) shows that there exists
positive constants (w.r.t. εn) Mcn,μn,νn and λcn,μn,νn such that,
∣∣πnn	- πn ∣∣Rn×n ,2
_ λcn,μn,νn
6 MCn,μn,Vn e	En
(21)
where Cn = (c(Xι,yι),…，c(Xn,yn)). The subscript indices indicate the dependences of each
constant. Hence, we see that choosing any (εn) such that (21) tends to 0 provides the results. In
particular, we can take
εn
_________λCn,μn,Vn_________
ln(n2∣lYn∣Rn2×d,2MC
n ,μn ,νn )
(22)
which suffices to have the convergence of (15) to 0 for Lipschitz function g ∈ Cl(Rd × Rd). This
proves the weak convergence of (id, ∏nn)#Mn to (id, f )#仙.	□
Proof of Corollary 1.
Proof. Let h ∈ Cb(Rd) a bounded continuous function. Let g ∈ Cb(Rd × Rd) defined as
g : (X, y ) 7→ h(y). We have,
/ hdπnn #Mn - / hdf #M = /	gd(id, πnn )#Mn - /	gd(id, f )#M
Rd	Rd	Rd×Rd	Rd×Rd
which converges to 0 by Theorem (2). Since f #仙=V, this proves the corollary.
(23)
□
15