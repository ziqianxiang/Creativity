Published as a conference paper at ICLR 2022
Analytic-DPM: an Analytic Estimate of the
Optimal Reverse Variance in Diffusion Prob-
abilistic Models
Fan Bao1 *, Chongxuan Li2 3 ^, Jun Zhu11, Bo Zhang1
1Dept. of Comp. Sci. & Tech., Institute for AI, Tsinghua-Huawei Joint Center for AI
BNRist Center, State Key Lab for Intell. Tech. & Sys., Tsinghua University, Beijing, China
2 Gaoling School of Artificial Intelligence, Renmin University of China, Beijing, China
3Beijing Key Laboratory of Big Data Management and Analysis Methods , Beijing, China
bf19@mails.tsinghua.edu.cn,chongxuanli1991@gmail.com,
{dcszj, dcszb}@tsinghua.edu.cn
Ab stract
Diffusion probabilistic models (DPMs) represent a class of powerful generative
models. Despite their success, the inference of DPMs is expensive since it gener-
ally needs to iterate over thousands of timesteps. A key problem in the inference
is to estimate the variance in each timestep of the reverse process. In this work,
we present a surprising result that both the optimal reverse variance and the cor-
responding optimal KL divergence of a DPM have analytic forms w.r.t. its score
function. Building upon it, we propose Analytic-DPM, a training-free inference
framework that estimates the analytic forms of the variance and KL divergence
using the Monte Carlo method and a pretrained score-based model. Further, to
correct the potential bias caused by the score-based model, we derive both lower
and upper bounds of the optimal variance and clip the estimate for a better result.
Empirically, our analytic-DPM improves the log-likelihood of various DPMs, pro-
duces high-quality samples, and meanwhile enjoys a 20× to 80× speed up.
1	Introduction
A diffusion process gradually adds noise to a data distribution over a series of timesteps. By learning
to reverse it, diffusion probabilistic models (DPMs) (Sohl-Dickstein et al., 2015; Ho et al., 2020;
Song et al., 2020b) define a data generative process. Recently, it is shown that DPMs are able
to produce high-quality samples (Ho et al., 2020; Nichol & Dhariwal, 2021; Song et al., 2020b;
Dhariwal & Nichol, 2021), which are comparable or even superior to the current state-of-the-art
GAN models (Goodfellow et al., 2014; Brock et al., 2018; Wu et al., 2019; Karras et al., 2020b).
Despite their success, the inference of DPMs (e.g., sampling and density evaluation) often requires
to iterate over thousands of timesteps, which is two or three orders of magnitude slower (Song et al.,
2020a) than other generative models such as GANs. A key problem in the inference is to estimate
the variance in each timestep of the reverse process. Most of the prior works use a handcrafted
value for all timesteps, which usually run a long chain to obtain a reasonable sample and density
value (Nichol & Dhariwal, 2021). Nichol & Dhariwal (2021) attempt to improve the efficiency of
sampling by learning a variance network in the reverse process. However, it still needs a relatively
long trajectory to get a reasonable log-likelihood (see Appendix E in Nichol & Dhariwal (2021)).
In this work, we present a surprising result that both the optimal reverse variance and the corre-
sponding optimal KL divergence of a DPM have analytic forms w.r.t. its score function (i.e., the
gradient of a log density). Building upon it, we propose Analytic-DPM, a training-free inference
framework to improve the efficiency of a pretrained DPM while achieving comparable or even su-
perior performance. Analytic-DPM estimates the analytic forms of the variance and KL divergence
using the Monte Carlo method and the score-based model in the pretrained DPM. The correspond-
ing trajectory is calculated via a dynamic programming algorithm (Watson et al., 2021). Further, to
*Work done during an internship at HuaWei Noah's Ark Lab. tCorrespondence to: C. Li and J. Zhu.
1
Published as a conference paper at ICLR 2022
correct the potential bias caused by the score-based model, we derive both lower and upper bounds
of the optimal variance and clip its estimate for a better result. Finally, we reveal an interesting
relationship between the score function and the data covariance matrix.
Analytic-DPM is applicable to a variety of DPMs (Ho et al., 2020; Song et al., 2020a; Nichol &
Dhariwal, 2021) in a plug-and-play manner. Empirically, Analytic-DPM consistently improves the
log-likelihood of these DPMs and meanwhile enjoys a 20× to 40× speed up. Besides, Analytic-
DPM also consistently improves the sample quality of DDIMs (Song et al., 2020a) and requires
up to 50 timesteps (which is a 20× to 80× speed up compared to the full timesteps) to achieve a
comparable FID to the corresponding baseline.
2	Background
Diffusion probabilistic models (DPMs) firstly construct a forward process q(x1:N |x0) that injects
noise to a data distribution q(x0), and then reverse the forward process to recover it. Given a forward
noise schedule βn ∈ (0,1), n = 1, ∙∙∙ , N, denoising diffusion probabilistic models (DDPMs) (Ho
et al., 2020) consider a Markov forward process:
N
qM (X1:N IXO) = ɪ ɪ qM (Xn |xn—1), qM (XnIXn—1) = N(Xn | √αnxn-1, BnI),	(I)
n=1
where I is the identity matrix, αn and βn are scalars and αn := 1 -βn. Song et al. (2020a) introduce
a more general non-Markov process indexed by a non-negative vector λ = (λι, •…，λN) ∈ RN0:
N
qλ(Xl: N ∣Xθ) = qλ(XN ∣Xθ) ɪɪ qλ(Xn-1∣Xn, Xo),
n=2
(2)
qλ(XN ∣xo) = N (XN ∣√0N xo,Bn I),
qλ (Xn-1 |Xn, x0 ) = N(Xn— 1 |μn (Xn, X0), λnI),
μn(Xn, x0) =，an-1X0 +
Xn — √OnX0
Here an := Qn=1 αi and βn := 1 - α,. Indeed, Eq. (2) includes the DDPM forward process as a
β
special case when λn = βn where βn := -n-1 βn Another special case of Eq. (2) is the denoising
βn
diffusion implicit model (DDIM) forward process, where λ2n = 0. Besides, we can further derive
qλ(Xn∣Xo) = N(Xn∣√αnX0,βnI), which is independent of λ. In the rest of the paper, We will
focus on the forward process in Eq. (2) since it is more general, and we will omit the index λ and
denote it as q(X1:N IX0) for simplicity.
The reverse process for Eq. (2) is defined as a Markov process aimed to approximate q(X0) by
gradually denoising from the standard Gaussian distribution p(XN) = N (XN I0, I):
N
p(X0:N ) = P(XN ) "p(Xn-1∣Xn),	P(Xn-1∣Xn) = N Qn—1 ∣μn(Xn),σn I ),
n=1
where μn(Xn) is generally parameterized 1 by a time-dependent score-based model Sn(Xn) (Song
& Ermon, 2019; Song et al., 2020b):
μn(Xn)
μn
Xn, -m=(Xn + Bnsn (Xn))) .
a αn	)
(3)
The reverse process can be learned by optimizing a variational bound Lvb on negative log-likelihood:
N
Lvb=Eq -logP(X0IX1)+	DKL(q(Xn—1IX0, Xn)IIP(Xn—1IXn))+ DKL(q(XN IX0)IIP(XN)) ,
n=2
1Ho et al. (2020); Song et al. (2020a) parameterize μn (Xn
is equivalent to Eq. (3) by letting Sn(Xn) =--en(xn).
β βn
βnEn(Xn))), which
2
Published as a conference paper at ICLR 2022
which is equivalent to optimizing the KL divergence between the forward and the reverse process:
min	Lvb ⇔	min	DKL (q(x0:N)||p(x0:N)).	(4)
{μn ,σn}n = 1	{μn,σn}n=1
To improve the sample quality in practice, instead of directly optimizing Lvb, Ho et al. (2020)
consider a reweighted variant of Lvb to learn sn(xn):
min Ene nEqn (xn) ||sn (xn) - ^Xn log qn (xn) || = En,X0,eMW + ʌ/ βnsn(xn) || + c,	(5)
{sn}n=1
where n is uniform between 1 and N, qn (xn) is the marginal distribution of the forward process
at timestep n, W is a standard Gaussian noise, xn on the right-hand side is reparameterized by
xn
√αnxο + ʌ/ene and C isa constant only related to q. Indeed, Eq. (5) is exactly a weighted SUm
of score matching objectives (Song & Ermon, 2019), which admits an optimal solution Sn(Xn)
Vχn log qn(xn) for all n ∈{1, 2 …，N}.
Note that Eq. (5) provides no learning signal for the variance σn2. Indeed, σn2 is generally handcrafted
in most of prior works. In DDPMs (Ho et al., 2020), two commonly used settings are σn2 = βn and
σnn = βn. In DDIMs, Song et al. (2020a) consistently use σnn = λn. We argue that these handcrafted
values are not the true optimal solution of Eq. (4) in general, leading to a suboptimal performance.
3 Analytic Estimate of the Optimal Reverse Variance
For a DPM, We first show that both the optimal mean μn (Xn) and the optimal variance σn2 to Eq. (4)
have analytic forms w.r.t. the score function, which is summarized in the following Theorem 1.
Theorem 1. (Score representation of the optimal solution to Eq. (4), proof in Appendix A.2)
The optimal solution μn(xn) and σn2 to Eq. (4) are
μn(xn) = μ n (xn, ~~i≡=z (xn + fnVXn log qn(Xn))),
∖	√Qn	)
σn2 = λn +1 昌
{βn-1 - λn J (1 - βnEqn(xn)
||Vxnlogqn(Xn)||2
(6)
(7)
—
d
where qn (Xn) is the marginal distribution of the forward process at the timestep n and d is the
dimension of the data.
The proof of Theorem 1 consists of three key steps:
•	The first step (see Lemma 9) is known as the moment matching (Minka, 2013), which
states that approximating arbitrary density by a Gaussian density under the KL divergence
is equivalent to setting the first two moments of the two densities as the same. To our
knowledge, the connection of moment matching and DPMs has not been revealed before.
•	In the second step (see Lemma 13), we carefully use the law of total variance conditioned
on X0 and convert the second moment of q(Xn-1|Xn) to that of q(X0|Xn).
•	In the third step (see Lemma 11), we surprisingly find that the second moment of q(X0|Xn)
can be represented by the score function, and we plug the score representation into the
second moment of q(Xn-1 |Xn) to get the final results in Theorem 1.
The results in Theorem 1 (and other results to appear later) can be further simplified for the DDPM
forward process (i.e., λ2n = βn, see Appendix D for details). Besides, we can also extend Theo-
rem 1 to DPMs with continuous timesteps (Song et al., 2020b; Kingma et al., 2021), where their
corresponding optimal mean and variance are also determined by the score function in an analytic
form (see Appendix E.1 for the extension).
Note that our analytic form of the optimal mean μni(xn) in Eq. (6) and the previous parameterization
of μn(xn) (Ho et al., 2020) in Eq. (3) coincide. The only difference is that Eq. (3) replaces the
3
Published as a conference paper at ICLR 2022
7 9 13
--TT
2 222
ueue>
4 3 2 1
0000
(E 一 p∕sτ E」£q>7
22	25	28	22	25	28
timestep n	timestep n
(a) Variance	(b) Terms in Lvb
Figure 1: Comparing our analytic estimate 3匕 and prior works with handcrafted variances βn and
βn . (a) compares the values of the variance for different timesteps. (b) compares the term in Lvb
corresponding to each timestep. The value of Lvb is the area under the corresponding curve.
score function Rxn log qn(xn) in Eq. (6) with the score-based model Sn(xn). This result explicitly
shows that Eq. (5) essentially shares the same optimal mean solution to the Lvb objective, providing
a simple and alternative perspective to prior works.
In contrast to the handcrafted strategies used in (Ho et al., 2020; Song et al., 2020a), Theorem 1
shows that the optimal reverse variance σn2 can also be estimated without any extra training process
given a pretrained score-based model sn (xn). In fact, we first estimate the expected mean squared
norm of Rxn logqn(xn) by Γ = (Γ1, ..., ΓN), where
Γn = MM XX l|Sn(X；m)l12 ,	Xn,m% Ind).
m=1
(8)
M is the number of Monte Carlo samples. We only need to calculate Γ once for a pretrained
model and reuse it in downstream computations (see Appendix H.1 for a detailed discussion of the
computation cost of Γ). Then, according to Eq. (7), We estimate σn2 as follows:
(9)
We empirically validate Theorem 1. In Figure 1 (a), we plot our analytic estimate σnn of a DDPM
trained on CIFAR10, as well as the baselines βn and βn used by Ho et al. (2020). At small timesteps,
these strategies behave differently. Figure 1 (b) shows that our σ( outperforms the baselines for each
term of Lvb, especially at the small timesteps. We also obtain similar results on other datasets (see
Appendix G.1). Besides, we show that only a small number of Monte Carlo (MC) samples (e.g.,
M =10, 100) is required to achieve a sufficiently small variance caused by MC and get a similar
performance to that with a large M (see Appendix G.2). We also discuss the stochasticity of Lvb
after plugging (^nn in Appendix H.2.
3.1	B ounding the Optimal Reverse Variance to Reduce Bias
According to Eq. (7) and Eq. (9), the bias of the analytic estimate σ( is
∣σn2 - σn | = (San - qβn-1- λn j βn Irn- Eqn(Xn) Jogdn(Xn)||1 .	(10)
、	一	/	Approximation error
Coefficient
Our estimate of the variance employs a score-based model sn (xn) to approximate the true score
function Rxn log qn(xn). Thus, the approximation error in Eq. (10) is irreducible given a pretrained
model. Meanwhile, the coefficient in Eq. (10) can be large if we use a shorter trajectory to sample
(see details in Section 4), potentially resulting in a large bias.
4
Published as a conference paper at ICLR 2022
To reduce the bias, We derive bounds of the optimal reverse variance σn2 and clip our estimate based
on the bounds. Importantly, these bounds are unrelated to the data distribution q(x0) and hence
can be efficiently calculated. We firstly derive both upper and lower bounds of σn2 without any
assumption about the data. Then we show another upper bound of σn2 if the data distribution is
bounded. We formalize these bounds in Theorem 2.
Theorem 2. (Bounds of the optimal reverse variance, proof in Appendix A.3)
σn2 has thefollowing lower and upper bounds:
(11)
Ifwe further assume q(x0) is a bounded distribution in [a, b]d, where d is the dimension of data,
then σn2 can befurther upper bounded by
*2 /
σn ≤
2
(12)
Theorem 2 states that the handcrafted reverse variance λ2n in prior works (Ho et al., 2020; Song et al.,
2020a) underestimates σn2. For instance, λ2τ = βn in DDPM. We compare it with our estimate in
Figure 1 (a) and the results agree with Theorem 2. Besides, the boundedness assumption of q(x0)
is satisfied in many scenarios including generative modelling of images, and which upper bound
among Eq. (11) and Eq. (12) is tighter depends on n. Therefore, we clip our estimate based on the
minimum one. Further, we show theses bounds are tight numerically in Appendix G.3.
4 Analytic Estimation of the Optimal Trajectory
The number of full timesteps N can be large, making the inference slow in practice. Thereby, we can
construct a shorter forward process q(xτι ,…，Xτκ |xo) constrained on a trajectory 1 = τι < … <
τK = N of K timesteps (Song et al., 2020a; Nichol & Dhariwal, 2021; Watson et al., 2021), and K
can be much smaller than N to speed up the inference. Formally, the shorter process is defined as
q(Xτι,…,Xτκ |xo) = q(Xτκ |xo) QK=2 q(Xτk-ι∣Xτk, X0), where
q(xτk-ι lxTk , XO)= N (XTk-Ja Tk-1 ∣Tk (XTk , XO),λTk-ι∣Tk1),
(13)
μTk-1∣Tk (xτk , XO) = pατk-ι x0 + ββTk-ι - λTk-ι∣Tk
XTk - √aTk xO
The corresponding reverse process is p(xo, Xti ,…,XTK) = P(XTK) QK=I p(Xτk-ι ∣Xτk), where
P(XTk-1 |XTk ) = N (XTk-1 lμTk-i | Tk (XTk ), σTk-ι∣Tk I).
According to Theorem 1, the mean and variance of the optimal p* (XTk-1 |XTk ) in the sense of KL
minimization is
从Tk-ι∣Tk (XTk ) = μ Tk-ι∣Tk (XTk , √α— (XTk + βτk NlxTk log q(XTk))),
στ2-^τk=λτk-ιkk+(SOU -qβτk-1
⅛-ι∣Tk I (I-βTkEq(XTk )
“Vχτk log q(XTk )||
2
),
—
d
where ατk∣τk-ι ：= ατk/~O-τk-ι. According to Theorem 2, we can derive similar bounds for σ*2 ]∣τfc
(see details in Appendix C). Similarly to Eq. (9), the estimate ofσ*2 | is
Tk-1 |Tk
σTk-1∣Tk = λTk-1∣Tk + I ∖ O~~	q !βTk-1
αTk |Tk-1
k-1 |Tk
2
(1-MjTk),
—
5
Published as a conference paper at ICLR 2022
where Γ is defined in Eq. (8) and can be shared across different selections of trajectories. Based on
the optimal reverse process p* above, We further optimize the trajectory:
dK
T milT DκL(q(xo, Xτι,…，Xτκ)∣∣P*(X0, Xτι,…，Xτκ)) = 2 EJ(Tk-ι,Tk) + c, (14)
τ1 , ,τK	k=2
where J(τk-ι, Tk) = l0g(0T2_i|Tk/λTk_i∣τfc) and C is a constant unrelated to the trajectory T (see
proof in Appendix A.4). The KL in Eq. (14) can be decomposed into K - 1 terms and each term
has an analytic form w.r.t. the score function. We view each term as a cost function J evaluated
at (τk-ι, Tk), and it can be efficiently estimated by J(τk-ι,τk) ≈ log(σT^ ^丁仁/^Tk_ 1∣τfc), which
doesn’t require any neural network computation once Γ is given. While the logarithmic function
causes bias even when the correct score function is known, it can be reduced by increasing M .
As a result, Eq. (14) is reduced to a canonical least-cost-path problem (Watson et al., 2021) on a
directed graph, where the nodes are {1, 2, ∙∙∙ , N} and the edge from S to t has cost J(s,t). We
want to find a least-cost path of K nodes starting from 1 and terminating at N. This problem
can be solved by the dynamic programming (DP) algorithm introduced by Watson et al. (2021).
We present this algorithm in Appendix B. Besides, we can also extend Eq. (14) to DPMs with
continuous timesteps (Song et al., 2020b; Kingma et al., 2021), where their corresponding optimal
KL divergences are also decomposed to terms determined by score functions. Thereby, the DP
algorithm is also applicable. See Appendix E.2 for the extension.
5	Relationship between The Score Function and the Data
Covariance Matrix
In this part, we further reveal a relationship between the score function and the data covariance
matrix. Indeed, the data covariance matrix can be decomposed to the sum of Eq(xn)Covq(x0|xn) [x0]
and Covq(xn)Eq(x0 |xn) [x0], where the first term can be represented by the score function. Further,
the second term is negligible when n is sufficiently large because x0 and xn are almost independent.
In such cases, the data covariance matrix is almost determined by the score function. Currently, the
relationship is purely theoretical and its practical implication is unclear. See details in Appendix A.5.
6	Experiments
We consider the DDPM forward process (λn = βn) and the DDIM forward process (λn = 0),
which are the two most commonly used special cases of Eq. (2). We denote our method, which
uses the analytic estimate σηn = σ22b, as Analytic-DPM, and explicitly call it Analytic-DDPM or
Analytic-DDIM according to which forward process is used. We compare our Analytic-DPM with
the original DDPM (Ho et al., 2020), where the reverse variance is either σ∖ = βn or σ∖ = βn, as
well as the original DDIM (Song et al., 2020a), where the reverse variance is σn2 = λ2n = 0.
We adopt two methods to get the trajectory for both the analytic-DPM and baselines. The first one is
even trajectory (ET) (Nichol & Dhariwal, 2021), where the timesteps are determined according to a
fixed stride (see details in Appendix F.4). The second one is optimal trajectory (OT) (Watson et al.,
2021), where the timesteps are calculated via dynamic programming (see Section 4). Note that the
baselines calculate the OT based on the Lvb with their handcrafted variances (Watson et al., 2021).
We apply our Analytic-DPM to three pretrained score-based models provided by prior works (Ho
et al., 2020; Song et al., 2020a; Nichol & Dhariwal, 2021), as well as two score-based models
trained by ourselves. The pretrained score-based models are trained on CelebA 64x64 (Liu et al.,
2015), ImageNet 64x64 (Deng et al., 2009) and LSUN Bedroom (Yu et al., 2015) respectively. Our
score-based models are trained on CIFAR10 (Krizhevsky et al., 2009) with two different forward
noise schedules: the linear schedule (LS) (Ho et al., 2020) and the cosine schedule (CS) (Nichol &
Dhariwal, 2021). We denote them as CIFAR10 (LS) and CIFAR10 (CS) respectively. The number
of the full timesteps N is 4000 for ImageNet 64x64 and 1000 for other datasets. During sampling,
we only display the mean of p(x0|x1) and discard the noise following Ho et al. (2020), and we
additionally clip the noise scale σ2 ofp(x1|x2) for all methods compared in Table 2 (see details in
Appendix F.2 and its ablation study in Appendix G.4). See more experimental details in Appendix F.
6
Published as a conference paper at ICLR 2022
Table 1: Negative log-likelihood (bits/dim) [ under the DDPM forward process. We show results
under trajectories of different number of timesteps K. We select the minimum K such that analytic-
DPM can outperform the baselines with full timesteps and underline the corresponding results.
Model \ # timesteps K	10	25	50	100	200	400	1000
CIFAR10 (LS)							
DDPM, σn = βn ET DDPM, σn2 = βn	74.95	24.98	12.01	7.08	5.03	4.29	3.73
	6.99	6.11	5.44	4.86	4.39	4.07	3.75
Analytic-DDPM	5.47	4.79	4.38	4.07	3.84	3.71	3.59
OT DDPM, σn2 = βn OT Analytic-DDPM	5.38	4.34	3.97	3.82	3.77	3.75	3.75
	4.11	3.68	3.61	3.59	3.59	3.59	3.59
CIFAR10 (CS)							
DDPM, σn = βn ET DDPM, σn2 = βn	75.96	24.94	11.96	7.04	4.95	4.19	3.60
	6.51	5.55	4.92	4.41	4.03	3.78	3.54
Analytic-DDPM	5.08	4.45	4.09	3.83	3.64	3.53	3.42
OT DDPM, σn2 = βn OT Analytic-DDPM	5.51	4.30	3.86	3.65	3.57	3.54	3.54
	3.99	3.56	3.47	3.44	3.43	3.42	3.42
CelebA 64x64							
DDPM, σn = βn ET DDPM, σn2 = βn	33.42	13.09	7.14	4.60	3.45	3.03	2.71
	6.67	5.72	4.98	4.31	3.74	3.34	2.93
Analytic-DDPM	4.54	3.89	3.48	3.16	2.92	2.79	2.66
OT DDPM, σn2 = βn OT Analytic-DDPM	4.76	3.58	3.16	2.99	2.94	2.93	2.93
	2.97	2.71	2.67	2.66	2.66	2.66	2.66
							
Model \ # timesteps K	25	50	100	200	400	1000	4000
ImageNet 64x64							
DDPM, σn = βn	105.87	46.25	22.02	12.10	7.59	5.04	3.89
ET DDPM, σn2 = βn	5.81	5.20	4.70	4.31	4.04	3.81	3.65
Analytic-DDPM	4.78	4.42	4.15	3.95	3.81	3.69	3.61
OT DDPM, σn2 = βn OT Analytic-DDPM	4.56	4.09	3.84	3.73	3.68	3.65	3.65
	3.83	3.70	3.64	3.62	3.62	3.61	3.61
We conduct extensive experiments to demonstrate that analytic-DPM can consistently improve the
inference efficiency of a pretrained DPM while achieving a comparable or even superior perfor-
mance. Specifically, Section 6.1 and Section 6.2 present the likelihood and sample quality results
respectively. Additional experiments such as ablation studies can be found in Appendix G.
6.1	Likelihood Results
Since λ2n = 0 in the DDIM forward process, its variational bound Lvb is infinite. Thereby, we
only consider the likelihood results under the DDPM forward process. As shown in Table 1, on all
three datasets, our Analytic-DPM consistently improves the likelihood results of the original DDPM
using both ET and OT. Remarkably, using a much shorter trajectory (i.e., a much less inference
time), Analytic-DPM with OT can still outperform the baselines. In Table 1, we select the mini-
mum K such that analytic-DPM can outperform the baselines with full timesteps and underline the
corresponding results. Specifically, analytic-DPM enjoys a 40× speed up on CIFAR10 (LS) and
ImageNet 64x64, and a 20× speed up on CIFAR10 (CS) and CelebA 64x64.
Although we mainly focus on learning-free strategies of choosing the reverse variance, we also
compare to another strong baseline that predicts the variance by a neural network (Nichol & Dhari-
wal, 2021). With full timesteps, Analytic-DPM achieves a NLL of 3.61 on ImageNet 64x64, which
is very close to 3.57 reported in Nichol & Dhariwal (2021). Besides, while Nichol & Dhariwal
(2021) report that the ET drastically reduces the log-likelihood performance of their neural-network-
parameterized variance, Analytic-DPM performs well with the ET. See details in Appendix G.6.
7
Published as a conference paper at ICLR 2022
Table 2: FID ] under the DDPM and DDIM forward processes. All are evaluated under the even
trajectory (ET). The result with * is slightly better than 3.17 reported by Ho et al. (2020), because
we use an improved model architecture following Nichol & Dhariwal (2021).
Model \ # timesteps K	10	25	50	100	200	400	1000
CIFAR10 (LS)							
DDPM, σn = βn	44.45	21.83	15.21	10.94	8.23	6.43	5.11
DDPM, σn2 = βn	233.41	125.05	66.28	31.36	12.96	4.86	*3.04
Analytic-DDPM	34.26	11.60	7.25	5.40	4.01	3.62	4.03
DDIM	21.31	10.70	7.74	6.08	5.07	4.61	4.13
Analytic-DDIM	14.00	5.81	4.04	3.55	3.39	3.50	3.74
CIFAR10 (CS)
DDPM, σn = βn	34.76	16.18	11.11	8.38	6.66	5.65	4.92
DDPM, σn2 = βn	205.31	84.71	37.35	14.81	5.74	3.40	3.34
Analytic-DDPM	22.94	8.50	5.50	4.45	4.04	3.96	4.31
DDIM	34.34	16.68	10.48	7.94	6.69	5.78	4.89
Analytic-DDIM	26.43	9.96	6.02	4.88	4.92	5.00	4.66
CelebA 64x64
DDPM, σn = βn DDPM, σn2 = βn Analytic-DDPM	36.69 294.79 28.99	24.46 115.69 16.01	18.96 53.39 11.23	14.31 25.65 8.08	10.48 9.72 6.51	8.09 3.95 5.87	5.95 3.16 5.21
DDIM	20.54	13.45	9.33	6.60	4.96	4.15	3.40
Analytic-DDIM	15.62	9.22	6.13	4.29	3.46	3.38	3.13
							
Model \ # timesteps K	25	50	100	200	400	1000	4000
ImageNet 64x64							
DDPM, σn = βn	29.21	21.71	19.12	17.81	17.48	16.84	16.55
DDPM, σn2 = βn	170.28	83.86	45.04	28.39	21.38	17.58	16.38
Analytic-DDPM	32.56	22.45	18.80	17.16	16.40	16.14	16.34
DDIM	26.06	20.10	18.09	17.84	17.74	17.73	19.00
Analytic-DDIM	25.98	19.23	17.73	17.49	17.44	17.57	18.98
6.2 Sample Quality
As for the sample quality, we consider the commonly used FID score (Heusel et al., 2017), where a
lower value indicates a better sample quality. As shown in Table 2, under trajectories of different K,
our Analytic-DDIM consistently improves the sample quality of the original DDIM. This allows us
to generate high-quality samples with less than 50 timesteps, which results in a 20× to 80× speed
up compared to the full timesteps. Indeed, in most cases, Analytic-DDIM only requires up to 50
timesteps to get a similar performance to the baselines. Besides, Analytic-DDPM also improves the
sample quality of the original DDPM in most cases. For fairness, we use the ET implementation in
Nichol & Dhariwal (2021) for all results in Table 2. We also report the results on CelebA 64x64
using a slightly different implementation of the ET following Song et al. (2020a) in Appendix G.7,
and our Analytic-DPM is still effective. We show generated samples in Appendix G.9.
We observe that Analytic-DDPM does not always outperform the baseline under the FID metric,
which is inconsistent with the likelihood results in Table 1. Such a behavior essentially roots in the
different natures of the two metrics and has been investigated in extensive prior works (Theis et al.,
2015; Ho et al., 2020; Nichol & Dhariwal, 2021; Song et al., 2021; Vahdat et al., 2021; Watson et al.,
2021; Kingma et al., 2021). Similarly, using more timesteps doesn’t necessarily yield a better FID.
For instance, see the Analytic-DDPM results on CIFAR10 (LS) and the DDIM results on ImageNet
64x64 in Table 2. A similar phenomenon is observed in Figure 8 in Nichol & Dhariwal (2021).
Moreover, a DPM (including Analytic-DPM) with OT does not necessarily lead to a better FID
score (Watson et al., 2021) (see Appendix G.5 for a comparison ofET and OT in Analytic-DPM).
8
Published as a conference paper at ICLR 2022
Table 3: Efficiency comparison, based on the least number of timesteps J required to achieve a FID
around 6 (with the corresponding FID). To get the strongest baseline, the results with * are achieved
by using the quadratic trajectory Song et al. (2020a) instead of the default even trajectory.
Method	CIFAR10	CelebA 64x64	LSUN Bedroom
DDPM (Ho et al., 2020)	*90 (6.12)	> 200	130 (6.06)
DDIM (Song et al., 2020a)	*30(5.85)	> 100	Best FID >6
Improved DDPM (Nichol & Dhariwal, 2021)	45 (5.96)	Missing model	90 (6.02)
Analytic-DPM (ours)	25(5.81)	55 (5.98)	100 (6.05)
We summarize the efficiency of different methods in Table 3, where we consider the least number
of timesteps required to achieve a FID around 6 as the metric for a more direct comparison.
7	Related Work
DPMs and their applications. The diffusion probabilistic model (DPM) is initially introduced by
Sohl-Dickstein et al. (2015), where the DPM is trained by optimizing the variational bound Lvb.
Ho et al. (2020) propose the new parameterization of DPMs in Eq. (3) and learn DPMs with the
reweighted variant of Lvb in Eq. (5). Song et al. (2020b) model the noise adding forward process
as a stochastic differential equation (SDE) and introduce DPMs with continuous timesteps. With
these important improvements, DPMs show great potential in various applications, including speech
synthesis (Chen et al., 2020; Kong et al., 2020; Popov et al., 2021; Lam et al., 2021), controllable
generation (Choi et al., 2021; Sinha et al., 2021), image super-resolution (Saharia et al., 2021; Li
et al., 2021), image-to-image translation (Sasaki et al., 2021), shape generation (Zhou et al., 2021)
and time series forecasting (Rasul et al., 2021).
Faster DPMs. Several works attempt to find short trajectories while maintaining the DPM per-
formance. Chen et al. (2020) find an effective trajectory of only six timesteps by the grid search.
However, the grid search is only applicable to very short trajectories due to its exponentially growing
time complexity. Watson et al. (2021) model the trajectory searching as a least-cost-path problem
and introduce a dynamic programming (DP) algorithm to solve this problem. Our work uses this
DP algorithm, where the cost is defined as a term of the optimal KL divergence. In addition to
these trajectory searching techniques, Luhman & Luhman (2021) compress the reverse denoising
process into a single step model; San-Roman et al. (2021) dynamically adjust the trajectory dur-
ing inference. Both of them need extra training after getting a pretrained DPM. As for DPMs with
continuous timesteps (Song et al., 2020b), Song et al. (2020b) introduce an ordinary differential
equation (ODE), which improves sampling efficiency and enables exact likelihood computation.
However, the likelihood computation involves a stochastic trace estimator, which requires a multiple
number of runs for accurate computation. Jolicoeur-Martineau et al. (2021) introduce an advanced
SDE solver to simulate the reverse process in a more efficient way. However, the log-likelihood
computation based on this solver is not specified.
Variance Learning in DPMs. In addition to the reverse variance, there are also works on learning
the forward noise schedule (i.e., the forward variance). Kingma et al. (2021) propose variational
diffusion models (VDMs) on continuous timesteps, which use a signal-to-noise ratio function to
parameterize the forward variance and directly optimize the variational bound objective for a better
log-likelihood. While we primarily apply our method to DDPMs and DDIMs, estimating the optimal
reverse variance can also be applied to VDMs (see Appendix E).
8	Conclusion
We present that both the optimal reverse variance and the corresponding optimal KL divergence
of a DPM have analytic forms w.r.t. its score function. Building upon it, we propose Analytic-
DPM, a training-free inference framework that estimates the analytic forms of the variance and KL
divergence using the Monte Carlo method and a pretrained score-based model. We derive bounds
of the optimal variance to correct potential bias and reveal a relationship between the score function
and the data covariance matrix. Empirically, our analytic-DPM improves both the efficiency and
performance of likelihood results, and generates high-quality samples efficiently in various DPMs.
9
Published as a conference paper at ICLR 2022
Acknowledgments
This work was supported by NSF of China Projects (Nos. 62061136001, 61620106010,
62076145), Beijing NSF Project (No. JQ19016), Beijing Outstanding Young Scientist Program
NO. BJJWZYJH012019100020098, Beijing Academy of Artificial Intelligence (BAAI), Tsinghua-
Huawei Joint Research Program, a grant from Tsinghua Institute for Guo Qiang, and the NVIDIA
NVAIL Program with GPU/DGX Acceleration, Major Innovation & Planning Interdisciplinary Plat-
form for the “Double-First Class” Initiative, Renmin University of China.
Ethics S tatement
This work proposes an analytic estimate of the optimal variance in the reverse process of diffusion
probabilistic models. As a fundamental research in machine learning, the negative consequences are
not obvious. Though in theory any technique can be misused, it is not likely to happen at the current
stage.
Reproducibility S tatement
We provide our codes and links to pretrained models in https://github.com/baofff/
Analytic-DPM. We provide details of these pretrained models in Appendix F.1. We provide de-
tails of data processing, log-likelihood evaluation, sampling and FID computation in Appendix F.2.
We provide complete proofs of all theoretical results in Appendix A.
References
Andrew Brock, Jeff Donahue, and Karen Simonyan. Large scale gan training for high fidelity natural
image synthesis. arXiv preprint arXiv:1809.11096, 2018.
Yuri Burda, Roger Grosse, and Ruslan Salakhutdinov. Importance weighted autoencoders. arXiv
preprint arXiv:1509.00519, 2015.
Nanxin Chen, Yu Zhang, Heiga Zen, Ron J Weiss, Mohammad Norouzi, and William Chan. Wave-
grad: Estimating gradients for waveform generation. arXiv preprint arXiv:2009.00713, 2020.
Jooyoung Choi, Sungwon Kim, Yonghyun Jeong, Youngjune Gwon, and Sungroh Yoon. Ilvr: Con-
ditioning method for denoising diffusion probabilistic models. arXiv preprint arXiv:2108.02938,
2021.
Jia Deng, Wei Dong, Richard Socher, Li-Jia Li, Kai Li, and Li Fei-Fei. Imagenet: A large-scale hi-
erarchical image database. In 2009 IEEE conference on computer vision and pattern recognition,
pp. 248-255. Ieee, 2009.
Prafulla Dhariwal and Alex Nichol. Diffusion models beat gans on image synthesis. arXiv preprint
arXiv:2105.05233, 2021.
Yilun Du and Igor Mordatch. Implicit generation and generalization in energy-based models. arXiv
preprint arXiv:1903.08689, 2019.
Ian Goodfellow, Jean Pouget-Abadie, Mehdi Mirza, Bing Xu, David Warde-Farley, Sherjil Ozair,
Aaron Courville, and Yoshua Bengio. Generative adversarial nets. Advances in neural information
processing systems, 27, 2014.
Martin Heusel, Hubert Ramsauer, Thomas Unterthiner, Bernhard Nessler, and Sepp Hochreiter.
Gans trained by a two time-scale update rule converge to a local nash equilibrium. Advances in
neural information processing systems, 30, 2017.
Jonathan Ho, Ajay Jain, and Pieter Abbeel. Denoising diffusion probabilistic models. arXiv preprint
arXiv:2006.11239, 2020.
10
Published as a conference paper at ICLR 2022
Alexia Jolicoeur-Martineau, Ke Li, Remi Piche-Taillefer, Tal Kachman, and Ioannis Mitliagkas.
Gotta go fast when generating data with score-based models. arXiv preprint arXiv:2105.14080,
2021.
Tero Karras, Miika Aittala, Janne Hellsten, Samuli Laine, Jaakko Lehtinen, and Timo Aila. Training
generative adversarial networks with limited data. arXiv preprint arXiv:2006.06676, 2020a.
Tero Karras, Samuli Laine, Miika Aittala, Janne Hellsten, Jaakko Lehtinen, and Timo Aila. Analyz-
ing and improving the image quality of stylegan. In Proceedings of the IEEE/CVF Conference on
Computer Vision and Pattern Recognition, pp. 8110-8119, 2020b.
Hyun-Chul Kim and Zoubin Ghahramani. Bayesian gaussian process classification with the em-ep
algorithm. IEEE Transactions on Pattern Analysis and Machine Intelligence, 28(12):1948-1959,
2006.
Diederik P Kingma and Prafulla Dhariwal. Glow: Generative flow with invertible 1x1 convolutions.
arXiv preprint arXiv:1807.03039, 2018.
Diederik P Kingma, Tim Salimans, Ben Poole, and Jonathan Ho. Variational diffusion models.
arXiv preprint arXiv:2107.00630, 2021.
Zhifeng Kong, Wei Ping, Jiaji Huang, Kexin Zhao, and Bryan Catanzaro. Diffwave: A versatile
diffusion model for audio synthesis. arXiv preprint arXiv:2009.09761, 2020.
Alex Krizhevsky, Geoffrey Hinton, et al. Learning multiple layers of features from tiny images.
2009.
Max WY Lam, Jun Wang, Rongjie Huang, Dan Su, and Dong Yu. Bilateral denoising diffusion
models. arXiv preprint arXiv:2108.11514, 2021.
Haoying Li, Yifan Yang, Meng Chang, Huajun Feng, Zhihai Xu, Qi Li, and Yueting Chen.
Srdiff: Single image super-resolution with diffusion probabilistic models. arXiv preprint
arXiv:2104.14951, 2021.
Ziwei Liu, Ping Luo, Xiaogang Wang, and Xiaoou Tang. Deep learning face attributes in the wild. In
2015 IEEE International Conference on Computer Vision, ICCV 2015, Santiago, Chile, December
7-13, 2015, pp. 3730-3738. IEEE Computer Society, 2015.
Ilya Loshchilov and Frank Hutter. Decoupled weight decay regularization. arXiv preprint
arXiv:1711.05101, 2017.
Eric Luhman and Troy Luhman. Knowledge distillation in iterative generative models for improved
sampling speed. arXiv preprint arXiv:2101.02388, 2021.
Thomas P Minka. Expectation propagation for approximate bayesian inference. arXiv preprint
arXiv:1301.2294, 2013.
Thomas Peter Minka. A family of algorithms for approximate Bayesian inference. PhD thesis,
Massachusetts Institute of Technology, 2001.
Takeru Miyato, Toshiki Kataoka, Masanori Koyama, and Yuichi Yoshida. Spectral normalization
for generative adversarial networks. arXiv preprint arXiv:1802.05957, 2018.
Alex Nichol and Prafulla Dhariwal. Improved denoising diffusion probabilistic models. arXiv
preprint arXiv:2102.09672, 2021.
Vadim Popov, Ivan Vovk, Vladimir Gogoryan, Tasnima Sadekova, and Mikhail Kudinov. Grad-tts:
A diffusion probabilistic model for text-to-speech. arXiv preprint arXiv:2105.06337, 2021.
Kashif Rasul, Calvin Seward, Ingmar Schuster, and Roland Vollgraf. Autoregressive denois-
ing diffusion models for multivariate probabilistic time series forecasting. arXiv preprint
arXiv:2101.12072, 2021.
11
Published as a conference paper at ICLR 2022
Danilo Jimenez Rezende, Shakir Mohamed, and Daan Wierstra. Stochastic backpropagation and ap-
proximate inference in deep generative models. In International conference on machine learning,
pp.1278-1286. PMLR, 2014.
Chitwan Saharia, Jonathan Ho, William Chan, Tim Salimans, David J Fleet, and Mohammad
Norouzi. Image super-resolution via iterative refinement. arXiv preprint arXiv:2104.07636, 2021.
Robin San-Roman, Eliya Nachmani, and Lior Wolf. Noise estimation for generative diffusion mod-
els. arXiv preprint arXiv:2104.02600, 2021.
Hiroshi Sasaki, Chris G Willcocks, and Toby P Breckon. Unit-ddpm: Unpaired image translation
with denoising diffusion probabilistic models. arXiv preprint arXiv:2104.05358, 2021.
Abhishek Sinha, Jiaming Song, Chenlin Meng, and Stefano Ermon. D2c: Diffusion-denoising
models for few-shot conditional generation. arXiv preprint arXiv:2106.06819, 2021.
Jascha Sohl-Dickstein, Eric Weiss, Niru Maheswaranathan, and Surya Ganguli. Deep unsupervised
learning using nonequilibrium thermodynamics. In International Conference on Machine Learn-
ing, pp. 2256-2265. PMLR, 2015.
Jiaming Song, Chenlin Meng, and Stefano Ermon. Denoising diffusion implicit models. arXiv
preprint arXiv:2010.02502, 2020a.
Yang Song and Stefano Ermon. Generative modeling by estimating gradients of the data distribution.
arXiv preprint arXiv:1907.05600, 2019.
Yang Song, Jascha Sohl-Dickstein, Diederik P Kingma, Abhishek Kumar, Stefano Ermon, and Ben
Poole. Score-based generative modeling through stochastic differential equations. arXiv preprint
arXiv:2011.13456, 2020b.
Yang Song, Conor Durkan, Iain Murray, and Stefano Ermon. Maximum likelihood training of score-
based diffusion models. arXiv e-prints, pp. arXiv-2101, 2021.
Lucas Theis, Aaron van den Oord, and Matthias Bethge. A note on the evaluation of generative
models. arXiv preprint arXiv:1511.01844, 2015.
Arash Vahdat and Jan Kautz. Nvae: A deep hierarchical variational autoencoder. arXiv preprint
arXiv:2007.03898, 2020.
Arash Vahdat, Karsten Kreis, and Jan Kautz. Score-based generative modeling in latent space. arXiv
preprint arXiv:2106.05931, 2021.
Daniel Watson, Jonathan Ho, Mohammad Norouzi, and William Chan. Learning to efficiently sam-
ple from diffusion probabilistic models. arXiv preprint arXiv:2106.03802, 2021.
Yan Wu, Jeff Donahue, David Balduzzi, Karen Simonyan, and Timothy Lillicrap. Logan: Latent
optimisation for generative adversarial networks. arXiv preprint arXiv:1912.00953, 2019.
Zhisheng Xiao, Karsten Kreis, Jan Kautz, and Arash Vahdat. Vaebm: A symbiosis between varia-
tional autoencoders and energy-based models. In International Conference on Learning Repre-
sentations, 2020.
Fisher Yu, Yinda Zhang, Shuran Song, Ari Seff, and Jianxiong Xiao. Lsun: Construction of
a large-scale image dataset using deep learning with humans in the loop. arXiv preprint
arXiv:1506.03365, 2015.
Linqi Zhou, Yilun Du, and Jiajun Wu. 3d shape generation and completion through point-voxel
diffusion. arXiv preprint arXiv:2104.03670, 2021.
12
Published as a conference paper at ICLR 2022
A Proofs and Derivations
A.1 Lemmas
Lemma 1. (Cross-entropy to Gaussian) Suppose q(x) is a probability density function with mean
μq and covariance matrix Σq andp(x) = N(x∣μ, Σ) is a Gaussian distribution, then the cross-
entropy between q andP is equal to the cross-entropy between N(x∣μq, Σq) andP, i.e.,
H(q,p) = H(N(x∣μq, Σq),p)
=2 log((2n尸1 ςI) + 2 tMEqE-D + 2(μq - 0>£T(4q - μ) .
Proof.
(x — μ)>Σ-1(x — μ)
1-21-21-21-2
====
2
H(q,P) = -Eq(X) logP(X) = -Eq(X) log 〃C 1 dr exP(-
V(2n)d|E|
2
= 2log((2∏)d
= 2log((2∏)d
E|) + 1 Eq(X)(X - μ)>ET(X	-μ)	
E|) + 2Eq(X) tr((x - μ)(x -	μ)>∑-1)	
E|) + 1tr(Eq(X) [(X - μ)(X ―	μ)>] ∑-1)	
E|) + 1tr(Eq(X) [(X - μq)(X	一 μq)> + (μq -	-μ)(μq - μ)>] ςT)
EI) + 2 tr([Eq + (μq - μ)(μq	,—μ)>] ∑-1)	
EI) + 2 tr(EqE-I) + 2 tr((μ	q - μ)(μq - μ)	>E-1)
ςI) + 2 tr(EqE-I) + 2(μq -	〃)>：ST(〃q -	μ)
1 -
)
=H(N(x∣μq, Σq),p).
□
Lemma 2. (KL to Gaussian) Suppose q(x) is a probability density function with mean μq and
COVarianCe matrix Σq andp(x) = N(x∣μ, Σ) is a Gaussian distribution, then
DκL(q∣∣p) = DKL(N(χ∣μq, ∑q )∣∣p) + H (N (χ∣μq, ∑q)) - H (q),
where H (∙) denotes the entropy of a distribution.
Proof. According to Lemma 1, We have H(q,p) = H(N(x∣μq, Σq),p). Thereby,
DκL(q∣∣p) = H (q,p) - H (q) = H (N (χ∣μq, ∑q ),p) - H (q)
= H(N(x∣μq, Σq ),p) - H (N(x∣μq, Σq )) + H (N (x|〃q, Σq ))- H (q)
= DKL(N(x∣μq, Σq)||p) + H(N(x∣μq, Σq))- H(q).
□
Lemma 3. (Equivalence between the forward and reverse Markov property) Suppose q(x0:N) =
N
q(x0)	q(xn|xn-1) is a Markov chain, then q is also a Markov chain in the reverse direction,
n=1
N
i.e., q(x0:N) = q(xN) Q q(xn-1|xn).
n=1
13
Published as a conference paper at ICLR 2022
Proof.
q(Xn-1∣Xn,…，XN )
q(Xn-1, Xn,…，XN)
q(xn, ∙∙∙ , XN )
N
q(Xn-1, Xn)	Q	q(Xi|Xi-1)
i=n+1
N
q(Xn)	q(Xi|Xi-1)
i=n+1
q (Xn-1 |Xn).
N
Thereby, q(xo：N) = q(xN) ∏ q(xn-ι∣Xn).	□
n=1
Lemma 4. (Entropy of a Markov chain) Suppose q(X0:N) is a Markov chain, then
NN
H(q(X0:N)) = H(q(XN)) +	EqH(q(Xn-1|Xn)) = H(q(X0)) +	EqH(q(Xn|Xn-1)).
n=1	n=1
Proof. According to Lemma 3, we have
NN
H(q(X0:N)) = -Eqlogq(XN)	q(Xn-1 |Xn) = -Eq log q(XN) -	Eq log q(Xn-1|Xn)
n=1	n=1
N
=H(q(XN)) +	EqH(q(Xn-1 |Xn)).
n=1
N
Similarly, we also have H(q(xo：N)) = H(q(xo)) + P EqH(q(xn∣Xn-ι)).	□
n=1
Lemma 5. (Entropy of a DDPM forward process) Suppose q(X0:N) is a Markov chain and
q(xn | xn-1 ) = N(Xn | √αnxn-1, BnI), then
dN
H(q(X0:N)) = H(q(X0)) + 2Σlog(2πeβn).
n=1
Proof. According to Lemma 4, we have
N	Nd
H(q(X0:N)) = H(q(X0)) + XEqH(q(Xn∣Xn-i)) = H(q(X0)) + X 2log(2∏eβn).
n=1	n=1
□
Lemma 6. (Entropy of a conditional Markov chain) Suppose q(X1:N |X0) is Markov, then
N
H(q(X0:N)) = H(q(X0)) +EqH(q(XN|X0)) +	EqH(q(Xn-1|Xn, X0)).
n=2
Proof. According to Lemma 4, we have
H (q(X0:N)) =H(q(X0)) + EqH(q(X1:N|X0))
N
=H(q(X0)) + EqH(q(XN|X0)) +	EqH(q(Xn-1|Xn,X0)).
n=2
□
14
Published as a conference paper at ICLR 2022
Lemma 7. (Entropy of a generalized DDPM forward process) Suppose q(x1:N |x0) is Markov,
q(xN|xo) is Gaussian with covariance BnI and q(xn-ι∣Xn, x°) is Gaussian with covariance λnbI,
then
d, , d d, , ^ d -， d . d H一 ,	…
H(q(x0:N)) = H(q(xo)) + 2 log(2πeβN) + 2 £log(2ne》n).
n=2
Proof. Directly derived from Lemma 6.	□
Lemma 8. (KL to a Markov chain) Suppose q(x0:N) is a probability distribution and p(x0:N) =
N
p(xN)	p(xn-1 |xn) is a Markov chain, then we have
n=1
N
EqDKL(q(x0:N-1|xN)||p(x0:N-1|xN)) =	EqDKL(q(xn-1|xn)||p(xn-1|xn)) + c,
n=1
N
where c =	EqH(q(xn-1|xn)) - EqH(q(x0:N-1 |xN)) is only related to q. Particularly, if
n=1
q(x0:N) is also a Markov chain, then c = 0.
Proof.
EqDKL(q(x0:N-1|xN)||p(x0:N-1|xN)) = -Eq logp(x0:N-1|xN) - EqH(q(x0:N-1|xN))
N
= -	Eq logp(xn-1 |xn) - EqH(q(x0:N-1|xN))
n=1
NN
=	Eq DKL (q(xn-1 |xn )||p(xn-1 |xn )) +	Eq H (q(xn-1 |xn )) - Eq H (q(x0:N -1 |xN )).
n=1	n=1
N
Letc =	EqH(q(xn-1|xn)) - EqH(q(x0:N-1|xN)), then
n=1
N
EqDKL(q(x0:N-1|xN)||p(x0:N-1|xN)) =	EqDKL(q(xn-1|xn)||p(xn-1|xn)) + c.
n=1
If q(x0:N) is also a Markov chain, according to Lemma 4, we have c = 0.
□
Lemma 9. (The optimal Markov reverse process with Gaussian transitions is equivalent to moment
N
matching) Suppose q (x0:N) is probability density function and p(x0:N) =	p(xn-1|xn)p(xN)
n=1
is a Gaussian Markov chain with p(xn-ι∣xn,) = N (xn-ι∣μn(xn), σ* I), then the joint KL opti-
mization
min	DKL(q(x0:N)||p(x0:N))
{μn,σn }N=1
has an optimal solution
* / ʌ _ -∏7	Γ ]	*2 _ -∏7	tr(Covq(Xn-ι∣Xn)[xn-l])
μn(Xn)= Eq(Xn-1 ∣Xn) [xn-1], σn = Eqn(Xn)	d	，
which match the first two moments ofq(xn-1|xn). The corresponding optimal KL is
dN
DκL(q(x0:N)∣∣P*(X0:N)) = H(q(XN),p(xn)) + 2 Elog(2πeσn2) - H(q(xo：N)).
n=1
Remark. Lemma 9 doesn’t assume the form ofq(x0:N), thereby it can be applied to more general
Gaussian models, such as multi-layer VAEs with Gaussian decoders (Rezende et al., 2014; Burda
et al., 2015). In this case, q(x1:N |x0) is the hierarchical encoders of multi-layer VAEs.
15
Published as a conference paper at ICLR 2022
Proof. According to Lemma 8, we have
N
DKL(q(x0:N)||p(x0:N)) = DKL(q(xN)||p(xN)) +	EqDKL(q(xn-1 |xn)||p(xn-1 |xn)) + c,
n=1
N
where c =	EqH(q(xn-1|xn)) - EqH(q(x0:N-1 |xN)).
n=1
Since EqDκL(q(xn-ι∣Xn)∣∣p(xn-ι∣Xn)) is only related to μn(∙) and 0片,thejoint KL optimization
is decomposed into n independent optimization sub-problems:
min EqDKL(q(xn-1|xn)||p(xn-1|xn)),	1 ≤ n ≤ N.
μn,σn
According to Lemma 2, we have
EqDKL (q (xn-1 |xn )||p(xn-1 |xn ))
=EqDKL (N (xn-1 |Eq(xn-1 |xn) [xn-1], Covq(xn-1 |xn) [xn-1])||p(xn-1 |xn ))
+ EqH(N (xn-1 |Eq(xn-1 |xn) [xn-1], Covq(xn-1 |xn) [xn-1])) - Eq H (q (xn-1 |xn))
=F (σn)+G(σn, μn)+C
where
F (σn ) = 1 (σ-2Eq tr(Covq(Xn-ι∣Xn)[xn-1]) + d log σE ),
G(σn, μn) = $σn 2Eq ||Eq(Xn-i ∣Xn) [xn-1] - μn(xn)	,
and C = d log(2π) - EqH(q(xn-ι∣Xn)). The optimal μn(xn) is achieved when
11Eq(Xn-1 ∣Xn) [xn-1] - μn(xn)“2 = 0∙
Thereby, μ"xn) = Eq(Xn-ι∣χn)[xn-ι]. In this case, G(σηn, μ1) = 0 and we only need to consider
F(°n) for the optimal σn2. By calculating the gradient of F, We know that F gets its minimum at
*2 tr tr(Covq(χn-ι∣χn) [xn-i])
σn = Eq-----------d-----------.
In the optimal case, F(σ* = d (1 + log σn2) and
Eq DKL (q(Xn-1∣Xn)∣∣P*(Xn-1 ∣Xn)) = d log(2∏eσn2) - Eq H (q(Xn-11 Xn )).
As a result,
DKL(q(x0:N)||p*(x0:N))
Nd	N
=DκL(q(xN)∣∣p(xn)) + X 2log(2πeσn2) - XEqH(q(xn-i∣Xn))
n=1	n=1
N
+ X EqH(q(xn-1|xn)) - (H(q(x0:N)) - H(q(xN)))
n=1
Nd
=H(q(xN),p(xn)) + £ 2 log(2∏eσn2) - H(q(xo：N)).
n=1
□
Lemma 10. (Marginal score function) Suppose q(v, w) is a probability distribution, then
▽w log q(w) =Eq(v∣w)Vw log q(w∣v)
16
Published as a conference paper at ICLR 2022
Proof. According to Eq(v∣w)Vw log q(v∖w) = J Vwq(v∖w)dv = Vw J q(v∖w)dv = 0, We have
NW log q(w) =VW log q(w) + Eq(v∣w) Vw log q(v∖w)
=Eq(VIW)VW log q(v, w) = Eq(v∣w) VW log q(w∖v).
□
Lemma 11. (Score representation of conditional expectation and covariance) Suppose q(v, w)
q(v)q(w∖v), where q(w∖v) = N(w∖√ɑv, βI), then
Eq(v∣w)[v] = -^(w + βVw log q(w)),
e	β	、丁
Eq(W)CoVq(v∣w) [v] = a (l - βEq(w) [Vw log q(w)Vw log q(w)>]),
Eq(W)
tr(CoVq(v∣W)[v]) _ β
1 - βEq(W)
∖∖Vw logq(w)∖∖2
d
α
d
Proof. According to Lemma 10, we have
Vw log q(w) = Eq(v∣w)Vw log q(w∖v) = -Eq(v∣w) W ^a .
β
Thereby, Eq(v∣w)[v] = %(W + βVw log q(w)). Furthermore, we have
β2	W — ʌ/ɑv
Eq(W) COVq(V∣w)[v] = ^α Eq(W)Covq(v∣w)[	β ]
β2v	&	<w -√ɑv∖∕w -	√αv λτ	W	Γw	-√αvι1,7	Γw -	√αv ιτA
=—Eq(W) IEq(VIW)(---β----)(----β---) - Eq(V∣W)[-β----JEq(V∣w)[--β----] 1
β2 /Imm	> τ	Tm	、>'
=—(β2Eq(V)Eq(WIV)(W - √αv)(w - √αv)τ - Eq(W)Vw log q(w)Vw log q(w)τ J
β2 / 1 m C	m	，	，	，	，	、T\
=—(β2Eq(V)CoVq(w∣V)w - Eq(W)VW log q(w)Vw log q(w)τ J
β2	1	τ
=—(β2 Eq(V)βI - Eq(W)Vw log q(w)Vw log q(w)τJ
=βα GI - Eq(W)Vw log q(w)Vw log q(w)τ) = α(I - βEq(w)Vw log q(w)Vw log q(w)τ).
Taking the trace, we have
Eq(W) tr(CoVq/W)M = β (1 - βEq(w) "Vw log q(M∖∖2 ).
v 7	d	a	八/	d
□
Lemma 12. (Bounded covariance ofa bounded distribution) Suppose q(x) is a bounded distribution
in [a, b]d, then (COVd(X)H) ≤ (与a)2.
Proof.
tr(CoVq(χ)[x]) = tr(CoVq(χ)[x -喏])=Eq(χ)∖∖x - a+b∖∖2-∖∖Ex - a+b∖∖2
dd	d
≤ Eq(X)∖∖x - a+b ∖∖2 ≤ ( b - α )2
≤	d	≤( 2 ) .
□
17
Published as a conference paper at ICLR 2022
Lemma 13. (Convert the moments of q(xn-1 |xn) to moments of q(x0|xn)) The optimal solution
μ"xn) and σn2 to Eq. (4) can be represented by the first two moments of q(x0∣Xn)
μn(Xn) = μn(xn, Eq(Xo|Xn)XO)
丁 *2
σn
2
Eq(xn)
tr(Covq(x0 |xn) [x0])
d
where qn(xn) is the marginal distribution of the forward process at timestep n andd is the dimension
of the data.
Proof. According to Lemma 9, the optimal μ*n and σn2 under KL minimization is
..*	、- IP	%	]	rr*2 _ F	tr(Covq(Xn-11Xn)[XnT])
μn(Xn)= Eq(Xn-i|Xn)[Xn-1],	σn = Eqn(Xn)	'
We further derive μn Since μn(xn, xo) is linear w.r.t. xo, We have
μn (Xn) = Eq(Xn-1 ∣Xn) [xn-l] = Eq(X0 ∣Xn)Eq(Xn-1 |x.
=Eq(X0∣Xn)μ n(Xn, X0 ) = μ n(Xn, Eq(X0 |Xn)XO) .
n,X0) [Xn-1]
Then we consider σn*2. According to the law of total variance, we have
Covq(Xn-1 |Xn) [Xn-1] = Eq(X0|Xn)Covq(Xn-1 |Xn,X0) [Xn-1] + Covq(X0|Xn)Eq(Xn-1 |Xn,X0) [Xn-1]
= λnI + CoVq(X0∣Xn)μ n(Xn, X0) = λ21 + (Pan-I - VZe n-1 - Xn - ʌ I=1 )2 CoVq(X0 ∣Xn) [xO] ∙
βn
Thereby,
*2	tr(Covq(Xn-1|Xn)[Xn-1])
σn = Eqn (Xn)	d
tr(Covq(X0|Xn)[x0])
(Xn)	d
□
A.2 Proof of Theorem 1
Theorem 1. (Score representation of the optimal solution to Eq. (4), proof in Appendix A.2)
The optimal solution μn(xn) and σ*2 to Eq. (4) are
μn(Xn) = μn ( Xn, -‰(Xn + ENXn 1。2 9n(Xn))],
∖	√Qn	)
(6)
*2
σn
-λn I (1-βnEqn(Xn)
l∣Vχn log qn(Xn)∣∣2
(7)
d
where qn (xn) is the marginal distribution of the forward process at the timestep n and d is the
dimension of the data.
Proof. According to Lemma 11 and Lemma 13, we have
*/	、	/ 口	、	/	1	/	F L I /	、、、
Mn(Xn) = μ n(Xn, Eq(xo∣Xn)Xθ)=μ n(Xn, ʒ^(Xn + β n^Xn 1°g q(Xn))),
√Qn
18
Published as a conference paper at ICLR 2022
and
)
A.3 Proof of Theorem 2
Theorem 2. (Bounds of the optimal reverse variance, proof in Appendix A.3)
σn*2 has the following lower and upper bounds:
λ2n ≤ σn*2 ≤ λ2n +
(11)
□
2
If we further assume q(x0) is a bounded distribution in [a, b]d, where d is the dimension of data,
then σn*2 can be further upper bounded by
σn*2 ≤ λ2n +
2
(12)
Proof. According to Lemma 13 and Theorem 1, we have
λ2n ≤ σn*2 ≤
If we further q(x0) assume is a bounded distribution in [a, b]d, then q(x0|xn) is also a bounded
distribution in [a, b]d. According to Lemma 12, we have
Eq(xn)
tr(Covq(x0 |xn) [x0])
≤ (b-a )2.
d
Combining with Lemma 13, we have
丁 *2
σn
—
□
A.4 Proof of the Decomposed Optimal KL
Theorem 3. (Decomposed optimal KL, proof in Appendix A.4)
The KL divergence between the shorter forward process and its optimal reverse process is
dK
DκL(q(xo, Xτι,…,Xτκ)∣∣P*(X0, Xti,…,Xτκ)) = 2 EJ(Tk-I,Tk) + c,
k=2
* 2
σ ।
where J(τk-∖,Tk) = log 入7-1 Tk and C is a constant unrelated to the trajectory τ.
τk-1lτk
19
Published as a conference paper at ICLR 2022
Proof. According to Lemma 7 and Lemma 9, we have
DκL(q(xo, Xτι,…，Xτκ)∣∣P*(X0, Xτι,…，Xtk))
=EqDκL(q(x0∣Xτ1,…，Xtk ) ||p* (x0 ∣Xl)) + DkL(9(Xti ,…，Xtk )∣∣P*(Xti ,…，Xtk ))
=Eq DκL(q(x0∣Xτι,…，XTK )∣∣p*(xo∣Xl)) + H (q(xN ),p(xn ))
dK
+ 2 E log(2πeστk-1 ITk)- H(q(xτι, …，XTN ))
k=2
dK
=-Eqlogp*(xo∣xι) + HIq(CN),p(xn)) + 2 Elog(2πeσT2-1∣τk) - H(q(xo, Xτ1,…，XTK))
k=2
dK
=-EqlogP*(x0∣xι) + H(q(xN),p(xn)) + 2 Elog(2πeσT2-∣Tk)
k=2
d	— d ɪK	C
-H(q(XO))- 2 log(2πeβN) - 2∑Slog(2πeλτk-1∣τk)
k=2
......................d XK	σ*2 .Ic	d	-
=-Eq log P (xο∣xι) + H (q(xN ),p(xn )) + 2 E log λ2--H (q(xο)) - 2 log(2∏eβ N).
k=2	Tk-1 ITk
σT2	∣τ
Let J(τk-ι,τk) = log λ2k-1 S and C = -Eq logP*(xο∣xι) + H(q(xN),p(xn)) - H(q(xο))-
_	τk-1 |Tk
d log(2∏eβN), then C is a constant unrelated to the trajectory T and
dK
DKL (q(x0) xτι, ∙∙∙ , XTK ) ||p (X0, xτι, ∙∙∙ , XTK )) = 5 J J J(Tk—1,Tk ) + C.
k=2
□
A.5 The Formal Result for Section 5 and its Proof
Here we present the formal result of the relationship between the score function and the data covari-
ance matrix mentioned in Section 5.
Proposition 1. (Proof in Appendix A.5) The expected conditional covariance matrix of the data
distribution is determined by the score function Nxn log qn(xn) asfollows:
Eq(Xn)Covq(xo∣Xn)[xθ] = βn (I - βnEqn (xn) [Vxn log qn(Xn)Vxn log qn(Xn)>]) ,	(15)
αn
which contributes to the data covariance matrix according to the law of total variance
Covq(x0) [X0] = Eq(xn)Covq(x0 Ixn) [X0] + Covq(xn) Eq(x0 Ixn) [X0].	(16)
Proof. Since q(xn∣xο) = N(xn∣√α^xο, βnI), according to Lemma 11, we have
口 厂	一节…LI /	、「 I /	、>、
Eq(Xn)Covq(x0∣xn) [x0] = ^~(I - βnEqn(xn) Vxnlog qn(Xn)Vxnlog qn(Xn) ).
αn
The law of total variance is a classical result in statistics. Here we prove it for completeness:
Eq(xn)Covq(x0Ixn) [X0] + Covq(xn)Eq(x0Ixn) [X0]
=Eq(Xn) (Eq(X0∣xn)χ0χ0 - Eq(X0∣xn) [x0]Eq(x0|xn) [x0])
+ Eq(Xn) (Eq(X0∣Xn) [x0]Eq(X0∣Xn) [x0] ) - (Eq(Xn)Eq(X0 ∣ X n ) lx。] ) (Eq(Xn)Eq(X0 ∣ X n ) Ix 0])
=Eq(X0 ) X0X0 - Eq(X0 ) [X0]Eq(X0 ) [X0] = Covq(X0 ) [X0].
□
20
Published as a conference paper at ICLR 2022
Algorithm 1 The DP algorithm for the least-cost-path problem (Watson et al., 2021)
1:	Input: Cost function J(s, t) and integers K, N (1 ≤ K ≤ N)
2:	Output: The least-cost-trajectory 1 = τι < •…< τκ = N
3:	C - {∞}1≤k,n≤N, D - {-1}1≤k,n≤N
4:	C [1, 1] - 0
5:	for k = 2 to K do	. Calculate C and D
6： CJ — {C[k - 1,s] + J(S, n)}1≤s≤N,k≤n≤N
7:	C[k, k :] 一 (min(CJ[:, k]), min(CJ[:, k + 1]),…，min(CJ[:, N]))
8:	D[k, k :] J (arg min(CJ[:, k]), argmin(CJ[:, k + 1]),…，arg min(CJ[:, N]))
9:	end for
10:	τK = N
11:	for k = K to 2 do	. Calculate τ
12:	τk-1 J D[k, τk]
13:	end for
14:	return τ
B The DP Algorithm for the Least-Cost-Path Problem
Given a cost function J(s, t) with 1 ≤ s < t and k, n ≥ 1, we want to find a trajectory 1 =
τι < •…< Tk = n of k nodes starting from 1 and terminating at n, s.t., the total cost J(τ1,τ2) +
J(τ2,τ3) + ,…+ J(τk-ι, Tk) is minimized. Such a problem can be solved by the DP algorithm
proposed by Watson et al. (2021). Let C[k, n] be the minimized cost of the optimal trajectory, and
D[k, n] be the τk-1 of the optimal trajectory. For simplicity, we also let J(s, t) =
0 n=1
Then for k = 1, we have C[1, n] =	∞ N ≥ n > 1 and D[1, n] = -1
represent undefined values for simplicity). For N ≥ k ≥ 2, we have
∞ for s ≥ t ≥ 1.
(here ∞ and -1
C[k, n] =
D[k, n] =
∞	1≤n<k
min	C[k - 1, s] + J(s, n) = min C[k - 1, s] + J(s, n) N ≥ n ≥ k,
k-1≤s≤n-1	1≤s≤N
-1	1 ≤n< k
arg min C[k - 1, s] + J(s, n) = argminC[k - 1, s] + J(s, n) N ≥ n ≥ k.
k-1≤s≤n-1	1≤s≤N
As long as D is calculated, we can get the optimal trajectory recursively by τK = N and τk-1
D[k, τk]. We summarize the algorithm in Algorithm 1.
C The B ounds of the Optimal Reverse Variance Constrained on a
Trajectory
In Section 4, we derive the optimal reverse variance constrained on a trajectory. Indeed, the optimal
reverse variance can also be bounded similar to Theorem 2. We formalize it in Corollary 1.
Corollary 1. (Bounds of the optimal reverse variance constrained on a trajectory)
σT2- ι∣τfc has the following lower and upper bounds:
λTk-ι∣Tk ≤ στk-ι∣Tk ≤ λTk-ι∣Tk +
(「
∖V aTk∣Tk-ι
Ifwe further assume q(x0) is a bounded distribution in [a, b]d, where d is the dimension of data,
then σn2 can befurther upper bounded by
*2
σTk-1∣Tk
21
Published as a conference paper at ICLR 2022
D Simplified Results for the DDPM Forward Process
The optimal solution μn(xn) and σn2 in Theorem 1 and the bounds of σn2 in Theorem 2 can be
directly simplified for the DDPM forward process by letting λ2n = βn . We list the simplified results
in Corollary 2 and Corollary 3.
Corollary 2. (Simplified score representation of the optimal solution)
When λn = βn, the optimal solution μn(xn) and σn to Eq. (4) are
μn(Xn) = ^^(Xn + βnVχn log qn(Xn)),
αn
*2	βn 门 R 党	||Vxn log qn(Xn) ||2、
σn =T(I - βnEqn(xn)---------------d---------J
αn	d
Corollary 3. (Simplified bounds of the optimal reverse variance)
When λn = βn, σn2 has thefollowing lower and upper bounds:
*2	βn
βn ≤ σn ≤ —.
Ifwe further assume q(X0) is a bounded distribution in [a, b]d, where d is the dimension of data,
then σn*2 can be further upper bounded by
"*2 V S , αn-1β2 (b - a
σn ≤βn + IT E
As for the shorter forward process defined in Eq. (13), it also includes the DDPM as a special case
、2	β β	BT
when λ2k_1∣τk = βτk-1∣τk, where βτk-1∣τk := -^-βτk∣τk-1. SimiIar to Corollary 2, the optimal
mean and variance of its reverse process can also be simplified for DDPMs by letting X鼠_皿 =
βτk-ι ∣τk. Formally, the simplified optimal mean and variance are
1 Vχτk log qτk(XTk)),
“Vχτk log qτk (XTk )||2
μTk-1∣Tk (XTk ) =	Ia	,	: (XTk + βτk |Tk-1
αTk |Tk-1
*2	βTk |Tk-1
σTk-1∣Tk =	(I - βτklτk-1 EqTk (XTk 厂
αTk |Tk-1
).
d
Besides, Theorem 3 can also be simplified for DDPMs. We list the simplified result in Corollary 4.
Corollary 4. (Simplified decomposed optimal KL)
When λ2n = βn, the KL divergence between the subprocess and its optimal reverse process is
dK
DκL(q(X0, Xτι,…,XTK )∣∣P*(X0, Xti ,…,XTK )) = 2 EJ (Tk-I ,Tk ) + C
k=2
7	"	ʌ 1 n «	*	||VXTk log qτk (XTk )l∖
where J(Tk-ι,Tk) = log(1 - βτ%∣τk-ιEqTk(XTk)------k——d------------),
and c is a constant unrelated to the trajectory T.
E Extension to Diffusion Process with Continuous Timesteps
Song et al. (2020b) generalizes the diffusion process to continuous timesteps by introducing a
stochastic differential equation (SDE) dz = f (t)zdt + g(t)dw. Without loss of generality, we
consider the parameterization of f(t) and g(t) introduced by Kingma et al. (2021)
f(t)
IdlogOt
2	dt
g(t)2=T
dlog Ot 方
FΓβt,
—
22
Published as a conference paper at ICLR 2022
where a,t and βt are scalar-valued functions satisfying some regular conditions (Kingma et al., 2021)
with domain t ∈ [0, 1]. Such a parameterization induces a diffusion process on continuous timesteps
q(x0, z[0,1] ), s.t.,
q(zt∣χo) = N(zt∣√αtxo,βtl),	∀t ∈ [0,1],
q(zt∖zs) = N(Zt∣√OφZs,βt∣sI),	∀0 ≤ s<t ≤ 1,
where at∣s := ^tE and βt∣s := βt — αt∣sβs.
E.1 Analytic Estimate of the Optimal Reverse Variance
Kingma et al. (2021) introduce p(zs∖zt) = N(zs∖μs∣t(zt), σj∣t) (S < t) to reverse from timestep
t to timestep s, where σj∣t is fixed to βsβs∣t. In contrast, We show that σj∣t also has an optimal
solution in an analytic form of the score function under the sense ofKL minimization. According to
Lemma 9 and Lemma 11, we have
区It(Zt) = Eq(zs∣zt)[zs] = ,-----(zt + βt∣s Vzt log q(Zt)),
αt∣s
*2	雨 tr(Covq(Zs∣zt)[zsD	βt∣s 门 o 雨	\\Vzt log q(Zt)Il2、
σs∣t = Eq---------d----------=疏(1 - βt∣sEq(Zt)------------d--------).
Thereby, both the optimal mean and variance have a closed form expression w.r.t. the score function.
In this case, we first estimate the expected mean squared norm of the score function by Γt for
t ∈ [0, 1], where
γ _E	∖∖st(zt)∖∖2
t = (I(Zt)	d .
Notice that there are infinite timesteps in [0, 1]. In practice, we can only choose a finite number of
timesteps 0 = tι < •…<tN = 1 and calculate Γtn. For a timestep t between trb-ι and tn, We can
use a linear interpolation between Γtn-1 and Γtn. Then, we can estimate σs*∣2t by
σ2∣t =	(I - βt∣srt).
αt∣s
E.2 Analytic Estimation of the Optimal Reverse Trajectory
Now we consider optimize the trajectory 0 = τι < •… < τκ = 1 in the sense of KL minimization
min DκL(q(xo, Zτι,…，ZTK )∖∖p*(xo, Zτι,…,ZTK)).
T1,…，TK
Similar to Theorem 3, the optimal KL is
dK
DκL(q(x0, Zτι,…，ZTK )∖∖p*(x0, Zτι,…，ZTK )) = 2 EJ (Tk-1,τQ + c,
k=2
where J(Tk-1, Tk) = log(1 —/丁广∣τk-ιEq ∣"zTk lodq(ZTk )∣∣ ) and C is unrelated to T. The difference
is that J(s, t) is defined on a continuous range 0 ≤ s < t ≤ 1 and the DP algorithm is not directly
applicable. However, we can restrict J (s,t) on a finite number of timesteps 0 = tι < •…<tN = 1.
Then we can apply the DP algorithm (see Algorithm 1) to the restricted J(s, t).
23
Published as a conference paper at ICLR 2022
F Experimental Details
F.1 Details of Score-Based Models
The CelebA 64x64 pretrained score-based model is provided in the official code (https://
github.com/ermongroup/ddim) of Song et al. (2020a). The LSUN Bedroom pretrained
score-based model is provided in the official code (https://github.com/hojonathanho/
diffusion) of Ho et al. (2020). Both of them have a total of N = 1000 timesteps and use the
linear schedule (Ho et al., 2020) as the forward noise schedule.
The ImageNet 64x64 pretrained score-based model is the unconditional Lhybrid model provided
in the official code (https://github.com/openai/improved-diffusion) of Nichol
& Dhariwal (2021). The model includes both the mean and variance networks, where the mean
network is trained with Eq. (5) as the standard DDPM (Ho et al., 2020) and the variance network is
trained with the Lvb objective. We only use the mean network. The model has a total of N = 4000
timesteps and its forward noise schedule is the cosine schedule (Nichol & Dhariwal, 2021).
The CIFAR10 score-based models are trained by ourselves. They have a total of N = 1000
timesteps and are trained with the linear forward noise schedule and the cosine forward noise sched-
ule respectively. We use the same U-Net model architecture to Nichol & Dhariwal (2021). Follow-
ing Nichol & Dhariwal (2021), we train 500K iterations with a batch size of 128, use a learning rate
of 0.0001 with the AdamW optimizer (Loshchilov & Hutter, 2017) and use an exponential mov-
ing average (EMA) with a rate of 0.9999. We save a checkpoint every 10K iterations and select
the checkpoint according to the FID results on 1000 samples generated under the reverse variance
σn2 = βn and full timesteps.
F.2 Log-likelihood and Sampling
Following Ho et al. (2020), We linearly scale the image data consisting of integers in {0,1,…，255}
to [-1, 1], and discretize the last reverse Markov transition p(x0|x1) to obtain discrete log-
likelihoods for image data.
Following Ho et al. (2020), at the end of sampling, we only display the mean ofp(x0|x1) and discard
the noise. This is equivalent to setting a clipping threshold of zero for the noise scale σ1. Inspired
by this, when sampling, we also clip the noise scale σ? of p(x1∣x2), such that E∣σ2d ≤ 短y,
where is the standard Gaussian noise and y is the maximum tolerated perturbation of a channel. It
improves the sample quality, especially for our analytic estimate (see Appendix G.4). We clip σ2 for
all methods compared in Table 2, and choose y ∈ {1, 2} according to the FID score. We find y = 2
works better on CIFAR10 (LS) and CelebA 64x64 with Analytic-DDPM. For other cases, we find
y = 1 works better.
We use the official implementation of FID to pytorch (https://github.com/mseitzer/
pytorch-fid). We calculate the FID score on 50K generated samples on all datasets. Follow-
ing Nichol & Dhariwal (2021), the reference distribution statistics are computed on the full training
set for CIFAR10 and ImageNet 64x64. For CelebA 64x64 and LSUN Bedroom, the reference dis-
tribution statistics is computed on 50K training samples.
F.3 CHOICE OF THE NUMBER OF MONTE CARLO SAMPLES AND CALCULATION OF Γ
We use a maximal M without introducing too much computation. Specifically, we set M = 50000
on CIFAR10, M = 10000 on CelebA 64x64 and ImageNet 64x64 and M = 1000 on LSUN
Bedroom by default without a sweep. All of the samples are from the training dataset. We use the
default settings of M for all results in Table 1, Table 2 and Table 3.
We only calculate Γ in Eq. (8) once for a pretrained model, and Γ is reused during inference under
different settings (e.g., trajectories of smaller K) in Table 1, Table 2 and Table 3.
24
Published as a conference paper at ICLR 2022
F.4 Implementation of the Even Trajectory
We follow Nichol & Dhariwal (2021) for the implementation of the even trajectory. Given the
number of timesteps K of a trajectory, We firstly determine the stride a = KK-I. Then the kth
timestep is determined as round(1 + a(k - 1)).
F.5 Experimental Details of Table 3
In Table 3, the results of DDPM, DDIM and Analytic-DPM are based on the same score-
based models (i.e., those listed in Section F.1). We get the results of Improved DDPM by run-
ning its official code and unconditional Lhybrid models (https://github.com/openai/
improved-diffusion). As shoWn in Table 4, on the same dataset, the sizes as Well as the
averaged time of a single function evaluation of these models are almost the same.
Table 4: Model size and the averaged time to run a model function evaluation With a batch size of
10 on one GeForce RTX 2080 Ti.
CIFAR10	CelebA 64x64 LSUN Bedroom
DDPM, DDIM, Analytic-DPM 200.44 MB / 29 ms 300.22 MB / 50 ms 433.63MB/438ms
Improved DDPM 200.45 MB / 30 ms Missing model 433.64 MB / 439 ms
The DDPM and DDIM results on CIFAR10 are based on the quadratic trajectory folloWing Song
et al. (2020a), Which gets better FID than the even trajectory. The Analytic-DPM result is based on
the DDPM forWard process on LSUN Bedroom, and based on the DDIM forWard process on other
datasets. These choices achieve better efficiency than their alternatives.
25
Published as a conference paper at ICLR 2022
G Additional Results
G. 1 Visualization of Reverse Variances and Variational Bound Terms
Figure 1	visualizes the reverse variances and Lvb terms on CIFAR10 with the linear forward noise
schedule (LS). In Figure 2, we show more DDPM results on CIFAR10 with the cosine forward noise
schedule (CS), CelebA 64x64 and ImageNet 64x64.
2-14	---Bn βn —名
7 9 13
- - TT
2 222
ueLle>
22	25	28
timestep n
(b) CelebA 64x64
ωuueμe>
23	2, 2τr
timestep n
(c) ImageNet 64x64
22	25	28
timestep n
(a) CIFARI0(CS)
□ 21
500
(E-P∕sq) → E」£ q>7
(d) CIFAR10 (CS)	(e) CelebA 64x64	(f) ImageNet 64x64
Figure 2:	Comparing our analytic estimate σ/ and prior works with handcrafted variances βn and
βn . (a-c) compare the values of the variance of different timesteps. (d-e) compare the term in Lvb
corresponding to each timestep. The value of Lvb is the area under the corresponding curve.
G.2 Ablation Study on the Number of Monte Carlo Samples
We show that only a small number of Monte Carlo (MC) samples M in Eq. (8) is enough for a small
MC variance. As shown in Figure 3, the values of Γn with M = 100 and M = 50000 Monte Carlo
samples are almost the same in a single trial. To explicitly see the variance, in Figure 4 and Figure 5,
we plot the mean, the standard deviation and the relative standard deviation (RSD) (i.e., the ratio of
the standard deviation to the mean) of a single Monte Carlo sample llsn(dn)11 , Xn 〜qn(xn) and
Γn with different M respectively on CIFAR10 (LS). In all cases, the RSD decays fast as n increases.
When n is small (e.g., n = 1), using M = 10 Monte Carlo samples can ensure that the RSD ofΓn is
below 0.1, and using M = 100 Monte Carlo samples can ensure that the RSD ofΓn is about 0.025.
When n > 100, the RSD of a single Monte Carlo sample is below 0.05, and using only M = 1
Monte Carlo sample can ensure the RSD ofΓn is below 0.05. Overall, a small M like 10 and 100 is
sufficient for a small Monte Carlo variance.
Furthermore, we show that Analytic-DPM with a small M like 10 and 100 has a similar performance
to that with a large M . As shown in Figure 6 (a), using M = 100 or M = 50000 almost does not
affect the likelihood results on CIFAR10 (LS). In Table 5 (a), we show results with even smaller M
(e.g., M = 1, 3, 10). Under both the NLL and FID metrics, M = 10 achieves a similar result to that
of M = 50000. The results are similar on ImageNet 64x64, as shown in Figure 6 (b) and Table 5
(b). Notably, the expected performance of FID is almost not influenced by the choice of M .
As a result, Analytic-DPM consistently improves the baselines using a much smaller M (e.g., M =
10), as shown in Table 6.
26
Published as a conference paper at ICLR 2022
(a) CIFAR10 (LS)
(b) ImageNet 64x64
Figure 3: The value of Γn in a single trial with different number of Monte Carlo samples M .
(a) Mean
(b) Standard deviation
(c) Relative standard deviation
Figure 4:	The mean, the standard deviation and the relative standard deviation (RSD) (i.e., the ratio
of the standard deviation to the mean) of a single Monte Carlo sample llsn(χn)11 , Xn 〜qn(xn) at
different n on CIFAR10 (LS). These values are estimated by 50000 samples.
(a) Mean
(b) Standard deviation
(c) Relative standard deviation
Figure 5:	The mean, the standard deviation and the relative standard deviation (RSD) (i.e., the ratio
of the standard deviation to the mean) of Γn with different number of Monte Carlo samples M
at different n on CIFAR10 (LS). These values are directly calculated from the mean, the standard
deviation and the RSD of llsn(Xn)|| , Xn 〜qn(Xn) presented in Figure 4.
27
Published as a conference paper at ICLR 2022
(a) CIFAR10 (LS)
(b) ImageNet 64x64
Figure 6:	The curves of NLL v.s. the number of timesteps K in a trajectory with different number
of Monte Carlo samples M, evaluated under σ∖ = σ∖ and the even trajectory.
CIFAR10 (LS) andK = 25 for ImageNet 64x64.
(a) CIFAR10 (LS)
	NLL 1		FID 1
M=	1	6.220±1.126	34.05±4.97
M=	3	5.689±0.424	34.29±2.88
M=	10	5.469±0.005	33.69±2.10
M=	100	5.468±0.004	34.63±0.68
M=	50000	5.471	34.26
Table 6: The NLL and FID comparison between Analytic-DDPM with M = 10 Monte Carlo
samples and DDPM. Results are evaluated under the even trajectory on CIFAR10 (LS).
Table 5: The negative log-likelihood (NLL) and the FID results of Analytic-DPM with different
number of Monte Carlo samples M. The results with M = 1, 3, 10, 100 are averaged by 5 runs. All
results are evaluated under the DDPM forward process and the even trajectory. We use K = 10 for
(b) ImageNet 64x64
	NLL 1		FID 1
M=	1	4.943±0.162	31.59±5.11
M=	3	4.821±0.055	31.98±1.19
M=	10	4.791±0.017	31.93±1.02
M=	100	4.785±0.003	31.93±0.69
M=	10000	4.783	32.56
# timesteps K	10		25	50	100	200	400
NLL1							
Analytic-DDPM (M =	10)	5.47	4.80	4.38	4.07	3.85	3.71
DDPM		6.99	6.11	5.44	4.86	4.39	4.07
FID 1							
Analytic-DDPM (M =	10)	33.69	11.99	7.24	5.39	4.19	3.58
DDPM		44.45	21.83	15.21	10.94	8.23	4.86
G.3 Tightness of the Bounds
In Section 3.1 and Appendix C, we derive upper and lower bounds of the optimal reverse variance.
In this section, we show these bounds are tight numerically in practice. In Figure 7, we plot the
combined upper bound (i.e., the minimum of the upper bounds in Eq. (11) and Eq. (12)) and the
lower bound on CIFAR10. As shown in Figure 7 (a,c), the two bounds almost overlap under the full-
timesteps (K=N) trajectory. When the trajectory has a smaller number of timesteps (e.g., K=100),
the two bounds also overlap when the timestep τk is large. These results empirically validate that
our bounds are tight, especially when the timestep is large.
28
Published as a conference paper at ICLR 2022
timestep n
timestep τ∣c
(a) LS, K=N	(b) LS, K=100
Figure 7: The combined upper bound (UB) and the lower bound (LB) under full-timesteps (K=N)
and 100-timesteps (K=100)trajectories on CIFAR10 (LS) and CIFAR10 (CS).
timestep n	timestep τ∣e
(c) CS, K=N	(d) CS, K=100
In Figure 8, we also plot the two upper bounds in Eq. (11) and Eq. (12) individually. The upper
bound in Eq. (11) is tighter when the timestep is small and the other one is tighter when the timestep
is large. Thereby, both upper bounds contribute to the combined upper bound.
200	500	800	200	500	800	200	500	800	200	500	800
timestep n	timestep Tk	timestep n	timestep Tk
(a) LS, K=N	(b) LS, K=100	(c) CS, K=N	(d) CS, K=100
Figure 8: The upper bounds (UB) in Eq. (11) and Eq. (12) under full-timesteps (K=N) and 100-
timesteps (K=100) trajectories on CIFAR10 (LS) and CIFAR10 (CS).
To see how these bounds work in practice, in Figure 9, We plot the probability that σ∖ is clipped
by the bounds in Theorem 2 with different number of Monte Carlo samples M on CIFAR10 (LS).
For all M, the curves of ratio v.s. n are similar and the estimate is clipped more frequently when n
is large. This is as expected because when n is large, the gap between the upper bound in Eq. (12)
and the lower bound in Eq. (11) tends to zero. The results also agree with the plot of the bounds in
Figure 7. Besides, the similarity of results between different M implies that the clipping by bounds
occurs mainly due to the error of the score-based model sn(xn), instead of the randomness in Monte
Carlo methods.
timestep n
Figure 9: The probability that σ∖ is clipped by the bounds in Theorem 2 with different number of
Monte Carlo samples M on CIFAR10 (LS). The probability is estimated by the ratio of σ/ being
clipped in 100 independent trials. The results are evaluated with full timesteps K = N .
29
Published as a conference paper at ICLR 2022
G.4 ABLATION STUDY ON THE CLIPPING OF σ2 DESIGNED FOR SAMPLING
This section validates the argument in Appendix F.2 that properly clipping the noise scale σ2 in
p(x1 |x2) leads to a better sample quality. As shown in Figure 10 and Figure 11, it greatly improves
the sample quality of our analytic estimate. The curves of clipping and no clipping overlap as K
increases, since σ2 is below the threshold for a large K.
Indeed, as shown in Table 7, the clipping threshold designed for sampling in Appendix F.2 is 1 to 3
orders of magnitude smaller than the combined upper bound in Theorem 2 (i.e., the minimum of the
upper bounds in Eq. (11) and Eq. (12)) when K is small.
As shown in Figure 12, clipping σ2 also slightly improves the sample quality of the handcrafted
reverse variance σn2 = βn used in the original DDPM (Ho et al., 2020). As for the other two
variances, i.e., σ( = βn in the original DDPM and σ( = Xn = 0 in the original DDIM (Song et al.,
2020a), their σ2 generally don’t exceed the threshold and thereby clipping doesn’t affect the result.
- - - 卜」
5 0 5 0
7 5 2
→ QE
io2 ......id3
# timesteps K
5 0 5
7 5 2
→ QE
(a) CIFAR10 (LS) (b) CIFAR10 (CS)
(c) CelebA 64x64	(d) ImageNet 64x64
Figure 10:	Ablation study on clipping σ2, evaluated under Analytic-DDPM.
75
∖ ------clipping
∖ .....no clipping
IO2 IO3
# timesteps K
O O
4 2
→ QE
ioɪ ......ιd2 ......id3
# timesteps K
60
O O
4 2
→ QE
ioɪ ......ιd2 ......id3
# timesteps K
30
5 O
2 2
→ QE
IO2 IO3
# timesteps K
O 5
5 2
→ QE
(a)	CIFAR10 (LS)
(b)	CIFAR10 (CS)
(c)	CelebA 64x64
(d)	ImageNet 64x64
Figure 11:	Ablation study on clipping σ2 , evaluated under Analytic-DDIM.
'0Ι01°
Ooo
3 2 1
→ O-U-
0 .. 1 ....,.......,
IO1	IO2	IO3
# time steps K
(a)	CIFARI0(LS)
'0'0
O O
2 1
→ Ω-π-
θιo1....io2......io-
# timesteps K
(b)	CIFARIO(CS)
→ Ω-π-
o .η .....,.......  ,
IO1	IO2	IO3
# timesteps K
(c)	CelebA 64x64
Ooo
5 0 5
1 1
→ Ω-π-
io2....io3
# timesteps K
(d)	ImageNet 64x64
Figure 12:	Ablation study on clipping σ2, evaluated under DDPM with σn2 = βn.
30
Published as a conference paper at ICLR 2022
Table 7: Comparing the values of (i) the threshold in Appendix F.2 used to clip σ22 designed for sam-
pling, (ii) the combined upper bound in Theorem 2 when n = 2, (iii) the lower bound in Theorem 2
when n = 2 and (iv) our analytic estimate σ2. We show comparison results on different datasets and
different forward processes when K is small.
Model \ # timesteps K	10	25	50	100
CIFAR10 (LS)				
Threshold (y=2)	3.87 × 10-4	3.87 X 10-4	3.87 X 10-4	3.87 X 10-4
DDPM Upper bound	1.45 × 10-1	2.24 × 10-2	6.20 X 10-3	2.10 X 10-3
Lower bound	9.99 × 10-5	9.96 X 10-5	9.84 X 10-5	9.55 X 10-5
σ2	8.70 × 10-3	2.99 X 10-3	1.32 X 10-3	6.54 X 10-4
Threshold (y=1)	9.66 × 10-5	9.66 X 10-5	9.66 X 10-5	9.66 X 10-5
DDIM Upper bound	1.37 × 10-1	1.96 X 10-2	4.82 X 10-3	1.36 X 10-3
Lower bound	0	0	0	0
	σ2	8.17 × 10-3	2.54 X 10-3	9.66 X 10-4	3.73 X 10-4
CIFAR10 (CS)				
Threshold (y=1)	9.66 × 10-5	9.66 X 10-5	9.66 X 10-5	9.66 X 10-5
DDPM Upper bound	3.56 × 10-2	6.15 X 10-3	1.85 X 10-3	6.80 X 10-4
ιvι	i	1 Lower bound	4.12 × 10-5	4.10 X 10-5	4.04 X 10-5	3.89 X 10-5
σ2	3.90 × 10-3	1.28 X 10-3	5.61 X 10-4	2.75 X 10-4
Threshold (y=1)	9.66 × 10-5	9.66 X 10-5	9.66 X 10-5	9.66 X 10-5
DDIM Upper bound	3.33 × 10-2	5.22 X 10-3	1.37 X 10-3	4.18 X 10-4
Lower bound	0	0	0	0
	σ2	3.61 × 10-3	1.06 X 10-3	3.95 X 10-4	1.53 X 10-4
CelebA 64x64				
Threshold (y=2)	3.87 × 10-4	3.87 X 10-4	3.87 X 10-4	3.87 X 10-4
DDPM Upper bound	1.45 × 10-1	2.24 X 10-2	6.20 X 10-3	2.10 X 10-3
ιvι	i	1 Lower bound	9.99 × 10-5	9.96 X 10-5	9.84 X 10-5	9.55 X 10-5
σ2	4.04 × 10-3	1.54 X 10-3	7.54 X 10-4	4.06 X 10-4
Threshold (y=1)	9.66 × 10-5	9.66 X 10-5	9.66 X 10-5	9.66 X 10-5
DDIM Upper bound	1.37 × 10-1	1.96 X 10-2	4.82 X 10-3	1.36 X 10-3
-Ly-Ly uyj.	ɪ	KF Lower bound	0	0	0	0
	σ2	3.74 × 10-3	1.26 X 10-3	5.17 X 10-4	2.11 X 10-4
				
Model \ # timesteps K	25	50	100	200
ImageNet 64x64				
Threshold (y=1)	9.66 × 10-5	9.66 X 10-5	9.66 X 10-5	9.66 X 10-5
DDPM Upper bound	5.93 × 10-3	1.84 X 10-3	6.44 X 10-4	2.61 X 10-4
ιvι	i	1 Lower bound	9.85 × 10-6	9.81 X 10-6	9.72 X 10-6	9.51 X 10-6
σ2	1.40 × 10-3	6.05 X 10-4	2.77 X 10-4	1.39 X 10-4
Threshold (y=1)	9.66 × 10-5	9.66 X 10-5	9.66 X 10-5	9.66 X 10-5
DDIM Upper bound	5.46 × 10-3	1.59 X 10-3	5.03 X 10-4	1.77 X 10-4
Lower bound	0	0	0	0
	σ2	1.28 × 10-3	5.17 X 10-4	2.12 X 10-4	9.11 X 10-5
31
Published as a conference paper at ICLR 2022
G.5 Sample Quality Comparison between Different Trajectories
While the optimal trajectory (OT) significantly improves the likelihood results, it doesn’t lead to
better FID results. As shown in Figure 13, the even trajectory (ET) has better FID results. Such
a behavior essentially roots in the different natures of the two metrics and has been investigated in
extensive prior works (Ho et al., 2020; Nichol & Dhariwal, 2021; Song et al., 2021; Vahdat et al.,
2021; Watson et al., 2021; Kingma et al., 2021).
75
O 5
5 2
→ QE
IO2 10:
# timesteps K
→ QE
IO1 IO2 IO3
# timesteps K
40
20
→ QE
IO1 IO2 IO3
# timesteps K
Qgo
6 4 2
→ QE
IO2 IO3
# timesteps K
(a)	CIFAR10 (LS)
(b)	CIFAR10 (CS)
(c) CelebA 64x64	(d) ImageNet 64x64
Figure 13:	FID results with ET and OT, evaluated under Analytic-DDPM.
G.6 Additional Likelihood Comparison
We compare our Analytic-DPM to Improved DDPM (Nichol & Dhariwal, 2021) that predicts the
reverse variance by a neural network. The comparison is based on the ImageNet 64x64 model
described in Appendix F.1. As shown in Table 8, with full timesteps, Analytic-DPM achieves a
NLL of 3.61, which is very close to 3.57 achieved by predicting the reverse variance in Improved
DDPM. Besides, we also notice that the ET reduces the log-likelihood performance of Improved
DDPM when K is small, and this is consistent with what Nichol & Dhariwal (2021) report. In
contrast, our Analytic-DPM performs well with the ET.
Table 8: Negative log-likelihood (bits/dim) [ under the DDPM forward process on ImageNet 64x64.
All are evaluated under the even trajectory (ET).
Model \ # timesteps K	25	50	100	200	400	1000	4000
Improved DDPM	18.91	8.46	5.27	4.24	3.86	3.68	3.57
Analytic-DDPM	4.78	4.42	4.15	3.95	3.81	3.69	3.61
G.7 CelebA 64x64 Results with a Slightly Different Implementation of the
Even Trajectory
Song et al. (2020a) use a slightly different implementation of the even trajectory on CelebA 64x64.
They choose a different stride a = int(K), and the kth timestep is determined as 1 + a(k - 1). As
shown in Table 9, under the setting of Song et al. (2020a) on CelebA 64x64, our Analytic-DPM still
improves the original DDIM consistently and improves the original DDPM in most cases.
G.8 Comparison to other Classes of Generative Models
While DPMs and their variants serve as the most direct baselines to validate the effectiveness of
our method, we also compare with other classes of generative models in Table 10. Analytic-DPM
achieves competitive sample quality results among various generative models, and meanwhile sig-
nificantly reduces the efficiency gap between DPMs and other models.
32
Published as a conference paper at ICLR 2022
Table 9: FID ] on CelebA 64x64, following the even trajectory implementation of Song et al.
(2020a). tOriginal results in Song et al. (2020a)JOur reproduced results.
Model \ # timesteps K	10	20	50	100	1000
CelebA 64x64					
DDPM, σ = βn	33.12	26.03	18.48	13.93	5.98
DDPM, σn = βn	33.13	25.95	18.61	13.92	5.95
DDPM, σn = βn	299.71	183.83	71.71	45.20	3.26
DDPM, σn = βn	299.88	185.21	71.86	45.15	3.21
Analytic-DDPM	25.88	17.40	10.98	7.95	5.21
DDIM, σn = λn = 0t	17.33	13.73	9.17	6.53	3.51
DDIM, σn = λn = 0¢	17.38	13.72	9.17	6.51	3.40
Analytic-DDIM	12.74	9.50	5.96	4.14	3.13
Table 10: Comparison to other classes of generative models on CIFAR10. We show the FID results,
the number of model function evaluations (NFE) to generate a single sample and the time to generate
10 samples with a batch size of 10 on one GeForce RTX 2080 Ti.
Method	FIDl	NFE l	Time (s) l
Analytic-DPM, K = 25 (ours)	5.81	25	0.73
DDPM, K = 90 (Ho et al., 2020)	6.12	90	2.64
DDIM, K = 30 (Song et al., 2020a)	5.85	30	0.88
Improved DDPM, K = 45 (Nichol & Dhariwal, 2021)	5.96	45	1.37
SNGAN (Miyato et al., 2018)	21.7	1	-
BigGAN (cond.) (Brock et al., 2018)	14.73	1	-
StyleGAN2 (Karras et al., 2020a)	8.32	1	-
StyleGAN2 + ADA (Karras et al., 2020a)	2.92	1	-
NVAE (Vahdat & Kautz, 2020)	23.5	1	-
Glow (Kingma & Dhariwal, 2018)	48.9	1	-
EBM (Du & Mordatch, 2019)	38.2	60	-
VAEBM (Xiao et al., 2020)	12.2	16	-
33
Published as a conference paper at ICLR 2022
G.9 Samples
In Figure 14-17, we show Analytic-DDIM constrained on a short trajectory of K = 50 timesteps
can generate samples comparable to these under the best FID setting.
In Figure 18-21, we also show samples of both Analytic-DDPM and Analytic-DDIM constrained
on trajectories of different number of timesteps K.
(a) Best FID samples
(b) Analytic-DDIM, K = 50
Figure 14: Generated samples on CIFAR10 (LS).
34
Published as a conference paper at ICLR 2022
(a) Best FID samples
(b) Analytic-DDIM, K = 50
Figure 16: Generated samples on CelebA 64x64.
35
Published as a conference paper at ICLR 2022
(a) Analytic-DDPM, K = 10	(b) Analytic-DDPM, K = 100	(c) Analytic-DDPM, K = 1000
(d) Analytic-DDIM, K = 10	(e) Analytic-DDIM, K = 100	(f) Analytic-DDIM, K = 1000
Figure 18: Generated samples on CIFAR10 (LS).
(a) Analytic-DDPM, K = 10	(b) Analytic-DDPM, K = 100	(c) Analytic-DDPM, K = 1000
(d) Analytic-DDIM, K = 10	(e) Analytic-DDIM, K = 100	(f) Analytic-DDIM, K = 1000
Figure 19: Generated samples on CIFAR10 (CS).
36
Published as a conference paper at ICLR 2022
(d) Analytic-DDIM, K = 10	(e) Analytic-DDIM, K = 100	(f) Analytic-DDIM, K = 1000
Figure 20: Generated samples on CelebA 64x64.
(a) Analytic-DDPM, K = 25	(b) Analytic-DDPM, K = 200	(c) Analytic-DDPM, K = 4000
(d) Analytic-DDIM, K = 25	(e) Analytic-DDIM, K = 200	(f) Analytic-DDIM, K = 4000
Figure 21: Generated samples on ImageNet 64x64.
37
Published as a conference paper at ICLR 2022
H Additional Discussion
H.1 The Extra Cost of the Monte Carlo Estimate
The extra cost of the Monte Carlo estimate Γ is small compared to the whole inference cost. In fact,
the Monte Carlo estimate requires MN additional model function evaluations. During inference,
suppose we generate M1 samples or calculate the log-likelihood of M1 samples with K timesteps.
Both DPMs and Analytic-DPMs need M1K model function evaluations. Employing the same score-
based models, the relative additional cost of Analytic-DPM is MMK. As shown in Appendix G.2,
a very small M (e.g., M = 10, 100) is sufficient for Analytic-DPM, making the relative additional
cost small if not negligible. For instance, on CIFAR10, let M = 10, N = 1000, M1 = 50000 and
K ≥ 10, we obtain MMK ≤ 0.02 and Analytic-DPM still consistently improves the baselines as
presented in Table 6.
Further, the additional calculation of the Monte Carlo estimate occurs only once given a pretrained
model and training dataset, since We can save the results of Γ = (Γι,…,Γn) in Eq.(8) and reuse
it among different inference settings (e.g., trajectories of various K). The reuse is valid, because the
marginal distribution of a shorter forward process q(xo, Xτι,…,Xτκ) at timestep Tk is the same as
that of the full-timesteps forward process q(x0:N ) at timestep n = τk. Indeed, in our experiments
(e.g., Table 1,2), Γ is shared across different selections of K, trajectories and forward processes.
Moreover, in practice, Γ can be calculated offline and deployed together with the pretrained model
and the online inference cost of Analytic-DPM is exactly the same as DPM.
H.2 The Stochasticity of the Variational Bound after Plugging the Analytic
Estimate
In this part, we write Lvb as Lvb(σn2) to emphasize its dependence on the reverse variance σn2 .
When calculating the variational bound Lvb(σn2 ) (i.e., the negative ELBO) of Analytic-DPM, we
will plug σn into the variational bound and get Lvb团).Since σn is calculated by the Monte Carlo
method, Lvb(3看)is a stochastic variable. A natural question is that whether Lvb(σ^n) is a stochastic
bound of Lvb(E[σn]), which can be judged by the Jensen,s inequality if Lvb is convex or concave.
However, this is generally not guaranteed, as stated in Proposition 2.
Proposition 2. Lvb(σn2 ) is neither convex nor concave w.r.t. σn2.
Proof. Since σn2 only influences the n-th term Ln in the variational bound Lvb, where
Eq DKL (q (xn-1 |xn , x0 )||p(xn-1 |xn )) 2 ≤ n ≤ N
n	-Eqlogp(x0|x1)	n = 1	,
we only need to study the convexity of Ln w.r.t. σn2 .
When 2 ≤ n ≤ N ,
Ln = d (σj - 1 + log W + σ2Eq M(Xn, xo)- ”n(Xn)||2)
Let A = ʌn + Eq llμ(xn,x0)-μn(xn)ll2, then Ln as a function of σnn is convex when 0 < σnn < 2A
and concave when 2A < σn2 . Thereby, Lvb(σn2 ) is neither convex nor concave w.r.t. σn.	□
Nevertheless, in this paper, Lvb竭)is a stochastic upper bound of Lvb(σn2) because Lvb(σn2) is
the optimal. The bias of Lvb(σ^n) w.r.t. Lvb(σn2) is due to the Monte Carlo method as well as
the error of the score-based model. The former can be reduced by increasing the number of Monte
Carlo samples. The latter is irreducible if the pretrained model is fixed, which motivates us to clip
the estimate, as discussed in Section 3.1.
H.3 Comparison to other Gaussian models and their results
The reverse process of DPMs is a Markov process with Gaussian transitions. Thereby, it is inter-
esting to compare it with other Gaussian models, e.g., the expectation propagation (EP) with the
Gaussian process (GP) (Kim & Ghahramani, 2006).
38
Published as a conference paper at ICLR 2022
Both EP and Analytic-DPM use moment matching as a key step to find analytic solutions of
DKL (ptarget ||popt) terms. However, to our knowledge, the relation between moment matching
and DPMs has not been revealed in prior literature. Further, compared to EP, we emphasize that it
is highly nontrivial to calculate the second moment of ptarget in DPMs because ptarget involves an
unknown and potentially complicated data distribution.
In EP with GP (Kim & Ghahramani, 2006), ptarget is the product of a single likelihood factor and all
other approximate factors for tractability. In fact, the form of the likelihood factor is chosen such that
the first two moments of ptarget can be easily computed or approximated. For instance, the original
EP (Minka, 2001) considers Gaussian mixture likelihood (or Bernoulli likelihood for classification)
and the moments can be directed obtained by the properties of Gaussian (or integration by parts).
Besides, at the cost of the tractability, there is no converge guarantee of EP in general.
In contrast, ptarget in this paper is the conditional distribution q(xn-1 |xn) of the corresponding
joint distribution q(x0:N) defined by the forward process. Note that the moments of q(xn-1 |xn) are
nontrivial to calculate because it involves an unknown and potentially complicated data distribution.
Technically, in Lemma 13, we carefully use the law of total variance conditioned on x0 and convert
the second moment of q(xn-1 |xn) to that of q(x0|xn), which surprisingly can be expressed as the
score function as proven in Lemma 11.
H.4 Future Works
In our work, we mainly focus on image data. It would be interesting to apply Analytic-DPM to other
data modalities, e.g. speech data (Chen et al., 2020). As presented in Appendix E, our method can be
applied to continuous DPMs, e.g., variational diffusion models (Kingma et al., 2021) that learn the
forward noise schedule. It is appealing to see how Analytic-DPM works on these continuous DPMs.
Finally, it is also interesting to incorporate the optimal reverse variance in the training process of
DPMs.
39