Published as a conference paper at ICLR 2022
An Agnostic Approach to Federated Learning
with Class Imbalance
Zebang Shen, Juan Cervino, Hamed Hassani, Alejandro Ribeiro
Department of Electrical and Systems Engineering
University of Pennsylvania
Philadelphia, PA 19104, USA
{zebang,jcervino,hassani,aribeiro}@seas.upenn.edu
Ab stract
Federated Learning (FL) has emerged as the tool of choice for training deep mod-
els over heterogeneous and decentralized datasets. As a reflection of the experi-
ences from different clients, severe class imbalance issues are observed in real-
world FL problems. Moreover, there exists a drastic mismatch between the im-
balances from the local and global perspectives, i.e. a local majority class can be
the minority of the population. Additionally, the privacy requirement of FL poses
an extra challenge, as one should handle class imbalance without identifying the
minority class. In this paper we propose a novel agnostic constrained learning
formulation to tackle the class imbalance problem in FL without requiring fur-
ther information beyond the standard FL objective. A meta algorithm, CLIMB, is
designed to solve the target optimization problem, with its convergence property
analyzed under certain oracle assumptions. Through an extensive empirical study
over various data heterogeneity and class imbalance configurations, we showcase
that CLIMB considerably improves the performance in the minority class without
compromising the overall accuracy of the classifier, which significantly outper-
forms previous arts. In fact, we observe the greatest performance boost in the
most difficult scenario where every client only holds data from one class. The
code can be found here.
1	Introduction
Class imbalance is ubiquitous in real world supervised learning problems. Examples span from
medical applications (Lee & Shin, 2020; Roy et al., 2019; Choudhury et al., 2019), fraud detection
(Yang et al., 2019; Chan et al., 1999), to consumer based applications (Wang et al., 2021b; Wu et al.,
2020; Long et al., 2020). In these scenarios, data belonging to a subset of classes constitute a great
proportion of the population while data from the minority classes, generated by uncommon events,
are scarce (He & Garcia, 2009). Having a non-uniform number of samples per class deteriorates the
performance of the classifier in the minority class (Huang et al., 2016), resulting in low training and
testing accuracy. More importantly, unintended consequences of mistreating the minority class can
be catastrophic (Van Hulse et al., 2007) if the problem is not handled appropriately.
From the perspectives of data heterogeneity and privacy, the issue of class imbalance is even more
significant in the setting of Federated Learning (FL). Due to the heterogeneity of the local data
distributions, there can be a significant mismatch between the local and global imbalance, i.e. the
class that is a minority locally can actually be a majority class globally. Moreover, for the purpose
of privacy protection in FL, one should tackle the class-imbalance problem in an agnostic manner,
i.e. the proposed algorithms should not require the minority class to be identified.
In the centralized training setting, techniques like balanced sampling, loss re-weighting, and gra-
dient tuning have achieved many successes (Johnson & Khoshgoftaar, 2019). However, due to the
extra difficulty of handling the class imbalance problem in FL, previous arts that rely on the ex-
plicit identification of the minority class do not directly apply. While research along this line is
quite limited, a commonly used heuristic is to estimate the portion of a class using the norm of the
gradient per class. When used as proxies, these quantities are then utilized to reweight the losses
1
Published as a conference paper at ICLR 2022
corresponding to different classes (Wang et al., 2021a; Yang et al., 2020). A key drawback of (Wang
et al., 2021a) is that a subset of the client’s local dataset needs to be shared, which is not ideal for
privacy preserving purposes. Moreover, the effectiveness of such approaches degrades when there
is a notable mismatch between the local imbalance and the global imbalance (Wang et al., 2021a).
In this work, we target the most difficult yet possibly most interesting setting in FL, where there is
a significant mismatch between the local and global imbalance. Concretely, on certain clients, a mi-
nority class from a global perspective is in the majority locally. Practitioners often encounters such
a mismatch due to the highly heterogeneous data configuration in FL and the principle of locality
(Wang et al., 2021a). For example, when the local data are produced by a minority user, the corre-
sponding minority data could occupy a large portion of the local distribution. In this scenario, due
to the scarceness of the minority data from a global perspective, the corresponding underrepresented
client will usually experience poor service quality from the trained model, giving rise to potentially
severe fairness issue.
To overcome the aforementioned challenges, we propose a constrained learning formulation to han-
dle the class imbalance issue in FL while accounting for both heterogeneity and privacy. In brief, we
impose constraints on the standard FL formulation so that the empirical loss on every client should
not overly exceed the average empirical loss. Such constraints are shown to force the classifier to
account for all classes equally and hence mitigate the detrimental effect of class imbalance, under
a type of heterogeneous data configuration that captures the mismatch between the local and global
imbalance. The advantages of our formulation are threefold: First, in contrast to previous arts which
usually rely on some heuristics to reweight the loss functions for different classses, our approach
is principled, yielding a simple optimization interpretation. Second, unlike existing methods, our
formulation requires no additional information compared to the original FL formulation and it treats
data from different classes agnostically, and hence is less likely to leak the private information of
the clients. Third, from our extensive empirical study, our formulation can significantly improve the
testing accuracy on the minority class, without compromising the overall performance.
Contribution. We summarize our contributions as follows.
1.	Problem Formulation: To address the challenge of class imbalance in FL with data hetero-
geneity, we propose a novel constrained FL formulation with explicit enforcement on the similarity
between the local empirical losses. Using only information from the standard FL objective, our
approach is completely agnostic to class distribution of the client data and its proxies, as opposed to
the existing literature (which mostly violate privacy requirements of FL).
2.	Meta-Algorithm: We solve our constrained optimization problem via a primal-dual approach.
For a fixed dual variable, the corresponding Lagrangian function enjoys a similar structure as the
standard FL loss, but with non-uniform weights on the local objectives. Accordingly, we propose
an efficient (meta-) algorithm called CLIMB that can use any FL optimization method as a subrou-
tine, with nearly negligible communication overhead. Furthermore, we analyze the convergence
properties of CLIMB under certain oracle assumptions.
3.	Accuracy Improvement in the minority class: On benchmark datasets, CLIMB with Fed-Avg
as base solver achieves significant enhancement of the accuracy in the minority class without com-
promising the overall accuracy under various data heterogeneity and class imbalance scenarios.
2	Related Works
Class Imbalance in Centralized Setting. In the centralized learning setting, the number of samples
per class is known. We categorize existing solutions that exploit such information as follows.
Balanced sampling. In order to balance the data used for gradient calculation, the most common
approaches are either to under sample from the majority classes (Liu et al., 2008), or to augment
the minority class (Chawla et al., 2002; Guo & Viktor, 2004). Both methods seek to generate an
artificial uniform distribution of data (Buda et al., 2018; Pouyanfar et al., 2018).
Loss reweighting. Methods in this category focus on re-weighting the loss functions for different
classes, with extra emphases on the mistakes made in the minority class (Cui et al., 2019; Ling &
Sheng, 2008; Sun et al., 2007; Wang et al., 2016). There also exist works like (Lin et al., 2017) that
adjust the scale of the loss sample-wise, without exploiting the global data distribution.
Gradient tuning. In the context of neural networks, some other works focus on tuning the gradient
per class (Anand et al., 1993) showing faster rates of convergence in the class imbalance setting.
2
Published as a conference paper at ICLR 2022
To do this, the gradient is reshaped in order to have an equal magnitude when projected to all the
gradients per class, while keeping the same norm as the original gradient.
Class Imbalance in Federated Learning. Combating with the issue of class imbalance is more
challenging in FL since the data composition in such a setting is generally unknown and the minor-
ity classes are often difficult to identify Li et al. (2020); Wang et al. (2020b). While research in this
direction are quite limited, to the best of our knowledge, we classify them into the following two
classes based on whether a proxy of the data composition is explicitly built.
(i)	A common strategy in existing methods is to explicitly build proxies of the data composition
based on some heuristics. These proxies are dynamically adjusted during the learning procedure
and allow the aforementioned three techniques, balanced sampling, loss re-weighting and gradient
tuning, to be utilized in the FL setting: Wang et al. (2021a) suggests that there exists a propor-
tional relation between the magnitude of the gradients the corresponds to the last layer of the neural
network and the sample quantity. Based on such observation, the proposed the Ratio-Loss,
a class-wise re-weighted version of the standard cross entropy loss. We note that to define the
Ratio-Loss, one needs to collect a subset of client data as “auxiliary data”, which may not be
ideal in the setting of FL. On the same vein, Yang et al. (2020) argues that the gradient per class can
be used as a proxy to infer the imbalances in the distributions of the clients, and thus clients should
be selected according to how uniform the magnitude of gradient per class is. We also notice the
work Astraea which introduces extra virtual components called mediators between the FL server
and clients (Duan et al., 2019). The mediator is assumed to have access to the local data distribu-
tions of the clients so that client rescheduling and data augmentation can be carried out accordingly.
Through the prepossessing on the mediator, the gradients communicated to the server are made bal-
anced class-wise. However, when privacy is taken into consideration, methods like Astraea may
not be appropriate as in essence it is directly built on the global data distribution.
(ii)	Without explicitly constructing an estimation of the data composition, there are works that resort
to techniques like active learning and reinforcement learning to implicitly learn the data composi-
tion as the optimization progresses. Works along this research line usually rely on client selection
to mitigate the effects of class imbalances. In (Goetz et al., 2019), to address the class imbalance
problem, there will a higher probability to sampling clients that posses the global minority class.
Other works, leverage client selection as a multi-armed bandit problem, and design a client selec-
tion policy to balance the gradients (Xia et al., 2020). Other arts leverage Q-learning techniques to
select clients in order to minimize the overall loss Wang et al. (2020a). However, we believe in the
most practical setting of FL, clients that are available per communication round is incoercible and
hence these strategies have limited applicability.
Comparison with Previous Works. Our method significantly differs from the above strategies in
the following ways: (1) Our method requires no knowledge of the data composition, nor any proxy
of such information. Consequently, our approach is agnostic to the minority class and better pre-
serves clients’ privacy. Such a property draws clear distinction between our work and the works
listed in class (i) above. (2) As will be more clear in the following section, we only perform client-
wise re-weighting as opposed to the class-wise re-weighting schemes used in previous works, which
further emphasize the agnostic nature of our approach. (3) In contrast to the methods in class (ii)
above, our approach does not require active client selection, enjoying a broader applicability in the
most practical and interesting settings.
3	Federated Learning with Empirical Loss Constraints
We consider the problem of multi-class classification. Let x ∈ X ⊆ Rd be the input and use
y ∈ Y = {1, . . . , C} to denote the target label, where C is the total number of classes. In the
context of FL, we assume to have N clients, each of which posses its own private data distribution
pi(x, y). Here, pi(x, y) is a joint probability distribution of the input x and the output label y. One
can decompose pi(x, y) as pi(x, y) = p(x|y)pi(y), where p(x|y) is the conditional distribution of
the input x given class y and pi (y) is the marginal distribution of class y on client i. We assume that
the conditional distribution p(x|y) is identical on all devices, but the marginal distribution pi (y) can
vary significantly due to the heterogeneity of the data configuration.
Let H = {φ : X × Θ → RC} be a family of parameterized predictors with parameter θ ∈ Θ ⊆ RQ.
Let ` : RC × Y → R+ be the loss function, then the local objective function of client i is defined as
fi (θ) = E(x,y)-pi ['(φ(x,θ),y)]∙	(I)
3
Published as a conference paper at ICLR 2022
For multi-class classification, ` is often chosen to be the cross entropy loss. In the standard formu-
lation of FL, the goal is to minimize the global average of local objectives
1N
m∈in f(θ) := NEfi⑻.	⑵
i=1
While it is well known that, in the presence of class imbalance, the above vanilla formulation will
produce models that perform poorly on the minority data, we consider the following configuration
of heterogeneous local class distributions in order to make a quantitative analysis of such a phe-
nomenon for a concrete class imbalance setting. More importantly, such a setting will also motivate
our constrained FL formulation. We emphasize that the following setting is just used as a motivating
example to showcase our claims, and our results apply generally to any FL setting.
Motivating Example. Let U be the uniform distribution over the classes, i.e. for y 〜u, Pr(y =
C) = cl, ∀c ∈ Y and let δc be the Dirac distribution of class c. We assume for some small but fixed
α ∈ [0, 1], the local class distribution of the client i is a mixture of the uniform distribution over all
classes and the Dirac distribution ofa fixed class ci, i.e. pi = αu + (1 - α)δci. We use Nc to denote
the number clients with ci = c. Note that in the limit setting when α = 0, the aforementioned
configuration captures the most heterogeneous setting: clients only have data from a single class.
We consider an extreme case of class imbalance under the above configuration. Without loss of
generality, we consider the binary classification problem, i.e. C = 2, and we assume class 1 to be
the minority class with N = 1. We define gi(θ) := Eχ~p(χ∣y=i)['(Φ(χ, θ), i)] as the loss of the
predictor φ(∙, θ) on the data with y = i. We can calculate that
f(θ)=( 2+1Nα 卜 ι(θ)+(2+(I-αNN- 1) "θ).	⑶
Clearly, when α, the portion of data with uniform label distribution, is small, e.g. α = 0, and N, the
total number of clients, is large, the loss of the predictor on class 1 has negligible weight, which often
leads to the poor performance on the minority class in the trained classifier as the majority classes
dominate the gradient. Moreover, observe that when α is small, there is a significant mismatch
between the local and global class imbalance: the global minority class 1 is in the majority on
the corresponding client locally. Such phenomenon is pertinent to the FL setting due to the data
heterogeneity and poses a great challenge for tackling the issue of class imbalance in FL.
3.1	Constrained FL Formulation
In our work, to address the class imbalance challenge, we propose to minimize the following con-
strained FL (CFL) formulation
Pe = min f(θ) ：= ɪ XX fi(θ)	(CFL)
θ∈Θ	N
i=1
s.t. fi(θ)-f(θ) ≤ 6, ∀i ∈ [1,...,Ν ].
Here, is a tolerance constant that controls the enforced closeness in the training loss among clients,
and We emphasize the dependence of the optimal value Pe on 6 by encoding it in the subscript. As a
motivation, we show that the constraint in our formulation (CFL) can be translated to a constraint on
the performance of the minority class, under the above class imbalance setting: Consider the setting
where the tolerance constant is very small, i.e. 6 is close to zero. WLOG, we assume that the first
device is the one that has ci = 1. Recall the definition of gi above Eq.(3). One can compute that
(1 - α)(N - 1)	N 6
fl(θ) - f(θ) = (——N——) (g1(θ) - g2(θ)) ≤ 6 0 g1(θ) - g2(θ) ≤ (1-α)(N - 1) .
Therefore, our formulation (CFL) enjoys a clear class-balancing interpretation in the highly hetero-
geneous setting when α is small and N is large. Note that this is achieved without the identification
of the minority class and server collects no additional information compared to the vanilla FL.
While the above nice interpretation of the proposed constraint may not hold exactly for general class
imbalance settings, in spirit, we want the resulting classifier from our algorithm to perform similarly
on every class, or in other words to account for the minority class and majority class equally. In the
following section, we discuss how to solve the proposed formulation by alternating the primal and
dual updates of an equivalent Lagrangian formulation.
4
Published as a conference paper at ICLR 2022
Algorithm 1 CLIMB: CLass IMBalance Federated Learning
1:	Input: initial model θ0, a subroutine ClientUpdate, dual step size ηD , maximum round T ;
2:	Initialize the dual variables λ = [0, . . . , 0];
3:	for t = 1, 2, . . . , T do
4:	Compute weights: ∀i ∈ [N],wi = 1 + λ% - λ, with λ = N PN=I λ%;
5:	Primal Update: θt+1 J ClientUpdate({wi}N=1, θt);
6：	Dual Update:	∀i	∈	[N], % 一	[%	+ η0(fi(θt+1)	- f(θt+1)	- e)]+, With f = N	PL	f；
7:	end for
8:	Output: model θT+1
3.2 Algorithm Construction
In order to solve problem (CFL), we resort to the method of Lagrange multipliers. By introducing
the dual variables λ = [λ1, . . . , λN] ∈ R+N, we define the Lagrangian function as,
1 N	(	1 N	∖
L(θ, λ) = N Σfi (θ) + λi f fi(θ) - N ɪ^fj ⑹-EJ	(4)
1N	1N
=N Σ^(1 + λi - λ)fi(θ) - λie,	with X= N	λi.	(5)
With this in hand, we can construct a lower bound of the above constrained optimization problem
using the Lagrangian L(θ, λ) as follows:
D* = max min L(θ,λ) ≤ min max L(θ, λ) = P：,
λ∈R+N θ∈Θ	θ∈Θ λ∈R+N
where we often refer to D： as the dual problem. To solve the dual problem, we propose CLIMB, a
method described in Algorithm 1, which is discussed in detail as follows.
CLIMB proceeds by alternatingly optimizing over the primal variable θ and the dual variable λ.
Primal Update. For a fixed λ, the minimization of L with respect to θ is equivalent to a re-weighted
version of the standard unconstrained FL objective (2):
N
min L(θ,λ) o min N£(
i=1
1 + λi - λX)fi(θ).
(6)
Importantly, this simple and canonical form allows us to perform the update on θ using any FL
solver as the base optimizer. For flexibility, we do not explicitly choose the base optimizer in our
algorithm description, but refer to the update on θ as the subroutine ClientUpdate({wi}iN=1, θt) →
θt+1. Such a subroutine takes the non-uniform weights {wi}iN=1 on the local objectives and the
current consensus model θt as inputs, and returns an updated model θt+1. Note that every call to
ClientUpdate may consists of multiple communication rounds.
Dual Update. Once we have obtained the new consensus model θt+1, we perform dual update on λ
by taking a single dual ascent step of the following equivalent objective (given some fixed θ),
max L(θ,λ o max1X λi (fi(θ)- -1 X fj(θ)- e
λ∈RN	λ∈RN N	N
+	+	i=1	j=1
(7)
To evaluate the gradient of L with respect to λ, we need to first broadcast the consensus model
θt+1 and then aggregate the function values f (θt+1). Since the broadcast model can be used for
the next round of primal update, the only overhead of CLIMB compared to the standard FL solver
ClientUpdate, is to transmit the functional value, which is negligible.
Remark 3.1 We emphasize that CLIMB can be implemented in a privacy-preserving manner: A
client can carry out its update locally given the access to the global average of the dual variables λX
and the global average of the loss functions fX(θ). These quantities can be computed via the standard
FL technique of Homomorphic Encryption without revealing the exact value of the dual variable λi
and local loss fi(θ) to the server, as elaborated in Appendix D.
5
Published as a conference paper at ICLR 2022
3.3 Theoretical Guarantees
Based on the recent progress in constrained learning (Chamon et al., 2021), we show that under mild
regularity conditions, the duality gap between the dual problem D* and the primal problem Pj can
be controlled by some quantity that describes the capability of the parametric function class H.
Assumption 3.1 The loss function ` in the definition of the local objective (1) is L-Lipschitz,
i.e. k'(x, ∙) 一 '(z, ∙)k ≤ Lkx 一 Zk, and bounded by B.
Assumption 3.2 The conditional distribution p(x|y) is non-atomic for all y ∈ RC.
While usually the local data distribution is discrete, we can always augment it by randomly per-
turbing the data points with white noise, this is often used as data augmentation in vision tasks.
Assumption 3.3 There exists a convex hypothesis class H such that H ⊆ H, and there exists a
constant ξ > 0 such that ∀φ ∈ H, there exists θ ∈ Θ such that supx∈X kφ(x) 一 φ(x, θ)k ≤ ξ.
A simple strategy to construct H is to take the convex hull of H. When H is sufficiently rich, ξ can
be expected to be small. Notice that this bound can be decreased by increasing the richness of the
function class H. All the proofs can be found in the Appendix.
Theorem 3.1 (Near Zero Duality Gap) Under Assumptions 3.1, 3.2,3.3, and the Contrained Fed-
erated Learning problem is feasible in H with constraint 一 2Lξ, the Constrained Federated Learn-
ing problem has near zero-duality gap,
Pe - D： ≤ (2∣λ>2Lξ∣1 + 1)Lξ,	(8)
where 入：—2工［is the optimal dual variable associated with the Constrained Federated Learning
problem (CFL) with constraints e - 2Lξ over the space of functions H.
Theorem 3.1 establishes an upper bound on the duality gap of the Constrained Federated Learning
Problem CFL. The gap depends on the Lipschitz constant of the loss function L, the richness of the
function class ξ, and the optimal dual variable of a more restrictive problem. Note that we required
the Constrained Federated Learning problem to be feasible for constraint e - 2Lξ. In the case of the
cross-entropy loss, as long as e - 2Lξ > 0, this can be satisfied by a classifier that assigns a uniform
label for every sample, as each individual loss will be equal to each other.
Since the minimization of the Lagrangian function L is non-convex, to show the convergence of
CLIMB, we need an additional oracle assumption as follows.
Assumption 3.4 (Approximate Solution) For every dual variable λ ∈ R+N, and precision δ > 0
there exists an oracle approximate solution θλ such that L(θλ, λ) ≤ minθ∈RQ L(θ, λ) + δ.
Theorem 3.2 (Convergence) Define the dual function d(λ) = minθ∈Θ L(θ, λ). Under Assump-
tions 3.1 to 3.4, for a fixed tolerance r > 0, the iterates generated by Algorithm 1 converge to a
neighborhood of the dual problem De： in at most Tr = O(1/r) steps, i.e.,
d(λTr) ≥ D： - δ - ηDB2 - r,	(9)
4	Experiments
In this section, we evaluate our formulation (CFL) against the competitors on various FL scenarios
at the presence of class imbalance. Our results highlight the benefits of our approach especially
when the local data distributions are severely heterogeneous and there is a significant mismatch
between local and global imbalance. To ensure a fair comparison, we use Fed-Avg as the base
optimizer in the current experiment for all formulations: the standard FL objective in Eq.(2), the
proposed formulation in Eq.(CFL), Ratio-Loss (Wang et al., 2021a), and Focal-Loss (Lin
et al., 2017). We emphasize that the novelty of our work lies in the new constrained FL formulation
(CFL) and is orthogonal to how the formulation is solved. We now describe the datasets and models
used in our experiments with more details provided in Appendix A.
Datasets Three benchmark datasets are used in our experiments with the default train/test splits,
6
Published as a conference paper at ICLR 2022
Imbalance ratio	Dataset	Level of heterogeneity	Baseline (Eq.(2))	CLIMB (this work)	Ratio-Loss	Focal-Loss
ρ = 20	CIFAR10		1 minority class out of 10 total classes			
		α = 0.1	0.0532 (0.6754)	0.2080 (0.6829)	0.1140 (0.6727)	0.0450 (0.6445)
		α = 0.2	-0137- (0.7121)	-0.3230- (0.7121)	0.1790 (0.7037)	0.0430 (0.6914)
			3 minority classes out of 10 total classes			
		α = 0.1	0 (0.5669)	0.2810 (0.6031)	0 (0.5746)	0 (0.6565)
		α = 0.2	0.1279 (0.7098)	-0.3240- (0.7167)	0.1790 (0.7054)	0.0552 (0.6905)
	MNIST		1 minority class out of 10 total C			asses
		α = 0.1	0.6889 (0.9375)	0.8552 (0.9556)	0.8472 (0.9544)	0.6186 (0.9278)
		α = 0.2	07925 (0.9540)	-0.8748- (0.9616)	0.8052 (0.9555)	0.7784 (0.9479)
			3 minority classes out of 10 total classes			
		α = 0.1	0.3425 (0.8260)	0.6987 (0.9158)	0.4134 (0.8484)	0.1944 (0.7938)
		α = 0.2	04720 (0.8596)	-0.7290- (0.9153)	0.6717 (0.9063)	0.4602 (0.8654)
ρ =10	CIFAR10		1 minority class out of 10 total classes			
		α = 0.1	0.2058 (0.6841)	0.3629 (0.7041)	0.2164 (0.6839)	0.0414 (0.6543)
		α = 0.2	01813 (0.7113)	-0.3743- (0.7312)	0.2657 (0.7083)	0.1347 (0.6911)
			3 minority classes out of 10 total classes			
		α = 0.1	0.0492 (0.5933)	0.2280 (0.6358)	0.0315 (0.5825)	0 (0.5548)
		α = 0.2	0.1064 (0.6380)	-0.2734- (0.6696)	0.0993 (0.6211)	0.0298 (0.5982)
	MNIST		1 minority class out of 10 total C			asses
		α = 0.1	0.8473 (0.9534)	0.9305 (0.9584)	0.8851 (0.9558)	0.8469 (0.9470)
		α = 0.2	08962 (0.9634)	-0.9239- (0.9657)	0.8798 (0.9615)	0.8953 (0.9586)
			3 minority classes out of 10 total classes			
		α = 0.1	0.6045 (0.8906)	0.8084 (0.9356)	0.6981 (0.9119)	0.4690 (0.8670)
		α = 0.2	07272 (0.9190)	-0.8195- (0.9392)	0.7663 (0.9320)	0.6961 (0.9099)
Table 1: The minority class testing accuracy and the overall testing accuracy (the quantity in the
parentheses) after 5000 communication rounds. If there are multiple minority classes, we report
the worst of them. Here N, the number of devices, is 500. The base FL solver is Fed-Avg with
partial-participation: 100 devices participate in every communication round.
which are MNIST (LeCun et al., 1998), CIFAR10 (Krizhevsky et al., 2009) and Fashion-MNIST
(Xiao et al., 2017). The results on the last dataset are deferred to the appendix due to space limitation.
Heterogeneity. We generate heterogeneity in the local data distributions according to the strategy
from (Karimireddy et al., 2020; Hsu et al., 2019): Let α ∈ [0, 1] be some constant that determines
the level of heterogeneity. For a fixed α, we divide the dataset among N = 100 (moderate) or
N = 500 (massive) clients as follows: for we allocate to each client a portion of α i.i.d. data and
the remaining portion of (1 - α) by sorting according to label. In our appendix, we also consider
the Dirichlet type heterogeneous data allocation scheme which is wildly used in the literature of
Federated Learning, for example (Hsu et al., 2019; Acar et al., 2020).
Data Imbalance. We simulate the phenomenon of class imbalance by removing data belong to
the minority classes: Observe that the datasets included in our experiments both have 10 perfectly
balanced classes. For the minority class(es), We retain only 1/p portion of the corresponding data.
Here, ρ ≥ 1 the ratio between the numbers of data in the majority class and in the minority class
7
Published as a conference paper at ICLR 2022
and is termed the imbalance ratio. For example, when there are 3 minority classes with ρ = 10,
90% of the data belong to classes 0, 1, 2 (without loss of generality) are manually removed. In our
experiments, we consider the setting of 1 or 3 minority classes and we take ρ = 5, 10, 20.
Models We follow the choice of model architectures in (Acar et al., 2020; McMahan et al., 2017).
Specifically, we use a 2 hidden layer fully-connected neural network for MNIST, where the numbers
of neurons are (128, 128). For CIFAR10, we use a CNN model consisting of 2 convolutional layers
with 64 5 × 5 filters followed by 2 fully connected layers with 394 and 192 neurons. We note that
higher testing accuracy on the included datasets can be obtain by using models with high capacity,
but is orthogonal to our research.
4.1 Results Summary
To evaluate the effectiveness of an approach against the challenge of class imbalance, one needs to
take into consideration both the performance on the minority class(es) and the average performance
on all the classes. We report both quantities after sufficient communication rounds (5000 rounds
for CIFAR10 and 1000 rounds for MNIST) under various experiment settings in Tables 1 and 2.
In every cell of these tables, the quantity above denote the minority class testing accuracy and the
quantity in the parentheses is the average performance on all the classes. We also considered the
case where there are multiple minority classes and we report the worst accuracy among the minority
classes. Our approach outperforms previous arts in all cases, often by a large margin.
Imbalance Ratio and Number of Minority Classes. The imbalance ratio ρ and the number of
minority classes are two important quantities to measure the difficulty of a class imbalance problem.
Under all the included choices, CLIMB consistently beats previous arts in both minority class testing
accuracy and average performance on all the classes. Therefore, we conclude that CLIMB is able
to boost the performance on the minority class without compromising the performance on the other
classes. This is a rare merit when addressing the class imbalance problem. In fact, methods like
Ratio-Lossis able to improve the testing accuracy on the minority class, but it also sacrifices the
performance on the rest classes, leading to an inferior average testing accuracy.
Level of Heterogeneity. We test the performance of CLIMB under different levels of heterogene-
ity and observe that CLIMB outperforms the included methods considerably in all settings. It has
the biggest advantage over the competitors in the most heterogeneous setting, α = 0. There are
situations that existing methods completely fail in the minority class with less than 10% accuracy,
but CLIMB is still able to correctly classify most of the minority data, e.g. see Table 2→ ρ = 5 →
MNIST→ 3 minority classes→ α = 0.
Moderate vs. Large Number of Devices An important goal of FL is to exploit the computational
resources of the IoT devices. Hence, the scalability to a large number of devices is a critical prop-
erty of an FL method. We hence test CLIMB on both moderate (N = 100, see Table 2) and massive
devices (N = 500, see Table 1) settings. To make things more practical, we instantiate the sub-
routine ClientUpdate using Fed-Avg with the partial-participation scheme in the massive device
setting. Specifically, 100 devices participate model training after every Fed-Avg global communica-
tion round. We clearly observe the advantage of CLIMB in all of these setups.
Conclusion
In this paper we proposed a novel agnostic constrained learning formulation to tackle the problem
of class imbalance in the Federated Learning setting. By introducing constraints in the learning
procedure we enforced the performance to be similar in all clients, thus accounting for the class
imbalances. In terms of privacy protection, our formulation requires no further information than
the standard FL objective to be collected in the server and it never estimates the data composition
as opposed to all previous approaches. Moreover, compared with previous arts which are usually
heuristic based, our approach is principled as it is purely optimization based and can be efficiently
solved via the proposed meta-algorithm CLIMB, yielding major practical benefits. Our extensive
empirical study showcases the superiority of proposed constrained formulation over previous arts.
Acknowledgments
This research is supported by AFOSR Award 19RT0726, NSF HDR TRIPODS award 1934876,
NSF award CPS-1837253, NSF award CIF-1910056, NSF CAREER award CIF-1943064, and NSF
award CCF-2112665.
8
Published as a conference paper at ICLR 2022
Imbalance ratio	Dataset	Level of heterogeneity	Baseline (Eq.(2))	CLIMB (this work)	Ratio-Loss	Focal-Loss
ρ = 10	CIFAR10		1 minority class out of 10 total classes			
		α = 0.0	0.0229 (0.5734)	0.5575 (0.6076)	0 (0.4836)	0 (0.4205)
		α = 0.1	0.2753 (0.7143)	-0.5054- (0.7246)	0.2929 (0.6951)	0.2284 (0.6860)
		α = 0.2	0.2988 0.7348	-0.4689- (0.7511)	0.3825 (0.7329)	0.2618 0.7249
			3 minority classes out of 10 total classes			
		α = 0.0	0.0402 (0.5534)	0.2756 (0.5598)	0 (0.4678)	0 (0.4527)
		α = 0.1	0.1316 (0.6189)	-0.3399- (0.6637)	0.0690 (0.615)	0.0408 (0.5976)
		α = 0.2	0.2566 (0.6659)	-0.3292- (0.6983)	0.1916 (0.6504)	0.1213 (0.6346)
	MNIST		1 minority class out of 10 total C			asses
		α = 0.0	0.3092 (0.8630)	0.9175 (0.9341)	0.4650 (0.8630)	0.3078 (0.8556)
		α = 0.1	0.8597 (0.9586)	-0.9428- (0.9675)	0.9189 (0.9648)	0.8348 (0.9529)
		α = 0.2	0.8750 (0.9640)	-0.9377- (0.9715)	0.9283 (0.9706)	0.8882 (0.9631)
			3 minority classes out of 10 total classes			
		α = 0.0	0.0153 (0.7133)	0.8029 (0.9115)	0.0631 0.7222	0.0717 0.7401
		α = 0.1	0.7263 (0.9189)	-0.8828- (0.9522)	0.7870 (0.9341)	0.6674 (0.9069)
		α = 0.2	0.7950 (0.9352)	-0.8004- (0.9416)	0.7801 (0.9364)	0.7785 (0.9274)
ρ =5	CIFAR10		1 minority class out of 10 total classes			
		α = 0.0	0.2892 (0.6382)	0.5987 (0.6468)	0.0942 (0.5506)	0.1491 (0.5631)
		α = 0.1	0.4101 (0.7186)	-0.6075- (0.7351)	0.4011 (0.7008)	0.3558 (0.6994)
		α = 0.2	0.5335 (0.7536)	-0.6063- (0.7556)	0.5054 (0.7427)	0.4359 (0.7380)
			3 minority classes out of 10 total classes			
		α = 0.0	0.0313 (0.4742)	0.3813 (0.5639)	0.0512 (0.5108)	0 (0.4514)
		α = 0.1	0.5135 (0.6636)	-0.6420- (0.6977)	0.4600 (0.6632)	0.4213 (0.6384)
		α = 0.2	0.5251 (0.6960)	-0.6328- (0.7202)	0.5751 (0.6883)	0.5311 (0.6749)
	MNIST		1 minority class out of 10 total C			asses
		α = 0.0	0.7245 (0.8953)	0.9154 (0.9224)	0.8020 (0.9016)	0.7429 (0.8992)
		α = 0.1	0.9378 (0.9666)	-0.9582- (0.9693)	0.9286 (0.9651)	0.9408 (0.9624)
		α = 0.2	0.9448 (0.9711)	-0.9670- (0.9734)	0.9561 (0.9733)	0.9481 (0.9686)
			3 minority classes out of 10 total classes			
		α = 0.0	0.0160 (0.7722)	0.8744 (0.9137)	0 (0.7370)	0.0544 (0.7826)
		α = 0.1	0.8294 (0.9422)	-0.9217- (0.9606)	0.8520 (0.9501)	0.7987 (0.9361)
		α = 0.2	0.8557 (0.9536)	-0.8818- (0.9595)	0.8730 (0.9536)	0.8321 (0.9442)
Table 2: The minority class testing accuracy and the overall testing accuracy (the quantity in the
parentheses) after sufficiently many communication rounds. If there are multiple minority classes,
we report the worst of them. Here N, the number of devices, is 100. The base FL solver is Fed-Avg
with full-participation: all devices participate in every communication round.
9
Published as a conference paper at ICLR 2022
References
Durmus Alp Emre Acar, Yue Zhao, Ramon Matas, Matthew Mattina, Paul Whatmough, and
Venkatesh Saligrama. Federated learning based on dynamic regularization. In International Con-
ference on Learning Representations, 2020.
Rangachari Anand, Kishan G Mehrotra, Chilukuri K Mohan, and Sanjay Ranka. An improved
algorithm for neural network classification of imbalanced training sets. IEEE Transactions on
NeuralNetworks, 4(6):962-969,1993.
Dimitri Bertsekas. Convex optimization theory. Athena Scientific, 2009.
Dimitri Bertsekas. Convex optimization algorithms. Athena Scientific, 2015.
Stephen Boyd and Almir Mutapcic. Subgradient methods.
Stephen Boyd and Lieven Vandenberghe. Convex optimization. Cambridge university press, 2004.
Mateusz Buda, Atsuto Maki, and Maciej A Mazurowski. A systematic study of the class imbalance
problem in convolutional neural networks. Neural Networks, 106:249-259, 2018.
Luiz Chamon and Alejandro Ribeiro. Probably approximately correct constrained learning. Ad-
vances in Neural Information Processing Systems, 33, 2020.
Luiz FO Chamon, Santiago Paternain, Miguel Calvo-Fullana, and Alejandro Ribeiro. Constrained
learning with non-convex losses. arXiv preprint arXiv:2103.05134, 2021.
Philip K Chan, Wei Fan, Andreas L Prodromidis, and Salvatore J Stolfo. Distributed data mining in
credit card fraud detection. IEEE Intelligent Systems and Their Applications, 14(6):67-74, 1999.
Nitesh V Chawla, Kevin W Bowyer, Lawrence O Hall, and W Philip Kegelmeyer. Smote: synthetic
minority over-sampling technique. Journal of artificial intelligence research, 16:321-357, 2002.
Olivia Choudhury, Yoonyoung Park, Theodoros Salonidis, Aris Gkoulalas-Divanis, Issa Sylla, et al.
Predicting adverse drug reactions on distributed health data using federated learning. In AMIA An-
nual symposium proceedings, volume 2019, pp. 313. American Medical Informatics Association,
2019.
Yin Cui, Menglin Jia, Tsung-Yi Lin, Yang Song, and Serge Belongie. Class-balanced loss based
on effective number of samples. In Proceedings of the IEEE/CVF conference on computer vision
and pattern recognition, pp. 9268-9277, 2019.
Moming Duan, Duo Liu, Xianzhang Chen, Yujuan Tan, Jinting Ren, Lei Qiao, and Liang Liang.
Astraea: Self-balancing federated learning for improving classification accuracy of mobile deep
learning applications. In 2019 IEEE 37th international conference on computer design (ICCD),
pp. 246-254. IEEE, 2019.
Jack Goetz, Kshitiz Malik, Duc Bui, Seungwhan Moon, Honglei Liu, and Anuj Kumar. Active
federated learning. arXiv preprint arXiv:1909.12641, 2019.
Hongyu Guo and Herna L Viktor. Learning from imbalanced data sets with boosting and data
generation: the databoost-im approach. ACM Sigkdd Explorations Newsletter, 6(1):30-39, 2004.
Haibo He and Edwardo A Garcia. Learning from imbalanced data. IEEE Transactions on knowledge
and data engineering, 21(9):1263-1284, 2009.
Tzu-Ming Harry Hsu, Hang Qi, and Matthew Brown. Measuring the effects of non-identical data
distribution for federated visual classification. arXiv preprint arXiv:1909.06335, 2019.
Chen Huang, Yining Li, Chen Change Loy, and Xiaoou Tang. Learning deep representation for
imbalanced classification. In Proceedings of the IEEE conference on computer vision and pattern
recognition, pp. 5375-5384, 2016.
Justin M Johnson and Taghi M Khoshgoftaar. Survey on deep learning with class imbalance. Journal
of Big Data, 6(1):1-54, 2019.
10
Published as a conference paper at ICLR 2022
Peter Kairouz, H Brendan McMahan, Brendan Avent, AUrelien BelleL Mehdi Bennis, Arjun Nitin
Bhagoji, Kallista Bonawitz, Zachary Charles, Graham Cormode, Rachel Cummings, et al. Ad-
vances and open problems in federated learning. arXiv preprint arXiv:1912.04977, 2019.
Sai Praneeth Karimireddy, Satyen Kale, Mehryar Mohri, Sashank Reddi, Sebastian Stich, and
Ananda Theertha Suresh. Scaffold: Stochastic controlled averaging for federated learning. In
International Conference on Machine Learning, pp. 5132-5143. PMLR, 2020.
Alex Krizhevsky et al. Learning multiple layers of features from tiny images. 2009.
Yann LeCun, Leon Bottou, Yoshua Bengio, and Patrick Haffner. Gradient-based learning applied to
document recognition. Proceedings of the IEEE, 86(11):2278-2324, 1998.
Geun Hyeong Lee and Soo-Yong Shin. Federated learning on clinical benchmark data: Performance
assessment. J Med Internet Res, 22(10):e20891, Oct 2020. ISSN 1438-8871. doi: 10.2196/20891.
URL http://www.jmir.org/2020/10/e20891/.
Xiang Li, Kaixuan Huang, Wenhao Yang, Shusen Wang, and Zhihua Zhang. On the convergence of
fedavg on non-iid data, 2020.
Tsung-Yi Lin, Priya Goyal, Ross Girshick, Kaiming He, and Piotr Dollar. Focal loss for dense
object detection. In Proceedings of the IEEE international conference on computer vision, pp.
2980-2988, 2017.
Charles X Ling and Victor S Sheng. Cost-sensitive learning and the class imbalance problem.
Encyclopedia of machine learning, 2011:231-235, 2008.
Xu-Ying Liu, Jianxin Wu, and Zhi-Hua Zhou. Exploratory undersampling for class-imbalance learn-
ing. IEEE Transactions on Systems, Man, and Cybernetics, Part B (Cybernetics), 39(2):539-550,
2008.
Guodong Long, Yue Tan, Jing Jiang, and Chengqi Zhang. Federated Learning for Open
Banking, pp. 240-254. Springer International Publishing, Cham, 2020. ISBN 978-3-030-
63076-8. doi: 10.1007/978-3-030-63076-8」7.	URL https://doi.org/10.1007/
978-3-030-63076-8_17.
Brendan McMahan, Eider Moore, Daniel Ramage, Seth Hampson, and Blaise Aguera y Ar-
cas. Communication-Efficient Learning of Deep Networks from Decentralized Data. In
Aarti Singh and Jerry Zhu (eds.), Proceedings of the 20th International Conference on Artifi-
cial Intelligence and Statistics, volume 54 of Proceedings of Machine Learning Research, pp.
1273-1282. PMLR, 20-22 Apr 2017. URL https://proceedings.mlr.press/v54/
mcmahan17a.html.
Samira Pouyanfar, Yudong Tao, Anup Mohan, Haiman Tian, Ahmed S Kaseb, Kent Gauen, Ryan
Dailey, Sarah Aghajanzadeh, Yung-Hsiang Lu, Shu-Ching Chen, et al. Dynamic sampling in
convolutional neural networks for imbalanced data classification. In 2018 IEEE conference on
multimedia information processing and retrieval (MIPR), pp. 112-117. IEEE, 2018.
Alejandro Ribeiro. Optimal resource allocation in wireless communication and networking.
EURASIP Journal on Wireless Communications and Networking, 2012(1):1-19, 2012.
Abhijit Guha Roy, Shayan Siddiqui, Sebastian Polsterl, Nassir Navab, and Christian Wachinger.
Braintorrent: A peer-to-peer environment for decentralized federated learning. arXiv preprint
arXiv:1905.06731, 2019.
Yanmin Sun, Mohamed S Kamel, Andrew KC Wong, and Yang Wang. Cost-sensitive boosting for
classification of imbalanced data. Pattern recognition, 40(12):3358-3378, 2007.
Fabio Tardella. A new proof of the lyapunov convexity theorem. SIAM journal on control and
optimization, 28(2):478-481, 1990.
Jason Van Hulse, Taghi M Khoshgoftaar, and Amri Napolitano. Experimental perspectives on learn-
ing from imbalanced data. In Proceedings of the 24th international conference on Machine learn-
ing, pp. 935-942, 2007.
11
Published as a conference paper at ICLR 2022
Hao Wang, Zakhary Kaplan, Di Niu, and Baochun Li. Optimizing federated learning on non-iid data
with reinforcement learning. In IEEE INFOCOM 2020-IEEE Conference on Computer Commu-
nications, pp. 1698-1707. IEEE, 2020a.
Jianyu Wang, Qinghua Liu, Hao Liang, Gauri Joshi, and H. Vincent Poor. Tackling the objective
inconsistency problem in heterogeneous federated optimization, 2020b.
Lixu Wang, Shichao Xu, Xiao Wang, and Qi Zhu. Addressing class imbalance in federated learning.
In Proceedings of the AAAI Conference on Artificial Intelligence, volume 35, pp. 10165-10173,
2021a.
Shoujin Wang, Wei Liu, Jia Wu, Longbing Cao, Qinxue Meng, and Paul J Kennedy. Training
deep neural networks on imbalanced data sets. In 2016 international joint conference on neural
networks (IJCNN), pp. 4368-4374. IEEE, 2016.
Yi Wang, Imane Lahmam Bennani, Xiufeng Liu, Mingyang Sun, and Yao Zhou. Electricity con-
sumer characteristics identification: A federated learning approach. IEEE Transactions on Smart
Grid, 12(4):3637-3647, 2021b. doi: 10.1109/TSG.2021.3066577.
Qiong Wu, Xu Chen, Zhi Zhou, and Junshan Zhang. Fedhome: Cloud-edge based personalized
federated learning for in-home health monitoring. IEEE Transactions on Mobile Computing, pp.
1-1, 2020. doi: 10.1109/TMC.2020.3045266.
Wenchao Xia, Tony QS Quek, Kun Guo, Wanli Wen, Howard H Yang, and Hongbo Zhu. Multi-
armed bandit-based client scheduling for federated learning. IEEE Transactions on Wireless Com-
munications, 19(11):7108-7123, 2020.
Han Xiao, Kashif Rasul, and Roland Vollgraf. Fashion-mnist: a novel image dataset for benchmark-
ing machine learning algorithms, 2017.
Miao Yang, Akitanoshou Wong, Hongbin Zhu, Haifeng Wang, and Hua Qian. Federated learning
with class imbalance reduction, 2020.
Wensi Yang, Yuhang Zhang, Kejiang Ye, Li Li, and Cheng-Zhong Xu. Ffd: A federated learning
based method for credit card fraud detection. In Keke Chen, Sangeetha Seshadri, and Liang-Jie
Zhang (eds.), Big Data - BigData 2019, pp. 18-32, Cham, 2019. Springer International PUbIish-
ing. ISBN 978-3-030-23551-2.
Mikhail YUrochkin, Mayank Agarwal, SoUmya Ghosh, Kristjan Greenewald, Nghia Hoang, and
Yasaman Khazaeni. Bayesian nonparametric federated learning of neUral networks. In Interna-
tional Conference on Machine Learning, pp. 7252-7261. PMLR, 2019.
Xinwei Zhang, Mingyi Hong, Sairaj Dhople, Wotao Yin, and Yang LiU. Fedpd: A federated learning
framework with optimal rates and adaptivity to non-iid data. arXiv preprint arXiv:2005.11418,
2020.
12