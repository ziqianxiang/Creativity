Published as a conference paper at ICLR 2022
Neural Solvers for Fast and Accurate Numer-
ical Optimal Control
Federico Berto
KAIST, DiffEqML
fberto@kaist.ac.kr
Stefano Massaroli
The University of Tokyo, DiffEqML
massaroli@robot.t.u-tokyo.ac.jp
Michael Poli
Stanford University, DiffEqML
zymrael@cs.stanford.edu
Jinkyoo Park
KAIST
jinkyoo.park@kaist.ac.kr
Ab stract
Synthesizing optimal controllers for dynamical systems often involves solving op-
timization problems with hard real-time constraints. These constraints determine
the class of numerical methods that can be applied: computationally expensive
but accurate numerical routines are replaced by fast and inaccurate methods, trad-
ing inference time for solution accuracy. This paper provides techniques to im-
prove the quality of optimized control policies given a fixed computational bud-
get. We achieve the above via a hypersolvers (Poli et al., 2020a) approach, which
hybridizes a differential equation solver and a neural network. The performance
is evaluated in direct and receding-horizon optimal control tasks in both low and
high dimensions, where the proposed approach shows consistent Pareto improve-
ments in solution accuracy and control performance.
1 Introduction
Optimal control of complex, high-dimensional systems requires computationally expensive numer-
ical methods for differential equations (Pytlak, 2006; Rao, 2009). Here, real-time and hardware
constraints preclude the use of accurate and expensive methods, forcing instead the application of
cheaper and less accurate algorithms. While the paradigm of optimal control has successfully been
applied in various domains (Vadali et al., 1999; Lewis et al., 2012; Zhang et al., 2016), improving
accuracy while satisfying computational budget constraints is still a great challenge (Ross & Fahroo,
2006; Baotic et al., 2008). To alleviate computational overheads, We detail a procedure for offline
optimization and subsequent online application of hypersolvers (Poli et al., 2020a) to optimal con-
trol problems. These hybrid solvers achieve the accuracy of higher-order methods by augmenting
numerical results ofa base solver with a learning component trained to approximate local truncation
residuals. When the cost of a single forward-pass of the learning component is kept sufficiently
small, hypersolvers improve the computation-accuracy Pareto front of low-order explicit solvers
(Butcher, 1997). However, direct application of hybrid solvers to controlled dynamical system in-
volves learning truncation residuals on the higher-dimensional spaces of state and control inputs. To
extend the range of applicability of hypersolvers to controlled dynamical systems, we propose two
pretraining strategies designed to improve, in the set of admissible control inputs, on the average or
worst-case hypersolver solution. With the proposed methodology, we empirically show that Pareto
front improvements of hypersolvers hold even for optimal control tasks. In particular, we then carry
out performance and generalization evaluations in direct and model predictive control tasks. Here,
we confirm Pareto front improvements in terms of solution accuracy and subsequent control per-
formance, leading to higher quality control policies and lower control losses. In high-dimensional
regimes, we obtain the same control policy as the one obtained by accurate high-order solvers with
more than 3× speedup.
1
Published as a conference paper at ICLR 2022
Hypersolver Training
Pre- trained
9w
Optimal Control
Figure 1: Overview of the proposed method. [Left] The hypersolver is trained to approximate residuals given
a distribution of control inputs and states. [Right] The pre-trained hypersolver model is then used to accelerate
and improve the accuracy of numerical solutions used during optimization of control policies, leading to higher-
quality controllers.
2 Numerical Optimal Control
We consider control of general nonlinear systems of the form
x(t) = f(t,x(t),Uθ (t))
x(0) = x0
(1)
with state x ∈ X ⊂ Rnx , input uθ ∈ U ⊂ Rnu defined on a compact time domain T := [t0, T]
where θ is a finite set of free parameters of the controller. Solutions of (1) are denoted with x(t) =
Φ(x(s), s, t) for all s, t ∈ T. Given some objective function J : X ×U → R; x0, uθ 7→ J(x0, uθ(t))
and a distribution ρ0(x0) of initial conditions with support in X, we consider the following nonlinear
program, constrained to the system dynamics:
EX0~p0(X0) [J(x0,uθ(t))]
min
uθ (t)
subject to
x(t) = f(t,x(t),Uθ (t))
x(0) = x0
t∈T
(2)
where the controller parameters θ are optimized. We will henceforth omit the subscript θ and write
u(t) = uθ(t). Since analytic solutions of (2) exist only for limited classes of systems and objectives,
numerical solvers are often applied to iteratively find a solution. For these reasons, problem 2 is often
referred to as numerical optimal control.
Direct optimal control if the problem (2) is solved offline by directly optimizing over complete
trajectories, we call it direct optimal control. The infinite-dimensional optimal control problem is
time-discretized and solved numerically: the obtained control policy is then applied to the real target
system without further optimization.
Model predictive control Also known in the literature as receding horizon control, Model Pre-
dictive Control (MPC) is a class of flexible control algorithms capable of taking into consideration
constraints and nonlinearities (Mayne & Michalska, 1988; Garcia et al., 1989). MPC considers fi-
nite time windows which are then shifted forward in a receding manner. The control problem is
then solved for each window by iteratively forward-propagating trajectories with numerical solvers
i.e. predicting the set of future trajectories with a candidate controller u(t) and then adjusting it it-
eratively to optimize the cost function J (further details on the MPC formulation in Appendix B.2).
The optimization is reiterated online until the end of the control time horizon.
2
Published as a conference paper at ICLR 2022
2.1	S olver Residuals
Given nominal solutions Φ of (1) we can define the residual of a numerical ODE solver as the
normalized error accumulated in a single step size of the method, i.e.
Rk = R(tk,x(tk),u(tk)) = ^p+ι [φ(x(tk),tk,tk+1 ) - x(tk) — eψe(tk,x(tk),u(tk))]	(3)
where is the step size and p is the order of the numerical solver corresponding to ψ . From the
definition of residual in (3), we can define the local truncation error ek := ep+1Rk 2 which is the
error accumulated in a single step; while the global truncation error Ek = kx(tk) - xk k2 represents
the error accumulated in the first k steps of the numerical solution. Given a p-th order explicit
solver, we have ek = O(ep+1) and Ek = O(ep) (Butcher, 1997).
3	Hypers olvers for Optimal Control
We extend the range of applicability of hypersolvers (Poli et al., 2020a) to controlled dynamical sys-
tems. In this Section we discuss the proposed hypersolver architectures and pre-training strategies
of the proposed hypersolver methodology for numerical optimal control of controlled dynamical
systems.
3.1	Hypersolvers
Given a p-order base solver update map ψ, the corresponding hypersolver is the discrete iteration
xk+1 = xk + eψ (tk,xk,uk) +ep+1 gω (tk,xk, uk)
、----{z-------}	、-----V------}	(4)
base solver step	approximator
where gω (tk, xk , uk) is some o(1) parametric function with free parameters ω. The core idea is to
select gω as some function with universal approximation properties and fit the higher-order terms of
the base solver by explicitly minimizing the residuals over a set of state and control input samples.
This procedure leads to a reduction of the overall local truncation error ek, i.e. we can improve the
base solver accuracy with the only computational overhead of evaluating the function gω . It is also
proven that, if gω is a δ-approximator of R, i.e. ∀k ∈ N≤K
kR (tk, x(tk), u(tk)) - gω (tk, x(tk), u(tk))k2 ≤ δ	(5)
then ek ≤ o(δep+1), where δ > 0 depends on the hypersolver training results (Poli et al., 2020a,
Theorem 1). This result practically guarantees that if gω is a good approximator for R, i.e. δ 1,
then the overall local truncation error of the hypersolved ODE is significantly reduced with guaran-
teed upper bounds.
3.2	Numerical Optimal Control with Hypersolvers
Our approach relies on the pre-trained hypersolver model for obtaining solutions to the trajectories
of the optimal control problem (2). After the initial training stage, control policies are numerically
optimized to minimize the cost function J (see Appendix B.3 for further details). Figure 1 shows an
overview of the proposed approach consisting in pre-training and system control.
4	Hypers olver Pre–training and Architectures
We introduce in Section 4.1 loss functions which are used in the proposed pre-training methods
of Section 4.2 and Section 4.3. We also check the generalization properties of hypersolvers with
different architectures in Section 4.4. In Section 4.5 We introduce multi-stage hypersolvers in which
an additional first-order learned term is employed for correcting errors in the vector field.
4.1	Loss Functions
Residual fitting Training the hypersolver on a single nominal trajectory {x(tk)}k results in a
supervised learning problem where we minimize point-wise the Euclidean distance between the
3
Published as a conference paper at ICLR 2022
----HyperEuler
----Euler
----Midpoint
——RK4
Figure 2: Mean local residuals of the spring-mass system of (17) as a function of control inputs at different step
sizes . HyperEuler (see Appendix A.1 for its explicit formulation) improves on the local residuals compared
to the baseline Euler and even compared to higher-order ODE solvers at larger step sizes.
residual (3) and the output of gω , resulting in an optimization problem minimizing a loss function `
of the form
1 K-1
` (t, x, u) = K Σ kR(tk, x(tk), u(tk)) - gω (tk, x(tk), u(tk))k2
k=0
which is also called residual fitting since the target of gw is the residual R.
(6)
Trajectory fitting The optimization can also be carried out via trajectory fitting as following
1 K-1
' (t,x,u) = K E kx(tk + 1),xk+1 k2	⑺
k=0
where x(tk+1) corresponds to the exact one-step trajectory and xk+1 is its approximation, derived
via (4) for standard hypersolvers or via (11) for their multi-stage counterparts. This method can also
be used to contain the global truncation error in the T domain. We will refer to ` as a loss function
of either residual or trajectory fitting types; we note that these loss functions may also be combined
depending on the application. The goal is to train the hypersolver network to explore the state-
control spaces so that it can effectively minimize the truncation error. We propose two methods
with different purposes: stochastic exploration aiming at minimizing the average truncation error
and active error minimization whose goal is to reduce the maximum error i.e., due to control inputs
yielding high losses.
4.2	Stochastic Exploration
Stochastic exploration aims to minimize the average error of the visited state-controller space i.e.,
to produce optimal hypersolver parameters ω* as the solution of a nonlinear program
ω* = arg min Eξ(χ,u)[' (t, x, u)]
ω
(8)
where ξ(x, u) is a distribution with support in X × U of the state and controller spaces and ` is
the training loss function. In order to guarantee sufficient exploration of the state-controller space,
we use Monte Carlo sampling (Robert & Casella, 2013) from the given distribution. In particular,
batches of initial conditions {xi0}, {ui0} are sampled from ξ and the loss function ` is calculated with
the given system and step size . We then perform backpropagation for updating the parameters of
the hypersolver using a stochastic gradient descent (SGD) algorithm e.g., Adam (Kingma & Ba,
2017) and repeat the procedure for every training epoch. Figure 2 shows pre-training results with
stochastic exploration for different step sizes (see Appendix C.2). We notice how higher residual
values generally correspond to higher absolute values of control inputs. Many systems in practice
are subject to controls that are constrained in magnitude either due to physical limitations of the
actuators or safety restraints of the workspace. This property allows us to design an exploration
strategy that focuses on worst-case scenarios i.e. largest control inputs.
4
Published as a conference paper at ICLR 2022
Without Hypersolver Tanh	ReLU	SIREN	Snake
ppppp
Figure 4: Generalization outside of the training region (red rectangle) in the state space of an inverted pendu-
lum model With different hypersolver activation functions. Architectures containing activation functions With
periodic components achieve better extrapolation properties compared to the others.
laudiseR naeM
45
4.3	Active Error Minimization
The goal of active error minimization is to ac-
tively reduce the highest losses in terms of the
control inputs, i.e., to obtain w* as the solution
to a minmax problem:
w* = arg min max `(t, x, u)
ω	u∈U
(9)
Similarly to stochastic exploration, We create
distribution ξ(x, u) With support in X × U and
perform Monte Carlo sampling of n batches
{(xi, ui)}, from ξ. Then, losses are computed
pair-Wisely for each state xj , j = 0, . . . , n - 1
With each control input uk, k = 0, . . . , n - 1.
We then take the first n controllers {ui00 } yield-
ing the maximum loss for each state. The
loss is recalculated using these controller values
With their respective states and SGD updates
to hypersolver parameters are performed. Fig-
ure 3 shoWs a comparison of the pre-training
techniques (further experimental details in Ap-
pendix C.2). The propagated error on trajecto-
ries for the hypersolver pre-trained via stochas-
tic exploration is loWer on average With ran-
dom control inputs compared With the one pre-
trained With active error minimization. The
latter accumulates loWer error for controllers
yielding high residuals.
----Stochastic Exploration
---- Active Error Minimization
----Midpoint
Figure 3: Mean Absolute Error (MAE) along tra-
jectories With different pre-training techniques on the
spring-mass system of (17). [Top] Stochastic explo-
ration performs better on average i.e. u ∈ [-100, 100].
[Bottom] Active error minimization achieves better re-
sults in limit situations as in the case of a bang-bang
controller i.e. u ∈ {-100, 100}, in Which controllers
yielding the highest residuals have been minimized.
Different exploration strategies may be used depending on the down-stream control task.
4.4	Generalization Properties of Different Architectures
We have assumed the state and controller spaces to be bounded and that training be performed
by sampling for their known distributions. While this is sufficient for optimal control problems
given a priori known bounds, we also investigate how the system generalizes to unseen states and
control input values. In particular, we found that activation functions have an impact on the end
result of generalization beyond training boundaries. We take into consideration two commonly
x -x
used activation functions, Tanh : X → [x+e-x and ReLU : X → max(0, x), along with network
architectures which employ activation functions containing periodic components: SIREN : x →
Sin (WX + b) (Sitzmann et al., 2020) and Snake : X → X + 1 sin2 (ax) (Ziyin et al., 2020). We
train hypersolver models with the different activation functions for the inverted pendulum model
of (18) with common experimental settings (see Appendix C.3). Figure 4 shows generalization
5
Published as a conference paper at ICLR 2022
outside the training states (see Figure 9 in Appendix C.3 for generalization of controllers and step
sizes). We notice that while Tanh and ReLU perform well on the training set of interest, performance
degrades rapidly outside of it. On the other one hand, SIREN and Snake manage to extrapolate the
periodicity of the residual distribution even outside of the training region, thus providing further
empirical evidence of the universal extrapolation theorem (Ziyin et al., 2020, Theorem 3).
Activation function choice plays an important role in HyPersolver performance and generalization.
4.5	MULTI-STAGE HYPERSOLVERS
We have so far considered the case in which the vector field (1) fully characterizes the system dy-
namics. However, if the model does not completely describe the actual system dynamics, first-order
errors are introduced. We propose Multi-Stage Hypersolvers to correct these errors: an
additional term is introduced in order to correct the inaccurate dynamics f . The resulting procedure
is a modified version of (4) in which the base solver ψ (tk, xk, uk) does not iterate over the modeled
vector field f but over its corrected version f? :
f (tk , xk, uk) = f (tk , xk, uk) + hw (tk, xk, uk)	(10)
'------{z------} '-----------------}
partial dynamics	inner stage
where hw is a function with universal approximation properties. While the inner stage hw is a first-
order error approximator, the outer stage gω further reduces errors approximating the p-th order
residuals:
xk+1
xk + eψe tk, xk, Uk, f (tk, xk, Uk) I + e，+ gω (tk, xk, Uk )
'---------{----------}
corrected dynamics
'----------{----------}
outer stage
(11)
∖
We note that f? is continuously adjusted due to the optimization of hw . For this reason, it is not
possible to derive the analytical expression of the residuals to train the stages with the residual fitting
loss function (6). Instead, both stages can be optimized at the same time via backpropagation calcu-
lated on one-step trajectory fitting loss (7) which does not require explicit residuals calculation.
5	Experiments
We introduce the experimental results divided for each system into hypersolver pre-training and sub-
sequent optimal control. We use as accurate adaptive step-size solvers the Dormand/Prince method
dopri5 (Dormand & Prince, 1980) and an improved version of it by Tsitouras tsit5 (Tsitouras,
2011) for training the hypersolvers and to test the control performance at runtime.
5.1	Direct optimal control of a Pendulum
Hypersolver pre-training We consider the inverted pendulum model with a torsional spring
described in (18). We select ξ(x, U) as a uniform distribution with support in X × U where
X = [-2π, 2π] × [-2π, 2π] and U = [-5, 5] to guarantee sufficient exploration of the state-
controller space. Nominal solutions are calculated using tsit5 with absolute and relative tolerances
set to 10-5. We train the hypersolver on local residuals via stochastic exploration using the Adam
optimizer with learning rate of 3 × 10-4 for 3 × 105 epochs.
Direct optimal control The goal is to stabilize the inverted pendulum in the vertical position
x? = [0, 0]. We choose t ∈ [0, 3] and a step size e = 0.2 s for the experiment. The control
input is assumed continuously time-varying. The neural controller is optimized via SGD with Adam
with learning rate of 3 × 10-3 for 1000 epochs. Figure 5 shows nominal controlled trajectories
of HyperEuler and other baseline fixed-step size solvers. Trajectories obtained with the controller
optimized with HyperEuler reach final positions q = (1.6 ± 17.6) × 10-2 while Midpoint and RK4
ones q = (-0.6 ± 12.7) × 10-2 and q = (1.1 ± 12.8) × 10-2 respectively. On the other hand,
the controller optimized with the Euler solver fails to control some trajectories obtaining a final
6
Published as a conference paper at ICLR 2022
q = (6.6 ± 19.4) × 10-1. HyperEuler considerably improved on the Euler baseline While requiring
only 1.2% more Floating Point Operations (FLOPs) and 49.5% less compared to Midpoint. Further
details are available in Appendix C.3.
Figure 5: Direct optimal control of the inverted pendulum in phase space. While the controller optimized With
the Euler solver fails to control the system for some trajectories, the one obtained With HyperEuler improves
the performance While introducing a minimal overhead With results comparable to higher-order solvers.
5.2	Model Predictive Control of a Cart-Pole System
Hypersolver pre-training We consider the partial dynamics of the cart-pole system of (19) with
Wrong parameters for the frictions betWeen cart and track as Well as the one betWeen cart and pole.
We employ the multi-stage hypersolver approach to correct the first-order error in the vector field
as Well as base solver residual. We select ξ(x, u) as a uniform distribution With support in X × U
Where X = [-2π, 2π] × [-2π, 2π] × [-2π, 2π] × [-2π, 2π] andU = [-10, 10]. Nominal solutions
are calculated on the accurate system using RungeKutta 4 instead of adaptive-step solvers due
faster training times. We train our multi-stage Hypersolver (i.e. a multi-stage hypersolver With
the second-order Midpoint as base solver With the partial dynamics) on nominal trajectories of the
accurate system via stochastic exploration using the Adam optimizer for 5 × 104 epochs, Where We
set the learning rate to 10-2 for the first 3 × 104 epochs, then decrease it to 10-3 for 104 epochs and
to 10-4 for the last 104.
Model predictive control The goal is to stabilize the cart-pole system in the vertical position
around the origin, e.g. x? = [0, 0, 0, 0]. We choose t ∈ [0, 3] and a step size = 0.05 s for
the experiment. The control input is assumed piece-Wise constant during MPC sampling times.
The receding horizon is chosen as 1 s. The neural controller is optimized via SGD With Adam
With learning rate of 3 × 10-3 for a maximum of 200 iterations at each sampling time. Figure 6
shoWs nominal controlled trajectories of multi-stage Hypersolver and other baseline solvers. The
Midpoint solver on the inaccurate model fails to stabilize the system at the origin position x =
(39.7 ± 97.7) cm, While multi-stage Hypersolver manages to stabilize the cart-pole system and
improve on final positions x = (7.8 ± 3.0) cm. Further details are available in Appendix C.4.
0
]m[x
0123
Time [s]
兀"_2 O
]dar[ θ
0123
Time [s]
f N 一~nd∙aIoauou
0
0123
Time [s]
00
10 5
tupni ygrene.
0123
Time [s]
Multistage HyPerSoIVer (inaccurate model) ----- Midpoint (inaccurate model) ------ Euler (nominal model) ------ Midpoint (nominal model)
Figure 6: Model Predictive Control With constrained inputs on the cart-pole model. MPC With the Midpoint
solver iterating on the partial dynamic model successfully swings up the pole but fails to reach the target
position. Multi-stage Hypersolver With the Midpoint base solver has knoWledge restricted to the inaccurate
system, yet it manages to obtain a similar control performance compared to controllers With access to the
nominal dynamics While also needing less control effort and absolute energy infloW compared to its base solver.
Multi-stage Hypersolvers can correct first-order errors on dynamic models and base solver residuals.
7
Published as a conference paper at ICLR 2022
5.3	Model Predictive Control of a Quadcopter
Hypersolver pre-training We consider the quadcopter model of (20). We select ξ(x, u) as a
uniform distribution with support in X × U where X is chosen as a distribution of possible visited
states and each of the four motors i ∈ [0, 3] has control inputs ui ∈ [0, 2.17] × 105 rpm. Nominal
solutions are calculated on the accurate system using dopri5 with relative and absolute tolerances
set to 10-7 and 10-9 respectively. We train HyperEuler on local residuals via stochastic exploration
using the Adam optimizer with learning rate of 10-3 for 105 epochs.
Model predictive control The control goal is to reach a final positions [x, y, z]? = [8, 8, 8] m.
We choose t ∈ [0, 3] and a step size e = 0.02 s for the experiment. The control input is assumed
piece-wise constant during MPC sampling times. The receding horizon is chosen as 0.5 s. The
neural controller is optimized via SGD with Adam with learning rate of 10-2 for 20 iterations at each
sampling time. Figure 7 shows local residual distribution and control performance on the quadcopter
over 30 experiments starting at random initial conditions which are kept common for the different
ODE solvers. HyperEuler requires a single function evaluation per step as for the Euler solver
compared to two function evaluations per step for Midpoint and four for RK4. Controlled trajectories
optimized with Euler, Midpoint and RK4 collect an error on final positions of (1.09 ± 0.37) m,
(0.71 ± 0.17) m, (0.70 ± 0.19) m respectively while HyperEuler achieves the lowest terminal error
value of (0.66 ± 0.24) m. Additional experimental details are available in Appendix C.5.
210
000
R laudiseR naeM
10-5
HyperEuler Euler Midpoint RK4
HyperEuler	Midpoint	▲	Initial Position
EUler	----- RK4	Ir	Target
2 × 1O0∙
100-
6 × 10-1∙
4 × 10-1-
3 × 10-1∙
HyperEuler Euler Midpoint RK4
° °
8 ⅞τ-
。ΛMT1
.IOJJm uo≈--od-u≡
Figure 7: [Left] Local residual distribution for the quadcopter model for = 0.02 s. [Center] Trajectories
of controlled quadcopters with MPC whose receding horizon controller is optimized by solving the ODE with
different methods. [Right] Final positions error distribution. The proposed approach with HyperEuler achieves
lower average error compared to other baseline solvers while requiring a low overhead compared to higher-
order solvers due to a smaller number of dynamics function evaluations.
5.4	B oundary Control of a Timoshenko Beam
Hypersolver pre-training We consider the finite element discretization of the Timoshenko beam
of (22). We create ξ(x, u) as a distribution with support in X × U which is generated at training
time via random walks from known boundary conditions in order to guarantee both physical feasi-
bility and sufficient exploration of the state-controller space (see Appendix C.6 for further details).
Nominal solutions are calculated using tsit5 with absolute and relative tolerances set to 10-5. We
train the hypersolver on local residuals via stochastic exploration using the Adam optimizer for 105
epochs, where we set the learning rate to 10-3 for the first 8 × 104 epochs, then decrease it to 10-4
for 104 epochs and to 10-5 for the last 104.
Boundary direct optimal control The task is to stabilize the beam in the straight position, i.e.
each of its elements i have velocities vti, vri and displacements σti, σri equal to 0. We choose t ∈ [0, 3]
and step size e = 5 ms for the experiment. The control input is assumed continuously time-
varying. The neural controller is optimized via SGD with Adam with learning rate of 10-3 for 1000
epochs. Figure 8 shows nominal controlled trajectories for HyperEuler and other baseline fixed-
step size solvers. Control policies trained with Euler and Midpoint obtain averaged final states of
(-2.8 ± 4.2) × 10-1 and (-0.04 ± 4.6) × 10-1 thus failing to stabilize the beam, while HyperEuler
and RK4 obtain (-0.6 ± 4.9) × 10-3 and (-0.5 ± 3.3) × 10-3 respectively. HyperEuler considerably
improves on both the Euler and Midpoint baselines obtaining a very similar performance to RK4,
while requiring 72.9% less FLOPs; the mean runtime per training iteration was cut from 8.24 s for
RK4 to just 2.53 s for HyperEuler. Further details on this experiment are available in Appendix C.6.
8
Published as a conference paper at ICLR 2022
HyperEuler
1勺
H
0M
-1
1.0
Lt	2	3 0.0	' x
Euler
1勺
0M
-1
1.0
x
t 2	3 0.0
Midpoint
1勺
H
0¥
-1
1.0
Lt	2	3 0.0 X
RK4
1 G
0W
-1
1.0
Lt	2	3 0.0	' x
1κ'
02
-1
1.0
x
t 2	3 0.0
不、
1 二
0^
-1
1.0
Lt	2	3 0.0 x
1勺
0f
-1
1.0
Lt	2	3 0.0 x
Figure 8: Displacement variables σt and σ, of the discretized Timoshenko beam as a function of position X of
the finite elements and time t. The controller optimized with HyperEuler manages to stabilize the beam while
the baseline solvers Euler and Midpoint fail, yet requiring less than a third in terms of runtime compared to
RK4.
Hypersolvers are even more impactful in complex high-dimensional controlled systems.
6	Related Work
This work is rooted in the broader literature on surrogate methods for speeding up simulations and
solutions of dynamical systems (Grzeszczuk et al., 1998; James & Fatahalian, 2003; Gorissen et al.,
2010). Differently from these approaches, we investigate a methodology to enable faster solution
during a downstream, online optimization problem involving a potential mismatch compared to data
seen during pre-training. We achieve this through the application of the hypersolver (Poli et al.,
2020a) paradigm. Modeling mismatches between approximate and nominal models is explored in
(Saveriano et al., 2017) where residual dynamics are learned efficiently along with the control policy
while (Fisac et al., 2018; Taylor et al., 2019) model systems uncertainties in the context of safety-
critical control. In contrast to previous work, we model uncertainties with the proposed multi-stage
hypersolver approach by closely interacting with the underlying ODE base solvers and their residu-
als to improve solution accuracy. The synergy between machine learning and optimal control con-
tinues a long line of research on introducing neural networks in optimal control (Hunt et al., 1992),
applied to modeling (Lin & Cunningham, 1995), identification (Chu et al., 1990) or parametrization
of the controller itself (Lin et al., 1991). Existing surrogate methods for systems (Grzeszczuk et al.,
1998; James & Fatahalian, 2003) pay a computational cost upfront to accelerate downstream sim-
ulation. However, ensuring transfer from offline optimization to the online setting is still an open
problem. In our approach, we investigate several strategies for an accurate offline-online transfer
of a given hypersolver, depending on desiderata on its performance in terms of average residuals
and error propagation on the online application. Beyond hypersolvers, our approach further lever-
ages the latest advances in hardware and machine learning software (Paszke et al., 2019) by solving
thousands of ODEs in parallel on graphics processing units (GPUs).
7	Conclusion
We presented a novel method for obtaining fast and accurate control policies. Hypersolver mod-
els were firstly pre-trained on distributions of states and controllers to approximate higher-order
residuals of base fixed-step ODE solvers. The obtained models were then employed to improve the
accuracy of trajectory solutions over which control policies were optimized. We verified that our
method shows consistent improvements in the accuracy of ODE solutions and thus on the quality
of control policies optimized through numerical solutions of the system. We envision the proposed
approach to benefit the control field and robotics in both simulated and potentially real-world envi-
ronments by efficiently solving high-dimensional space-continuous problems.
9
Published as a conference paper at ICLR 2022
Code of Ethics
We acknowledge that all the authors of this work have read and commit to adhering to the ICLR
Code of Ethics.
Reproducibility S tatement
We share the code used in this paper and make it publicly available on Github1. The following ap-
pendix also supplements the main text by providing additional clarifications. In particular, Appendix
A provides further details on the considered hypersolver models. We provide additional information
on optimal control policy in Appendix B while in Appendix C we provide details on on the system
dynamics, architectures and other experimental details. Additional explanations are also provided
as comments in the shared code implementation.
References
Martin Alnæs, Jan Blechta, Johan Hake, August Johansson, Benjamin KehleL Anders Logg, Chris
Richardson, Johannes Ring, Marie E Rognes, and Garth N Wells. The fenics project version 1.5.
Archive of Numerical Software, 3(100), 2015.
Mato Baotic, Francesco Borrelli, Alberto Bemporad, and Manfred Morari. Efficient on-line compu-
tation of constrained optimal control. SIAM Journal on Control and Optimization, 47(5):2470—
2489, 2008.
Greg Brockman, Vicki Cheung, Ludwig Pettersson, Jonas Schneider, John Schulman, Jie Tang, and
Wojciech Zaremba. Openai gym, 2016.
John Butcher. Numerical methods for differential equations and applications.
http://www.math.auckland.ac.nz/Research/Reports/view.php?id=370, 22, 12 1997.
Ricky T. Q. Chen, Yulia Rubanova, Jesse Bettencourt, and David Duvenaud. Neural ordinary dif-
ferential equations, 2019.
S Reynold Chu, Rahmat Shoureshi, and Manoel Tenorio. Neural networks for system identification.
IEEE Control systems magazine, 10(3):31-35, 1990.
J. R. Dormand and P. J. Prince. A family of embedded runge-kutta formulae. Journal of Computa-
tional and Applied Mathematics, 6:19-26, 1980.
Jaime F. Fisac, Anayo K. Akametalu, Melanie N. Zeilinger, Shahab Kaynama, Jeremy Gillula, and
Claire J. Tomlin. A general safety framework for learning-based control in uncertain robotic
systems, 2018.
RazVan Florian. Correct equations for the dynamics of the cart-pole system. 08 2005.
C. E. Garcia, D. M. Prett, and M. Morari. Model predictive control: Theory and practice - a survey.
Autom., 25:335-348, 1989.
Dirk Gorissen, IVo Couckuyt, Piet Demeester, Tom Dhaene, and Karel Crombecq. A surrogate
modeling and adaptiVe sampling toolbox for computer based design. The Journal of Machine
Learning Research, 11:2051-2055, 2010.
Radek Grzeszczuk, Demetri Terzopoulos, and Geoffrey Hinton. Neuroanimator: Fast neural net-
work emulation and control of physics-based models. In Proceedings of the 25th annual confer-
ence on Computer graphics and interactive techniques, pp. 9-20, 1998.
K.J. Hunt, D. Sbarbaro, R. Zbikowski, and P.J. Gawthrop. Neural networks for control sys-
tems—a surVey. Automatica, 28(6):1083-1112, 1992. ISSN 0005-1098. doi: https://doi.org/
10.1016/0005-1098(92)90053-I. URL https://www.sciencedirect.com/science/
article/pii/000510989290053I.
1Supporting reproducibility code is at
https : //github.com/DiffEqML/diffeqml - research/tree/master/hypersolvers - control
10
Published as a conference paper at ICLR 2022
Doug L James and Kayvon Fatahalian. Precomputing interactive dynamic deformable scenes. ACM
Transactions on Graphics (TOG), 22(3):879-887, 2003.
Diederik P. Kingma and Jimmy Ba. Adam: A method for stochastic optimization, 2017.
Frank L Lewis, Draguna Vrabie, and Vassilis L Syrmos. Optimal control. John Wiley & Sons, 2012.
Chin-Teng Lin, C. S. George Lee, et al. Neural-network-based fuzzy logic control and decision
system. IEEE Transactions on computers, 40(12):1320-1336, 1991.
Yinghua Lin and George A Cunningham. A new approach to fuzzy-neural system modeling. IEEE
Transactions on Fuzzy systems, 3(2):190-198, 1995.
Alessandro Macchelli and Claudio Melchiorri. Modeling and control of the timoshenko beam. the
distributed port hamiltonian approach. SIAM J. Control. Optim., 43:743-767, 2004.
Stefano Massaroli, Michael Poli, Sho Sonoda, Taji Suzuki, Jinkyoo Park, Atsushi Yamashita, and
Hajime Asama. Differentiable multiple shooting layers. CoRR, abs/2106.03885, 2021. URL
https://arxiv.org/abs/2106.03885.
David Q Mayne and Hannah Michalska. Receding horizon control of nonlinear systems. In Pro-
ceedings of the 27th IEEE Conference on Decision and Control, pp. 464-465. IEEE, 1988.
Jacopo Panerati, Hehui Zheng, Siqi Zhou, James Xu, Amanda Prorok, and Angela P. Schoellig.
Learning to fly - a gym environment with pybullet physics for reinforcement learning of multi-
agent quadcopter control. CoRR, abs/2103.02142, 2021. URL https://arxiv.org/abs/
2103.02142.
Adam Paszke, Sam Gross, Francisco Massa, Adam Lerer, James Bradbury, Gregory Chanan, Trevor
Killeen, Zeming Lin, Natalia Gimelshein, Luca Antiga, et al. Pytorch: An imperative style, high-
performance deep learning library. arXiv preprint arXiv:1912.01703, 2019.
Michael Poli, Stefano Massaroli, Atsushi Yamashita, Hajime Asama, and Jinkyoo Park. Hyper-
solvers: Toward fast continuous-depth models. In H. Larochelle, M. Ranzato, R. Hadsell, M. F.
Balcan, and H. Lin (eds.), Advances in Neural Information Processing Systems, volume 33, pp.
21105-21117. Curran Associates, Inc., 2020a. URL https://proceedings.neurips.
cc/paper/2020/file/f1686b4badcf28d33ed632036c7ab0b8-Paper.pdf.
Michael Poli, Stefano Massaroli, Atsushi Yamashita, Hajime Asama, and Jinkyoo Park. Torchdyn:
A neural differential equations library, 2020b.
Radoslaw Pytlak. Numerical methods for optimal control problems with state constraints. Springer,
2006.
Anil V Rao. A survey of numerical methods for optimal control. Advances in the Astronautical
Sciences, 135(1):497-528, 2009.
Christian Robert and George Casella. Monte Carlo statistical methods. Springer Science & Business
Media, 2013.
I Michael Ross and Fariba Fahroo. Issues in the real-time computation of optimal control. Mathe-
matical and computer modelling, 43(9-10):1172-1188, 2006.
Matteo Saveriano, Yuchao Yin, Pietro Falco, and Dongheui Lee. Data-efficient control policy search
using residual dynamics learning. In 2017 IEEE/RSJ International Conference on Intelligent
Robots and Systems (IROS), pp. 4709-4715, 2017. doi: 10.1109/IROS.2017.8206343.
Vincent Sitzmann, Julien N. P. Martel, Alexander W. Bergman, David B. Lindell, and Gordon Wet-
zstein. Implicit neural representations with periodic activation functions, 2020.
Andrew Taylor, Andrew Singletary, Yisong Yue, and Aaron Ames. Learning for safety-critical
control with control barrier functions, 2019.
11
Published as a conference paper at ICLR 2022
Ch. Tsitouras. RUnge-kutta pairs of order 5(4) satisfying only the first column simplifying assump-
tion. Computers Mathematics with Applications, 62(2):770-775, 201LISSN 0898-1221. doi:
https://doi.org/10.1016/j.camwa.2011.06.002. URL https://www.sciencedirect.com/
science/article/pii/S0898122111004706.
S Vadali, Hanspeter Schaub, and K Alfriend. Initial conditions and fuel-optimal control for forma-
tion flying of satellites. In Guidance, Navigation, and Control Conference and Exhibit, pp. 4265,
1999.
Yue J Zhang, Andreas A Malikopoulos, and Christos G Cassandras. Optimal control and coordina-
tion of connected and automated vehicles at urban traffic intersections. In 2016 American Control
Conference (ACC), pp. 6227-6232. IEEE, 2016.
Liu Ziyin, Tilman Hartwig, and Masahito Ueda. Neural networks fail to learn periodic functions
and how to fix it, 2020.
12
Published as a conference paper at ICLR 2022
A Additional Hypersolver Material
A. 1 Explicit HyperEuler Formulation
Our analysis in the experiments takes into consideration the hypersolved version of the Euler
scheme, namely HyperEuler. Since EUler is a first-order method, it requires the least number
of function evaluations (NFE) of the vector field f in (1) and yields a second order local trun-
cation error ek :=	2Rk 2. This error is larger than other fixed-step solvers and thus has
the most room for potential improvements. The base solver scheme ψ of (4) can be written as
ψ (tk, xk, uk) = f (tk, xk, uk), which is approximating the next state by adding an evaluation of
the vector field multiplied by the step size . We can write the HyperEuler update explicitly as
xk+1 = xk + f (tk , xk , uk) + gw (tk , xk , uk )	(12)
while we write its residual as
R(x(tk),u(tk))) = F (Φ(x(tk),tk,tk+ι) — x(tk) — f (tk,xk,uk))	(13)
2
A.2 Hypers olvers for Time–invariant Systems
A time-invariant system with time-invariant controller can be described as following
x(t) = f (x(t),u(x(t)))
x(0) = x0
(14)
in which f and u do not explicitly depend on time. The models considered in the experiments satisfy
this property.
B Control Policy Details
B.1 Optimal Control Cost Function
The general form of the integral cost functional can be written as follows
J (x(t), u(t)) = [x> (tf) — x?]P[x(tf) —
x?] +
tf
t0
(t)x?]Q[x(t) —
x?] + u>(t)Ru(t) dt
(15)
where matrix P is a penalty on deviations from the target x? of the last states, Q penalizes all
deviations from the target of intermediate states while R is a regulator for the control inputs. Eval-
uation of (15) usually requires numerical solvers such as the proposed hypersolvers of this work.
Discretizations of the cost functional are also called cost function in the literature.
B.2 Model Predictive Control Formulation
The following problem is solved online and iteratively until the end of the time span
min
uk
subject to
T-1
J (xk, uk)
k=0
x(t) = f (t,x(t),u(t))
x(0) = x0
t∈T
(16)
where J is a cost function andT ∈ T is the receding horizon over which predicted future trajectories
are optimized.
B.3 Neural Optimal Control
We parametrize the control policy of problem (2) as uθ : t, x 7→ uθ (t, x) where θ is a finite set of
free parameters. Specifically, we consider the case of neural optimal control in which controller uθ
is a multi-layer perceptron. The optimal control task is to minimize the cost function J described in
(15) and we do so by optimizing the parameters θ via SGD; in particular, we use the Adam (Kingma
& Ba, 2017) optimizer for all the experiments.
13
Published as a conference paper at ICLR 2022
C Experimental Details
In this section we include additional modeling and experimental details divided into the different
dynamical systems.
C.1 Hypersolver Network Architecture
We design the hypersolver networks gw as feed-forward neural networks. Table 1 summarizes the
parameters used for the considered controlled systems, where Activation denotes the activation func-
tions, i.e. SoftPlus: X → log(1 + ex), Tanh: X → 器+1一x and Snake : X → X + a sin2(ax)
(Ziyin et al., 2020). We also use the vector field f as an input of the hypersolver, which does not
Table 1: Hyper-parameters for the hypersolver networks in the experiments.
	Spring-Mass	Inverted Pendulum2	Cart-Pole3	Quadcopter	Timoshenko Beam
Input Layer	5	5	9	28	322
Hidden Layer 1	32	32	32	64	256
Activation 1	Softplus	Softplus	Snake	Softplus	Snake
Hidden Layer 2	32	32	32	64	256
Activation 2	Tanh	Tanh	Snake	Softplus	Snake
Output Layer	2	2	4	12	160
require a further evaluation since it is pre-evaluated at runtime by the base solver ψ. We empha-
size that the size of the network should depend on the application: a too-large neural network may
require more computations than just increasing the numerical solver’s order: Pareto optimality of hy-
persolvers also depends on their complexity. Keeping their neural network small enough guarantees
that evaluating the hypersolvers is cheaper than resorting to more complex numerical routines.
C.2 Spring-mass System
System Dynamics The spring-mass system considered is described in the Hamiltonian formula-
tion by
q = 0
P —k
1/m
0
q
p
+
(17)
where m = 1 [Kg] and k = 0.5 [N/m].
Pre-training methods comparison We select ξ(X, u) as a uniform distribution with support in
X × U where X = [—20, 20] × [—20, 20] while U = [—100, 100]. Nominal solutions are calculated
on the accurate system using dopri5 with relative and absolute tolerances set to 10-7 and 10-9
respectively. We train two separate HyperEuler models with different training methods on local
residual for step size = 0.03 s: stochastic exploration and active error minimization. The optimizer
used is Adam with learning rate of 10-3 for 104 epochs.
Hypersolvers with different step sizes We select ξ(X, u) as a uniform distribution with support
in X × U where X = [—5, 5] × [—5, 5] while U = [—20, 20]. Nominal solutions are calculated
on the accurate system using dopri5 with relative and absolute tolerances set to 10-7 and 10-9
respectively. We train separate HyperEuler models with stochastic exploration with different step
sizes . The optimizer used is Adam with learning rate of 10-3 for 104 epochs.
2This architecture refers to the optimal control experiment. Details on hypersolver models for the general-
ization experiment on the inverted pendulum are available in Appendix C.3.
3In the multi-stage hypersolver experiment we consider both the inner stage hw and the outer stage gω with
the same architecture and jointly trained (more information and ablation study in Appendix C.4).
14
Published as a conference paper at ICLR 2022
---- Euler ----------Tanh [HE] ----------Snake [HE]
----Midpoint --------ReLU [HE] ----------Training Region
----RK4 -------------SIREN [HE]
---- EUler ----------Tanh [HE] ----------Snake [HE]
---- Midpoint -------ReLU [HE] ----------Training Step
----RK4 -------------SIREN [HE]
Figure 9:	Generalization with different hypersolver activation functions (HyperEuler models are marked with
”HE”) on the inverted pendulum. [Left] Generalization for the controller space outside of the training region
(red area). The architecture with Snake can to generalize better compared to other hypersolvers. [Right]
Generalization for different time steps outside of the training step = 0.1 s (red line). HyperEuler is able to
improve the baseline Euler solver performance even for unseen .
C.3 Inverted Pendulum
System Dynamics
via the following:
We model the inverted pendulum with elastic joint with Hamiltonian dynamics
q _ 0	1/m
P = -k —β∕m
q-	0	+0u
p mgl sin q 1 u
(18)
where m = 1 [Kg], k = 0.5 [N/ rad], r = 1 [m], β = 0.01 [Ns/ rad], g = 9.81 [m/s2].
Pre-training for the generalization study We perform sampling via stochastic exploration from
the uniform distribution ξ(x, u) with support in X × U with X = [-2π, 2π] × [-2π, 2π] and
U = [-10, 10] for the different architectures. We choose as a common time step = 0.1 s; the
networks are trained for 100000 epochs with the Adam optimizer and learning rate of 10-3. The
network architectures share the same parameters as the inverted pendulum ones in 1, while the
activation functions are substituted by the ones in Figure 4. The SIREN architecture is chosen with
2 hidden layers of size 64. Figure 9 provides an additional empirical results on generalization
properties across controller values and step sizes: we notice how Snake can generalize to unseen
control values better compared to other hypersolvers.
Additional visualization Figure 10 provides an additional visualization of the inverted pendulum
controlled trajectories from Figure 5 with positions q and momenta p over time.
Euler
Midpoint
Figure 10:	Controlled trajectories of the inverted pendulum with controllers optimized via different solvers.
C.4 Cart-Pole
System Dynamics We consider a continuous version of a cart-pole system additionally taking into
account the full dynamic model in Florian (2005). This formulation considers the friction coefficient
15
Published as a conference paper at ICLR 2022
between the track and the cart μc inducing a force opposing the linear motion as well as the friction
generated between the cart and the pole μp, whose generated torque opposes the angular motion.
.
The full cart-pole model is described by the four variables χ,X ,θ,θ and the accelerations update is
as following
Nc = (mc + mp) g — mpl (θ Sin θ + θ2 cos θ)
..g sin θ + cos θ h -u-mPlθ2(Sim+m：gn(Ncx) cos (>θ + μcg Sgn(NCX)i —缶
l h3- mp+≡θ (CoS θ - μc Sgn(NCxH	(19)
U + mpl (θ2 sin θ — θ cos θ) — μcN
x =-----------------------------------
mc + mp
where mc = 1 [K g], mp = 0.1 [K g], l = 0.5 [m] and g = 9.81 [m/s2]. Nc represents the
normal force acting on the cart. For simulation purposes, we consider its sign to be always positive
when evaluating the sign (sgn) function as the cart should normally not jump off the track. Setting
μc, μp to 0 results in the same dynamic model used in the OPenAI Gym (Brockman et al., 2016)
implementation.
Figure 11: One step Mean Absolute Error (MAE) for multi-stage hypersolvers and different solvers as well
as correction schemes in the ablation study. Multi-stage Hypersolver (MS) with joint training and Midpoint
base solver iterating on an inaccurate vector field agnostic of friction forces outperforms the Midpoint solver
with full knowledge of the vector field.
Multistage training strategies We study two different training strategies for the inner and outer
networks hw and gω in (11). We first consider a joint training strategy in which both stages are
trained at the same time via stochastic exploration. Secondly, we do a separated training in which
only the inner stage network hw is trained first and then the outer stage network gω is added and
only its parameters are trained in a finetuning process. We find that, as shown in Figure 11, joint
training yields slightly better results. A further advantage of jointly training both stages is that only
a single training procedure is required.
Ablation study We consider the same model as our Multi-stage Hypersolver with base Midpoint
solver but no first-stage hw , which corresponds to learning the residual dynamics only, and we train
this model with stochastic exploration. We show in Figure 11 that while the residual dynamics model
can improve the one-step error compared to the base solver on the inaccurate dynamics, it performs
worse the Multi-stage Hypersolver scheme. We additionally study the contribution of each stage in
the prediction error improvements by separately zeroing out the contributions of the inner and outer
stage. While iterating over the inner stage only improves on the base-solver error, including the
outer stage further contributes in improving the error. We notice how the excluding the inner-stage
yields higher errors: this may be due to the fact that the inner-stage specializes in correcting the
first-order vector field inaccuracies while the outer-stage corrects the one step base solver residual.
Additional experimental details For the Multi-stage Hypersolver control experiment, we pre-
train both inner and outer stage networks hw and gω in (11) at the same time using stochastic
exploration. The base solver is chosen as the second-order Midpoint iterating on the partial dy-
namics (19) with μc, μp set to 0. The nominal dynamics considers non-null friction forces: We set
the cart friction coefficient to μc = 0.1 and the one of the pole to μ? = 0.03. We note how the
friction coefficients make the vector field (19) non-smooth: simulation through adaptive-step size
16
Published as a conference paper at ICLR 2022
solvers as tsit5 results experimentally time-consuming, hence We resort to RK4 for training the
hypersolver networks. Nonetheless, as shown in the error propagation of Figure 12, this does not
degrade the performance of the trained multi-stage hypersolver scheme. All neural netWorks in the
experiements, including the ablation study, are trained With the Adam optimizer for 5 × 104 epochs,
Where We set the learning rate to 10-2 for the first 3 × 104 epochs, then decrease it to 10-3 for 104
epochs and to 10-4 for the last 104.
C.5 Quadcopter
System Dynamics The quadcopter model is a suitably modified version of the explicit dynamics
update in (Panerati et al., 2021) for batched training in PyTorch. The following accelerations update
describes the dynamic model
X = (R ∙ [0, 0, kFP3=0ω2] - [0, 0, mg]) m-1
Ψ = JT Tτ(l, kF,kτ, [ω0,ω2,ω2,ω3]) - ψ X Jψ))
(20)
mWhere x = [x, y, z] corresponds to the drone positions and ψ = [φ, θ, ψ] to its angular positions;
R and J are its rotation and inertial matrices respectively, T(∙) is a function calculating the torques
induced by the motor speeds ωi, While arm length l, mass m, gravity acceleration constant g along
With kF and kT are scalar variables describing the quadcopter’s physical properties.
Angular Position	Angular Velocity
Position
2- 3-
10- -10
EPAMS
4
-10
Time [s]
Velocity
2
-10
EPAMS
EPAMS
,J
-10
EPAMS
1
10-
Time [s]
1
Time [s]	1	0	Time [s]
--- Multistage HyPerSoIVer (inaccurate model) - Midpoint (inaccurate model) - Euler (nominal model) - Midpoint (nominal model)
Figure 12: Symmetric Mean Absolute Percentage Error (SMAPE) propagation along controlled trajectories
of the cart-pole system. The Multi-stage Hypersolver With knoWledge limited to the inaccurate model manages
to outperform the Euler solver iterating on the accurate dynamics in terms of positions and angular positions.
C.6 Timoshenko Beam
System Dynamics We consider as a system from the theory of continuum dynamics the Tim-
oshenko beam With no dissipation described in (Macchelli & Melchiorri, 2004; Massaroli et al.,
2021). The system can be described in the coenergy formulation by the folloWing partial differen-
tial equation (PDE)
0∂x0
00∂x1
000∂
一
=
∖∖ //
vtvrσrσ
/n.
a所
-
I I I e
000C
00Cb
0Iρ0
A00
0
0
vt
Vr
σr
σt
(21)
Where ρ is the mass density, A is the cross section area, Iρ is the rotational inertia, Cs and Cb are the
shear and bending compliance; the discretized state variables vt , vr represent the translational and
rotational velocities respectively While σt , σr denote the translational and rotational displacements.
cantilever beam. In order to discretize the problem, We implement a softWare routine based on the
fenics (Alnæs et al., 2015) open-source software suite to obtain the finite-elements discretization
of the Timoshenko PDE of (21) given the number of elements, physical parameters of the model and
initial conditions of the beam. We choose a 40 elements discretization of the PDE for a total of 160
dimensions of the discretized state z = [vt, vr , σt , σr]> and we initialize the beam at time t = 0
as z(x, 0) = [sin(πx), sin(3πx), 0, 0]. The system can thus be reduced to the following controlled
17
Published as a conference paper at ICLR 2022
linear system
computed through the fenics routine and boundary controllers u1∂ and u2∂ are the control torque
and the control force applied at the free end of the beam.
Stochastic exploration strategy via random walks We pre-train the hypersolver model via
stochastic exploration of the state-controller space X × U . We restrict the boundary control input
values u = [u1∂, u2∂]> in [-1, 1] × [-1, 1]. As for the state space, naively generating a probability
distribution with box boundaries on each of the 160 dimensions of X would require an inefficient
search over this high-dimensional space: in fact, not every combination is physically feasible due to
the Timoshenko beam’s structure. We solve this problem by propagating batched trajectories with
RK4 from the initial boundary condition z(x, 0) = [sin(πx), sin(3πx), 0, 0] with random control
actions sampled from a uniform distribution with support in [-1, 1] × [-1, 1] applied for a time
tι 〜 U[0.002,1] s. We save the states {z(χ,tι)i} and forward propagate from these states again
by sampling from the controller and time distributions. We repeat the process K times and obtain a
sequence [{z(x, t1)i}, . . . , {z(x, tK)i}] of batched initial conditions characterized by physical fea-
sibility. Finally, we train the hypersolver with stochastic exploration by sampling from the generated
distribution ξ(x, u) on local one-step residuals as described in Section 5.4. This initial state gener-
ation strategy is repeated every 100 epochs for guaranteeing an extensive exploration of all possible
boundary conditions. Figure 13 shows the error propagation over controlled trajectories: the trained
HyperEuler achieves the lowest error among baseline fixed-step solvers.
----EUler -------- HyPerEUler ------- Midpoint -------- RK4
Figure 13: Mean Absolute Error (MAE) propagation on velocities vt , vr and displacements σt , σr for the
finite elements of the discretized Timoshenko beam along controlled trajectories. While solutions from Euler
and Midpoint quickly diverge due to the system’s stiffness, HyperEuler manages not only to contain errors but
even outperform the fourth-order RK4 whilst requiring a fraction of the number of vector field evaluations.
Additional details on the results We report additional details regarding the runtime of the exper-
iments on the Timoshenko Beam. As for the training time, training the hypersolver for 105 epochs
takes around 80 minutes, where the time for each training epoch slightly varies depending on the
length of the sequence of initial condition batches obtained via random walks. As for the averaged
runtime per training epoch during the control policy optimization, HyperEuler takes (2.53 ± 0.09) s
per training iteration, Euler (2.01 ± 0.04) s, Midpoint (4.02 ± 0.08) s and RK4 (8.24 ± 0.14) s.
Experiments were run on the CPU of the machine described in Section C.7.
C.7 Hardware and S oftware
Experiments were carried out on a machine equipped with an AMD Ryzen Threadripper
3960X CPU with 48 threads and two NVIDIA RTX 3090 graphic cards. Software-wise, we
used PyTorch (Paszke et al., 2019) for deep learning and the torchdyn (Poli et al., 2020b) and
18
Published as a conference paper at ICLR 2022
torchdiffeq (Chen et al., 2019) libraries for ODE solvers. We additionally share the code used in
this paper and make it publicly available on Github4.
4Supporting reproducibility code is at
https : //github.com/DiffEqML/diffeqml - research/tree/master/hypersolvers - control
19